<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ì˜ˆìƒ ë“±ê¸‰ì»· ì…ë ¥ (ë“±ê¸‰ì»· ê¸°ì¤€)</title>
    <style>
        :root { --primary-color:#007bff; --border-color:#dee2e6; --bg-color:#f8f9fa; --danger-color: #dc3545; }
        body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; margin:20px; background:#f4f4f4; color:#212529; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
        h1, h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .config-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; align-items: end; /* ë²„íŠ¼ ë†’ì´ ë§ì¶¤ */ }
        label { font-weight: bold; margin-bottom: 8px; display: block; }
        select, input[type="text"] { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); box-sizing: border-box; font-size: 1em; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; }
        th { background: var(--bg-color); font-size: 0.9em; width: 15%; } /* ë“±ê¸‰ ë¼ë²¨ ë„ˆë¹„ ê³ ì • */
        td { background: #fff; }
        td input[type="number"] { width: 80px; padding: 8px; text-align: center; border: 1px solid var(--border-color); border-radius: 3px; }
        .button-container { margin-top: 25px; display: flex; justify-content: flex-end; } /* ì €ì¥ ë²„íŠ¼ ì˜¤ë¥¸ìª½ ì •ë ¬ */
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.95em; }
        .save-btn { background: var(--primary-color); color: #fff; font-size: 1.1em; padding: 12px 25px; }
        .load-btn { background-color: #6c757d; color: white; width: 100%; /* ë²„íŠ¼ ë„ˆë¹„ ë§ì¶¤ */ }
        .message { margin-top: 20px; font-weight: bold; min-height: 20px; font-size: 1.1em; text-align: center; }
        .message.success { color: #28a745; }
        .message.error { color: var(--danger-color); }
        .login-info { text-align: right; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ì˜ˆìƒ ë“±ê¸‰ì»· ì…ë ¥ (ë“±ê¸‰ì»· ê¸°ì¤€)</h1>
    <div class="login-info">
        ë¡œê·¸ì¸ ì§€ì : <span id="branch-name-display">...</span>
    </div>

    <form id="gradecut-form">
        <section class="config-section">
            <div>
                <label for="year-select">í•™ë…„ë„</label>
                <select id="year-select" name="year">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
            <div>
                <label for="exam-type-select">ëª¨í˜•</label>
                <select id="exam-type-select" name="exam_type">
                    <option value="ìˆ˜ëŠ¥">ìˆ˜ëŠ¥</option>
                    <option value="9ì›”">9ì›” ëª¨ì˜í‰ê°€</option>
                    <option value="6ì›”">6ì›” ëª¨ì˜í‰ê°€</option>
                </select>
            </div>
            <div>
                <label for="subject-select">ì„ íƒê³¼ëª©ëª…</label>
                <select id="subject-select" name="subject" required>
                    <option value="">-- ê³¼ëª© ì„ íƒ --</option>
                    </select>
            </div>
            <div>
               <button type="button" id="load-cuts-btn" class="load-btn">ğŸ’¾ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </section>

        <h2>ë“±ê¸‰ì»· ë°ì´í„° ì…ë ¥</h2>
        <table id="fixed-cuts-table">
            <thead>
                <tr>
                    <th>êµ¬ë¶„</th>
                    <th>ì›ì ìˆ˜ (ì»·)</th>
                    <th>í‘œì¤€ì ìˆ˜</th>
                    <th>ë°±ë¶„ìœ„</th>
                </tr>
            </thead>
            <tbody>
                <tr data-grade="1" data-type="max">
                    <th>ë§Œì </th>
                    <td><input type="number" name="raw_max" required></td>
                    <td><input type="number" name="std_max" required></td>
                    <td><input type="number" name="pct_max" required min="0" max="100"></td>
                </tr>
                <tr data-grade="1" data-type="cutoff">
                    <th>1ë“±ê¸‰</th>
                    <td><input type="number" name="raw_1" required></td>
                    <td><input type="number" name="std_1" required></td>
                    <td><input type="number" name="pct_1" required min="0" max="100"></td>
                </tr>
                <tr data-grade="2" data-type="cutoff">
                    <th>2ë“±ê¸‰</th>
                    <td><input type="number" name="raw_2" required></td>
                    <td><input type="number" name="std_2" required></td>
                    <td><input type="number" name="pct_2" required min="0" max="100"></td>
                </tr>
                <tr data-grade="3" data-type="cutoff">
                    <th>3ë“±ê¸‰</th>
                    <td><input type="number" name="raw_3" required></td>
                    <td><input type="number" name="std_3" required></td>
                    <td><input type="number" name="pct_3" required min="0" max="100"></td>
                </tr>
                <tr data-grade="4" data-type="cutoff">
                    <th>4ë“±ê¸‰</th>
                    <td><input type="number" name="raw_4" required></td>
                    <td><input type="number" name="std_4" required></td>
                    <td><input type="number" name="pct_4" required min="0" max="100"></td>
                </tr>
                <tr data-grade="5" data-type="cutoff">
                    <th>5ë“±ê¸‰</th>
                    <td><input type="number" name="raw_5" required></td>
                    <td><input type="number" name="std_5" required></td>
                    <td><input type="number" name="pct_5" required min="0" max="100"></td>
                </tr>
                <tr data-grade="6" data-type="cutoff">
                    <th>6ë“±ê¸‰</th>
                    <td><input type="number" name="raw_6" required></td>
                    <td><input type="number" name="std_6" required></td>
                    <td><input type="number" name="pct_6" required min="0" max="100"></td>
                </tr>
                <tr data-grade="7" data-type="cutoff">
                    <th>7ë“±ê¸‰</th>
                    <td><input type="number" name="raw_7" required></td>
                    <td><input type="number" name="std_7" required></td>
                    <td><input type="number" name="pct_7" required min="0" max="100"></td>
                </tr>
                <tr data-grade="8" data-type="cutoff">
                    <th>8ë“±ê¸‰</th>
                    <td><input type="number" name="raw_8" required></td>
                    <td><input type="number" name="std_8" required></td>
                    <td><input type="number" name="pct_8" required min="0" max="100"></td>
                </tr>
                 <tr data-grade="9" data-type="cutoff">
                    <th>9ë“±ê¸‰</th>
                    <td><input type="number" name="raw_9" value="0" required></td> <td><input type="number" name="std_9" required></td>
                    <td><input type="number" name="pct_9" value="0" required min="0" max="100"></td> </tr>
            </tbody>
        </table>

        <div class="button-container">
            <button type="submit" class="save-btn">ğŸ’¾ ì „ì²´ ì €ì¥</button>
        </div>

        <p id="message" class="message"></p>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ì„œë²„ ì£¼ì†Œ ë° ë¡œê·¸ì¸ í˜ì´ì§€
    const SVR_JUNGSI = 'https://supermax.kr';
    const LOGIN_PAGE = 'jungsilogin';

    // HTML ìš”ì†Œ
    const branchNameDisplay = document.getElementById('branch-name-display');
    const yearSelect = document.getElementById('year-select');
    const examTypeSelect = document.getElementById('exam-type-select');
    const subjectSelect = document.getElementById('subject-select');
    const loadCutsBtn = document.getElementById('load-cuts-btn');
    const fixedTableBody = document.querySelector('#fixed-cuts-table tbody');
    const gradecutForm = document.getElementById('gradecut-form');
    const messageEl = document.getElementById('message');

    // --- ì—‘ì…€ ë¶™ì—¬ë„£ê¸° ê¸°ëŠ¥ ---
    fixedTableBody.addEventListener('paste', (e) => {
        // ë¶™ì—¬ë„£ê¸° ê¸°ë³¸ ë™ì‘ ë°©ì§€
        e.preventDefault();

        // 1. í´ë¦½ë³´ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í…ìŠ¤íŠ¸ í˜•ì‹)
        const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
        
        // 2. ë¶™ì—¬ë„£ê¸° ì‹œì‘í•  ì¸í’‹(e.target) ì°¾ê¸°
        const startInput = e.target.closest('input[type="number"]');
        if (!startInput) return; // ì¸í’‹ì´ ì•„ë‹ˆë©´ ë¬´ì‹œ

        // 3. í…Œì´ë¸”ì˜ ëª¨ë“  ì¸í’‹ ëª©ë¡ì„ ë°°ì—´ë¡œ ê°€ì ¸ì˜¤ê¸° (DOM ìˆœì„œëŒ€ë¡œ)
        const allInputs = Array.from(fixedTableBody.querySelectorAll('input[type="number"]'));
        
        // 4. ì‹œì‘ ì¸ë±ìŠ¤ ì°¾ê¸°
        let startIndex = allInputs.indexOf(startInput);
        if (startIndex === -1) return;

        // 5. í´ë¦½ë³´ë“œ ë°ì´í„°ë¥¼ ì¤„(\n)ê³¼ ì¹¸(\t)ìœ¼ë¡œ ë¶„ë¦¬
        const rows = clipboardData.trim().split('\n');
        
        // ì—‘ì…€ì˜ ì—¬ëŸ¬ í–‰ì„ ë¶™ì—¬ë„£ê¸° ìœ„í•´, í…Œì´ë¸”ì˜ í˜„ì¬ í–‰ ì‹œì‘ ì¸ë±ìŠ¤ë¥¼ ì¶”ì 
        let currentInputRowIndex = startIndex; 

        for (const row of rows) {
            const cells = row.split('\t'); // íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ ì…€ ë°ì´í„°
            
            // í˜„ì¬ í…Œì´ë¸” í–‰ì—ì„œ ì—´(column)ì„ ìˆœíšŒí•˜ê¸° ìœ„í•œ ì¸ë±ìŠ¤
            let tempColIndex = currentInputRowIndex; 

            for (const cell of cells) {
                // í˜„ì¬ ì¸ë±ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ì¸í’‹ì´ í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                if (allInputs[tempColIndex]) {
                    // ê°’ì„ ì±„ìš°ê³ , ë‹¤ìŒ ì—´(input)ë¡œ ì¸ë±ìŠ¤ ì´ë™
                    allInputs[tempColIndex].value = cell.trim();
                    tempColIndex++;
                } else {
                    // ì´ í–‰ì— ë” ì´ìƒ ì±„ìš¸ ì¸í’‹ì´ ì—†ìœ¼ë©´(ì˜ˆ: 3ì¹¸ ë„˜ìŒ) ì¤‘ë‹¨
                    break;
                }
            }
            
            // ì—‘ì…€ì˜ ë‹¤ìŒ í–‰(row)ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´,
            // í…Œì´ë¸”ì˜ ë‹¤ìŒ í–‰(row)ì˜ ì‹œì‘ ì¸ë±ìŠ¤ë¡œ ì´ë™
            // (í•œ í–‰ì— 3ê°œì˜ ì¸í’‹ì´ ìˆìœ¼ë¯€ë¡œ +3)
            // (ì£¼ì˜: tempColIndexê°€ ì•„ë‹ˆë¼ currentInputRowIndex ê¸°ì¤€ìœ¼ë¡œ +3)
            
            // í˜„ì¬ í–‰ì˜ ì‹œì‘ ì¸ë±ìŠ¤ì—ì„œ 3ì„ ë”í•´ ë‹¤ìŒ í–‰ì˜ ì‹œì‘ ì¸ë±ìŠ¤ë¥¼ ê³„ì‚°
            const currentRow = allInputs[currentInputRowIndex].closest('tr');
            const inputsInRow = currentRow.querySelectorAll('input[type="number"]').length; // ë³´í†µ 3
            currentInputRowIndex += inputsInRow; 
            
            // í…Œì´ë¸”ì˜ ëì„ ë„˜ì–´ê°€ë©´ ì „ì²´ ì¤‘ë‹¨
            if (currentInputRowIndex >= allInputs.length) {
                break;
            }
        }
    });
    // --- ì—‘ì…€ ë¶™ì—¬ë„£ê¸° ê¸°ëŠ¥ ë ---


    // ê³¼ëª© ëª©ë¡ (optgroup êµ¬ì¡°)
    const SUBJECT_GROUPS = [
        { label: 'êµ­ì–´ ì„ íƒ', options: ['í™”ë²•ê³¼ì‘ë¬¸', 'ì–¸ì–´ì™€ë§¤ì²´'] },
        { label: 'ìˆ˜í•™ ì„ íƒ', options: ['í™•ë¥ ê³¼í†µê³„', 'ë¯¸ì ë¶„', 'ê¸°í•˜'] },
        { label: 'ì‚¬íšŒíƒêµ¬', options: ['ìƒí™œê³¼ìœ¤ë¦¬','ìœ¤ë¦¬ì™€ì‚¬ìƒ','í•œêµ­ì§€ë¦¬','ì„¸ê³„ì§€ë¦¬','ë™ì•„ì‹œì•„ì‚¬','ì„¸ê³„ì‚¬','ì •ì¹˜ì™€ë²•','ê²½ì œ','ì‚¬íšŒë¬¸í™”'] },
        { label: 'ê³¼í•™íƒêµ¬', options: ['ë¬¼ë¦¬1','í™”í•™1','ìƒëª…ê³¼í•™1','ì§€êµ¬ê³¼í•™1', 'ë¬¼ë¦¬2','í™”í•™2','ìƒëª…ê³¼í•™2','ì§€êµ¬ê³¼í•™2'] }
    ];

    // --- ì¸ì¦ ê²Œì´íŠ¸ ë° ì§€ì ëª… í‘œì‹œ ---
    const getToken = () => localStorage.getItem('jwt_token');
    const token = getToken();

    if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        window.location.href = LOGIN_PAGE;
        return;
    }

    try {
        // JWT Payload ë””ì½”ë”© (Base64 URL -> Base64 -> JSON)
        const payloadBase64Url = token.split('.')[1];
        const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
        const decodedPayload = JSON.parse(decodeURIComponent(atob(payloadBase64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join('')));

        if (decodedPayload && decodedPayload.branch) {
            branchNameDisplay.textContent = decodedPayload.branch;
        } else {
            branchNameDisplay.textContent = 'ì •ë³´ ì—†ìŒ';
            console.warn('í† í°ì— ì§€ì  ì •ë³´(branch)ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (e) {
        console.error('í† í° ë””ì½”ë”© ì‹¤íŒ¨:', e);
        branchNameDisplay.textContent = 'ì˜¤ë¥˜';
        alert('ì¸ì¦ ì •ë³´ ì˜¤ë¥˜. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        window.location.href = LOGIN_PAGE;
        return;
    }

    // --- ê³¼ëª© ì„ íƒ ì˜µì…˜ ë™ì  ìƒì„± (optgroup ì‚¬ìš©) ---
    SUBJECT_GROUPS.forEach(group => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = group.label;
        group.options.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            optgroup.appendChild(option);
        });
        subjectSelect.appendChild(optgroup);
    });

    // --- ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” í•¨ìˆ˜ ---
    const clearInputFields = () => {
        fixedTableBody.querySelectorAll('input[type="number"]').forEach(input => {
            // 9ë“±ê¸‰ ì›ì ìˆ˜/ë°±ë¶„ìœ„ëŠ” ê¸°ë³¸ê°’ ìœ ì§€
            if (input.name !== 'raw_9' && input.name !== 'pct_9') {
                 input.value = '';
            } else if (input.name === 'raw_9') {
                 input.value = '0'; // 9ë“±ê¸‰ ì›ì ìˆ˜ ê¸°ë³¸ê°’ 0 ì„¤ì •
            } else if (input.name === 'pct_9') {
                 input.value = '0'; // 9ë“±ê¸‰ ë°±ë¶„ìœ„ ê¸°ë³¸ê°’ 0 ì„¤ì •
            }
        });
         // ë§Œì  í–‰ ì´ˆê¸°í™” ì¶”ê°€
        fixedTableBody.querySelector('input[name="raw_max"]').value = '';
        fixedTableBody.querySelector('input[name="std_max"]').value = '';
        fixedTableBody.querySelector('input[name="pct_max"]').value = '';
    };

    // --- ë“±ê¸‰ì»· ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ---
    loadCutsBtn.addEventListener('click', async () => {
        const year = yearSelect.value;
        const examType = examTypeSelect.value;
        const subject = subjectSelect.value;

        if (!subject) {
            alert('ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        messageEl.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        messageEl.className = 'message';
        clearInputFields(); // ë¶ˆëŸ¬ì˜¤ê¸° ì „ í•„ë“œ ì´ˆê¸°í™”

        try {
            const response = await fetch(`${SVR_JUNGSI}/jungsi/grade-cuts/get?year=${year}&exam_type=${examType}&subject=${subject}`, {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            const data = await response.json();

            if (response.status === 401 || response.status === 403) {
                 alert('ì¸ì¦ ì˜¤ë¥˜. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                 window.location.href = LOGIN_PAGE;
                 return;
            }

            if (data.success && data.cuts.length > 0) {
                // ì„œë²„ ë°ì´í„°ëŠ” ì›ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ìƒíƒœ
                const cutsFromServer = data.cuts;

                // 1. ë§Œì  ë°ì´í„° ì±„ìš°ê¸° (ê°€ì¥ ë†’ì€ ì›ì ìˆ˜ ê¸°ì¤€)
                const maxScoreData = cutsFromServer[0];
                if (maxScoreData) {
                    fixedTableBody.querySelector('input[name="raw_max"]').value = maxScoreData.ì›ì ìˆ˜;
                    fixedTableBody.querySelector('input[name="std_max"]').value = maxScoreData.í‘œì¤€ì ìˆ˜;
                    fixedTableBody.querySelector('input[name="pct_max"]').value = maxScoreData.ë°±ë¶„ìœ„;
                }

                // 2. ë“±ê¸‰ì»· ë°ì´í„° ì±„ìš°ê¸° (ê° ë“±ê¸‰ì˜ ê°€ì¥ ë‚®ì€ ì›ì ìˆ˜ ê¸°ì¤€)
                for (let grade = 1; grade <= 9; grade++) {
                    // í•´ë‹¹ ë“±ê¸‰ ë°ì´í„° ì¤‘ ê°€ì¥ ë‚®ì€ ì›ì ìˆ˜(ë§ˆì§€ë§‰ ìš”ì†Œ)ë¥¼ ì°¾ìŒ
                    const gradeCutData = cutsFromServer.filter(c => c.ë“±ê¸‰ === grade).pop();

                    if (gradeCutData) {
                        // 9ë“±ê¸‰ ë°ì´í„°ëŠ” ê¸°ë³¸ê°’ì´ ìˆìœ¼ë¯€ë¡œ, ë¶ˆëŸ¬ì˜¨ ê°’ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°
                        fixedTableBody.querySelector(`input[name="raw_${grade}"]`).value = gradeCutData.ì›ì ìˆ˜;
                        fixedTableBody.querySelector(`input[name="std_${grade}"]`).value = gradeCutData.í‘œì¤€ì ìˆ˜;
                        fixedTableBody.querySelector(`input[name="pct_${grade}"]`).value = gradeCutData.ë°±ë¶„ìœ„;
                    }
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”ëœ ìƒíƒœ ìœ ì§€ (9ë“±ê¸‰ ì œì™¸)
                }

                messageEl.textContent = 'ë“±ê¸‰ì»·ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.';
                messageEl.className = 'message success';
            } else if (data.success && data.cuts.length === 0) {
                 // ë°ì´í„°ê°€ ì—†ì„ ë•Œë„ í•„ë“œëŠ” ì´ˆê¸°í™”ëœ ìƒíƒœì´ë¯€ë¡œ ë©”ì‹œì§€ë§Œ í‘œì‹œ
                 messageEl.textContent = 'ì €ì¥ëœ ë“±ê¸‰ì»· ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                 messageEl.className = 'message';
            } else {
                 messageEl.textContent = data.message || 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
                 messageEl.className = 'message error';
            }
        } catch (err) {
            console.error('ë“±ê¸‰ì»· ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
            messageEl.textContent = 'ì„œë²„ í†µì‹  ì˜¤ë¥˜.';
            messageEl.className = 'message error';
        }
    });

    // --- í¼ ì œì¶œ (ì €ì¥) ì´ë²¤íŠ¸ ---
    gradecutForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        messageEl.textContent = 'ì €ì¥ ì¤‘...';
        messageEl.className = 'message';

        const year = yearSelect.value;
        const examType = examTypeSelect.value;
        const subject = subjectSelect.value;

        if (!subject) {
            alert('ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            messageEl.textContent = '';
            return;
        }

        const cutsData = []; // APIë¡œ ë³´ë‚¼ ìµœì¢… ë°°ì—´
        let isValid = true;

        // ê³ ì • í…Œì´ë¸”ì—ì„œ ë°ì´í„° ì½ê¸°
        const rows = fixedTableBody.querySelectorAll('tr[data-grade]');
        rows.forEach(tr => {
            const grade = parseInt(tr.dataset.grade);
            const type = tr.dataset.type; // 'max' or 'cutoff'
            let rawInput, stdInput, pctInput;

            // íƒ€ì…ì— ë”°ë¼ input ìš”ì†Œ ì°¾ê¸°
            if (type === 'max') {
                rawInput = tr.querySelector('input[name="raw_max"]');
                stdInput = tr.querySelector('input[name="std_max"]');
                pctInput = tr.querySelector('input[name="pct_max"]');
            } else { // cutoff
                rawInput = tr.querySelector(`input[name="raw_${grade}"]`);
                stdInput = tr.querySelector(`input[name="std_${grade}"]`);
                pctInput = tr.querySelector(`input[name="pct_${grade}"]`);
            }

            // ê°’ ì½ê¸° (ë¹ˆ ë¬¸ìì—´ì´ë©´ null ì²˜ë¦¬)
            const rawScore = rawInput.value === '' ? null : parseInt(rawInput.value);
            const stdScore = stdInput.value === '' ? null : parseInt(stdInput.value);
            const percentile = pctInput.value === '' ? null : parseInt(pctInput.value);

            // í•„ìˆ˜ ê°’ ìœ íš¨ì„± ê²€ì‚¬ (null ì²´í¬)
            if (rawScore === null || stdScore === null || percentile === null) {
                isValid = false;
            }

            // ìœ íš¨í•œ ê²½ìš°ì—ë§Œ cutsData ë°°ì—´ì— ì¶”ê°€
            if (rawScore !== null && stdScore !== null && percentile !== null) {
                 cutsData.push({
                     ì›ì ìˆ˜: rawScore,
                     í‘œì¤€ì ìˆ˜: stdScore,
                     ë°±ë¶„ìœ„: percentile,
                     ë“±ê¸‰: grade // í•´ë‹¹ í–‰ì˜ ë“±ê¸‰ ê°’ ì‚¬ìš©
                 });
            }
        });

        if (!isValid) {
            alert('ë§Œì  ë° ëª¨ë“  ë“±ê¸‰ì»·ì˜ ì›ì ìˆ˜, í‘œì¤€ì ìˆ˜, ë°±ë¶„ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            messageEl.textContent = 'ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
            messageEl.className = 'message error';
            return;
        }

        // ì„œë²„ APIë¡œ ì „ì†¡
        try {
            const currentToken = getToken();
            if (!currentToken) {
                alert('ë¡œê·¸ì¸ ì„¸ì…˜ ë§Œë£Œ. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = LOGIN_PAGE;
                return;
            }

            const response = await fetch(`${SVR_JUNGSI}/jungsi/grade-cuts/set-bulk`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                },
                body: JSON.stringify({
                    year: year,
                    exam_type: examType,
                    subject: subject,
                    cuts: cutsData // ê°€ê³µëœ ë°ì´í„° ë°°ì—´ ì „ì†¡
                })
            });

            const data = await response.json();

            if (response.status === 401 || response.status === 403) {
                 alert('ì¸ì¦ ì˜¤ë¥˜. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                 window.location.href = LOGIN_PAGE;
                 return;
            }

            if (data.success) {
                messageEl.textContent = `[${year} ${examType} ${subject}] ë“±ê¸‰ì»·ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                messageEl.className = 'message success';
            } else {
                messageEl.textContent = data.message || 'ì €ì¥ ì‹¤íŒ¨';
                messageEl.className = 'message error';
            }
        } catch (err) {
            console.error('ë“±ê¸‰ì»· ì €ì¥ ì˜¤ë¥˜:', err);
            messageEl.textContent = 'ì„œë²„ í†µì‹  ì˜¤ë¥˜.';
            messageEl.className = 'message error';
        }
    });

    // í…Œì´ë¸” input ìš”ì†Œ ì´ë¦„ ìë™ ì„¤ì • ë° required ì†ì„± ì¶”ê°€ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
    fixedTableBody.querySelectorAll('tr[data-grade]').forEach(tr => {
        const grade = tr.dataset.grade;
        const type = tr.dataset.type;
        const inputs = tr.querySelectorAll('input[type="number"]');

        // input name ì„¤ì •
        if (type === 'max') {
            inputs[0].name = 'raw_max'; inputs[1].name = 'std_max'; inputs[2].name = 'pct_max';
        } else if (grade) {
            inputs[0].name = `raw_${grade}`; inputs[1].name = `std_${grade}`; inputs[2].name = `pct_${grade}`;
            // 9ë“±ê¸‰ ê¸°ë³¸ê°’ ì„¤ì •
            if (grade === '9') {
                if (!inputs[0].value) inputs[0].value = '0'; // ì›ì ìˆ˜ 0
                if (!inputs[2].value) inputs[2].value = '0'; // ë°±ë¶„ìœ„ 0
            }
        }
        // ëª¨ë“  input í•„ë“œë¥¼ í•„ìˆ˜ë¡œ ì„¤ì •
        inputs.forEach(input => input.required = true);
    });

});
</script>

</body>
</html>