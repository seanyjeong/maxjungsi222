<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ì •ì‹œ í•™ìƒ ëª…ë‹¨ ê´€ë¦¬</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3a0ca3;
            --secondary-color: #7209b7;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-light: #adb5bd;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-light: 0 2px 6px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * { 
            margin:0; 
            padding:0; 
            box-sizing:border-box; 
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .login-info { 
            display: none; 
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            padding: 8px 15px;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-light);
        }

        .year-selector select {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--text-secondary);
        }

        tbody tr { 
            transition: background-color .2s; 
        }
        
        tbody tr:hover { 
            background-color: #f8fafc; 
        }

        input[type="text"], select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color .2s, box-shadow .2s;
        }

        input[name="phone_number"] {
            font-family: monospace;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all .2s;
        }

        .btn-primary { 
            background-color: var(--primary-color); 
            color: #fff; 
        }
        
        .btn-primary:hover { 
            background-color: var(--primary-dark); 
        }
        
        .btn-success { 
            background-color: var(--success-color); 
            color: #fff; 
        }
        
        .btn-success:hover { 
            background-color: #3aa8d4; 
        }
        
        .btn-danger { 
            background-color: var(--danger-color); 
            color: #fff; 
        }
        
        .btn-danger:hover { 
            background-color: #e11573; 
        }
        
        .btn-outline { 
            background-color: transparent; 
            border: 1px solid var(--border-color); 
            color: var(--text-secondary); 
        }
        
        .btn-outline:hover { 
            background-color: #f8fafc; 
        }
        
        .btn-sm { 
            padding: 6px 12px; 
            font-size: 0.8rem; 
        }

        .button-group { 
            display: flex; 
            gap: 10px; 
            margin-top: 20px; 
            flex-wrap: wrap; 
        }

        .message {
            padding: 12px 15px;
            border-radius: var(--radius-sm);
            margin-top: 15px;
            font-weight: 500;
            text-align: center;
            display: none;
        }
        
        .message.success { 
            background-color: #e8f5e9; 
            color: #2e7d32; 
            border: 1px solid #c8e6c9; 
            display: block; 
        }
        
        .message.error { 
            background-color: #ffebee; 
            color: #c62828; 
            border: 1px solid #ffcdd2; 
            display: block; 
        }
        
        .message.info { 
            background-color: #e3f2fd; 
            color: #1565c0; 
            border: 1px solid #bbdefb; 
            display: block; 
        }

        .actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .editing { 
            background-color: #f0f9ff !important; 
        }
        
        .editing td:nth-child(4) select,
        .editing td:nth-child(5) select,
        .editing td:nth-child(6) select {
            text-align: center;
        }

        /* ì»¬ëŸ¼ ë„ˆë¹„ */
        th:nth-child(1), td:nth-child(1) { width: 18%; min-width: 100px; }
        th:nth-child(2), td:nth-child(2) { width: 25%; min-width: 120px; }
        th:nth-child(3), td:nth-child(3) { width: 18%; min-width: 110px; }
        th:nth-child(4), td:nth-child(4) { width: 12%; min-width: 70px; text-align: center; }
        th:nth-child(5), td:nth-child(5) { width: 10%; min-width: 50px; text-align: center; }
        th:nth-child(6), td:nth-child(6) { width: 10%; min-width: 50px; text-align: center; }
        th:nth-child(7), td:nth-child(7) { width: 15%; min-width: 120px; text-align: center; }

        td.actions { white-space: nowrap; }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-info { 
                width: 100%; 
                justify-content: space-between; 
            }
            
            .card-header { 
                flex-direction: column; 
                align-items: flex-start; 
                gap: 15px; 
            }
            
            .button-group { 
                flex-direction: column; 
            }
            
            .btn { 
                width: 100%; 
                justify-content: center; 
            }

            .table-container {
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }
            
            table { 
                min-width: 700px; 
                table-layout: auto; 
            }
            
            th, td { 
                white-space: nowrap; 
            }
            
            th:nth-child(1), td:nth-child(1) { min-width: 80px; }
            th:nth-child(2), td:nth-child(2) { min-width: 100px; }
            th:nth-child(3), td:nth-child(3) { min-width: 120px; }
            th:nth-child(4), td:nth-child(4) { min-width: 80px; }
            th:nth-child(5), td:nth-child(5) { min-width: 50px; }
            th:nth-child(6), td:nth-child(6) { min-width: 50px; }
            th:nth-child(7), td:nth-child(7) { min-width: 100px; }
        }

        .icon { 
            font-size: 1.2rem; 
        }

        .student-count {
            background: var(--primary-color);
            color: #fff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .card-title {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 10px;
        }

        .hint-inline-text {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            line-height: 1.4;
            display: flex;
            align-items: flex-start;
            gap: 6px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--primary-color);
        }

        .hint-inline-text i {
            font-size: 0.8rem;
            color: var(--primary-color);
            line-height: 1.2;
            margin-top: 2px;
        }

        .card-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            padding: 15px;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
        }

        .badge-success {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success-color);
        }

        .badge-danger {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--danger-color);
        }

        .badge-warning {
            background-color: rgba(248, 150, 30, 0.1);
            color: var(--warning-color);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-user-graduate icon"></i> ì •ì‹œ í•™ìƒ ëª…ë‹¨ ê´€ë¦¬</h1>
        <div class="header-info">
            <div class="login-info">
                <i class="fas fa-building"></i> ë¡œê·¸ì¸ ì§€ì : <span id="branch-name-display">...</span>
            </div>
            <div class="year-selector">
                <label for="year-select">ëŒ€ìƒ í•™ë…„ë„:</label>
                <select id="year-select">
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                </select>
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ì¶”ê°€ ì¹´ë“œ -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <span style="display:flex; align-items:center; gap:8px; font-weight:600; color:var(--text-primary);">
                    <i class="fas fa-user-plus icon"></i>
                    í•™ìƒ ì¶”ê°€
                </span>
            </h2>
        </div>

        <div class="hint-inline-text">
            <i class="fas fa-info-circle"></i>
            <span>
                ì—‘ì…€ì´ë‚˜ êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ì´ë¦„ / í•™êµ / ì „í™” / êµ¬ë¶„ / í•™ë…„ / ì„±ë³„ ì—¬ëŸ¬ ì¤„ ë³µì‚¬ â†’  
                ì²« ë²ˆì§¸ í–‰ì˜ 'ì´ë¦„' ì¹¸ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ë©´ í–‰ì´ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ ğŸ‘
            </span>
        </div>

        <div class="table-container">
            <table id="add-student-table">
                <thead>
                    <tr>
                        <th>ì´ë¦„</th>
                        <th>í•™êµëª…</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>ì—°ë½ì²˜ êµ¬ë¶„</th>
                        <th>í•™ë…„</th>
                        <th>ì„±ë³„</th>
                        <th>ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody id="add-student-tbody"></tbody>
            </table>
        </div>

        <div class="button-group">
            <button type="button" id="add-row-btn" class="btn btn-outline">
                <i class="fas fa-plus"></i> í–‰ ì¶”ê°€
            </button>
            <button type="button" id="add-students-btn" class="btn btn-primary">
                <i class="fas fa-list"></i> ëª…ë‹¨ ì¶”ê°€
            </button>
        </div>

        <p id="add-message" class="message"></p>
    </div>

    <!-- ë“±ë¡ëœ í•™ìƒ ëª©ë¡ ì¹´ë“œ -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-users icon"></i> ë“±ë¡ëœ í•™ìƒ ëª©ë¡
                <span class="student-count" id="student-count">0</span>
            </h2>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="total-students">0</div>
                <div class="stat-label">ì „ì²´ í•™ìƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="grade3-students">0</div>
                <div class="stat-label">3í•™ë…„</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="gradeN-students">0</div>
                <div class="stat-label">Nìˆ˜ìƒ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="grade2-students">0</div>
                <div class="stat-label">2í•™ë…„</div>
            </div>
        </div>

        <div class="table-container">
            <table id="student-table">
                <thead>
                    <tr>
                        <th>ì´ë¦„</th>
                        <th>í•™êµëª…</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                        <th>ì—°ë½ì²˜ êµ¬ë¶„</th>
                        <th>í•™ë…„</th>
                        <th>ì„±ë³„</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="student-tbody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SVR_JUNGSI = 'https://supermax.kr';
    const LOGIN_PAGE = 'jungsilogin.html';

    const branchNameDisplay = document.getElementById('branch-name-display');
    const yearSelect = document.getElementById('year-select');
    const addStudentTbody = document.getElementById('add-student-tbody');
    const addRowBtn = document.getElementById('add-row-btn');
    const addStudentsBtn = document.getElementById('add-students-btn');
    const addMessageEl = document.getElementById('add-message');
    const studentTbody = document.getElementById('student-tbody');
    const studentCountEl = document.getElementById('student-count');
    const totalStudentsEl = document.getElementById('total-students');
    const grade3StudentsEl = document.getElementById('grade3-students');
    const gradeNStudentsEl = document.getElementById('gradeN-students');
    const grade2StudentsEl = document.getElementById('grade2-students');

    let userBranchName = '';
    let existingStudents = [];

    /* 1. ì¸ì¦ ê²€ì‚¬ + branch í‘œì‹œ */
    const getToken = () => localStorage.getItem('jwt_token');
    const token = getToken();
    if (!token) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = LOGIN_PAGE;
        return;
    }
    try {
        const payloadBase64Url = token.split('.')[1];
        const payloadBase64 = payloadBase64Url.replace(/-/g, '+').replace(/_/g, '/');
        const binaryString = atob(payloadBase64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
        const decodedString = new TextDecoder().decode(bytes);
        const decodedPayload = JSON.parse(decodedString);
        if (decodedPayload && decodedPayload.branch) {
            userBranchName = decodedPayload.branch;
            // branchNameDisplay.textContent = userBranchName;
        } else {
            throw new Error('í† í°ì— ì§€ì  ì •ë³´ ì—†ìŒ');
        }
    } catch (e) {
        console.error('í† í° ì²˜ë¦¬ ì‹¤íŒ¨:', e);
        alert('ì¸ì¦ ì •ë³´ ì˜¤ë¥˜.');
        window.location.href = LOGIN_PAGE;
        return;
    }

    /* 2. ê³µí†µ API í˜¸ì¶œ ë˜í¼ */
    const apiCall = async (url, options = {}) => {
        const currentToken = getToken();
        if (!currentToken) {
            alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = LOGIN_PAGE;
            throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ');
        }
        options.headers = { ...options.headers, 'Authorization': `Bearer ${currentToken}` };

        try {
            const response = await fetch(url, options);
            if (response.status === 401 || response.status === 403) {
                alert('ì¸ì¦ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                localStorage.removeItem('jwt_token');
                window.location.href = LOGIN_PAGE;
                throw new Error('ì¸ì¦ ì˜¤ë¥˜');
            }
            if (response.status === 204) {
                return { success: true };
            }
            if (!response.ok) {
                let errorMsg = `HTTP ì˜¤ë¥˜ ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message || errorMsg;
                } catch (_) {}
                throw new Error(errorMsg);
            }
            return await response.json();
        } catch (error) {
            console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', url, error);
            if (error.message !== 'ë¡œê·¸ì¸ ë§Œë£Œ' && error.message !== 'ì¸ì¦ ì˜¤ë¥˜') {
                throw new Error(error.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ì—†ìŒ');
            }
            throw error;
        }
    };

    /* 3. ë©”ì‹œì§€ ì¶œë ¥ */
    const showMessage = (element, text, type) => {
        element.textContent = text;
        element.className = `message ${type}`;
        element.style.display = 'block';
    };

    /* 4. ì…ë ¥í–‰(tr) ë§Œë“œëŠ” í•¨ìˆ˜ */
    function addStudentInputRow(preset = {}) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <input type="text" name="student_name" required placeholder="í™ê¸¸ë™" value="${preset.student_name || ''}" />
            </td>
            <td>
                <input type="text" name="school_name" placeholder="ë§¥ìŠ¤ê³ " value="${preset.school_name || ''}" />
            </td>
            <td>
                <input type="text" name="phone_number" placeholder="010-1234-5678" value="${preset.phone_number || ''}" />
            </td>
            <td>
                <select name="phone_owner">
                    <option value="í•™ìƒ" ${preset.phone_owner === 'í•™ë¶€ëª¨' ? '' : 'selected'}>í•™ìƒ</option>
                    <option value="í•™ë¶€ëª¨" ${preset.phone_owner === 'í•™ë¶€ëª¨' ? 'selected' : ''}>í•™ë¶€ëª¨</option>
                </select>
            </td>
            <td>
                <select name="grade" required>
                    <option value="3" ${preset.grade === '3' ? 'selected' : ''}>3</option>
                    <option value="N" ${preset.grade === 'N' ? 'selected' : ''}>N</option>
                    <option value="2" ${preset.grade === '2' ? 'selected' : ''}>2</option>
                </select>
            </td>
            <td>
                <select name="gender" required>
                    <option value="ë‚¨" ${preset.gender === 'ì—¬' ? '' : 'selected'}>ë‚¨</option>
                    <option value="ì—¬" ${preset.gender === 'ì—¬' ? 'selected' : ''}>ì—¬</option>
                </select>
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm delete-row-btn">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;

        // ì‚­ì œ ë²„íŠ¼
        tr.querySelector('.delete-row-btn').addEventListener('click', () => tr.remove());

        // â­ í•µì‹¬: ì´ë¦„ì¹¸ paste ì´ë²¤íŠ¸ ê°ì§€
        const nameInput = tr.querySelector('input[name="student_name"]');
        nameInput.addEventListener('paste', (e) => {
            // í´ë¦½ë³´ë“œ ì „ì²´ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const pasteData = e.clipboardData.getData('text');
            // ì—¬ëŸ¬ ì¤„ì´ë¼ë©´ ìš°ë¦¬ê°€ ì§ì ‘ ì²˜ë¦¬í•˜ê³  ê¸°ë³¸ paste ë§‰ê¸°
            if (pasteData.includes('\n') || pasteData.includes('\r')) {
                e.preventDefault();
                handleBulkPasteIntoRows(pasteData, tr);
            }
        });

        addStudentTbody.appendChild(tr);
        return tr;
    }

    // í˜ì´ì§€ ë“¤ì–´ì˜¤ë©´ ìµœì´ˆ í•œ ì¤„ ìƒì„±
    addStudentInputRow();

    // í–‰ ì¶”ê°€ ë²„íŠ¼ì€ ê¸°ì¡´ì²˜ëŸ¼ ìˆ˜ë™ ì¶”ê°€
    addRowBtn.addEventListener('click', () => addStudentInputRow());

    /* 5. ì‹¤ì œ ë¶™ì—¬ë„£ê¸° íŒŒì„œ
          pasteëœ í…ìŠ¤íŠ¸ ì „ì²´ë¥¼ ì¤„ë³„/ì»¬ëŸ¼ë³„ë¡œ ìª¼ê°œì„œ
          í˜„ì¬ trë¶€í„° ì±„ìš°ê³ , ì¶”ê°€ tr ìƒì„±í•´ì„œ ì±„ì›€
    */
    function handleBulkPasteIntoRows(rawText, firstTr) {
        // 1) ì¤„ ë¶„ë¦¬
        const lines = rawText
            .split(/\r?\n/)
            .map(l => l.trim())
            .filter(l => l.length > 0);

        if (lines.length === 0) return;

        // 2) ì²« ì¤„ë¶€í„° ìˆœì„œëŒ€ë¡œ student rows ë§Œë“¤ê¸°
        // columns: [ì´ë¦„, í•™êµ, ì „í™”, êµ¬ë¶„, í•™ë…„, ì„±ë³„]
        // split ìš°ì„  íƒ­, íƒ­ì´ ì—†ìœ¼ë©´ ì‰¼í‘œ
        const parsedRows = lines.map(line => {
            let cols = line.split('\t');
            if (cols.length === 1) {
                cols = line.split(',');
            }
            cols = cols.map(v => v.trim());
            return {
                student_name: cols[0] || '',
                school_name:  cols[1] || '',
                phone_number: cols[2] || '',
                phone_owner:  cols[3] || 'í•™ìƒ',
                grade:        cols[4] || '3',
                gender:       cols[5] || 'ë‚¨'
            };
        }).filter(row => row.student_name !== '');

        if (parsedRows.length === 0) return;

        // 3) ì²« ë²ˆì§¸ ì¤„ì€ firstTrì— ê·¸ëŒ€ë¡œ ì±„ì›Œì£¼ê³ 
        const firstData = parsedRows[0];
        fillRowInputs(firstTr, firstData);

        // 4) ë‚˜ë¨¸ì§€ ì¤„ë“¤ì€ ìƒˆë¡œ tr ë§Œë“¤ì–´ì„œ ì±„ìš°ê¸°
        for (let i = 1; i < parsedRows.length; i++) {
            const tr = addStudentInputRow(parsedRows[i]);
            fillRowInputs(tr, parsedRows[i]);
        }

        showMessage(addMessageEl, `${parsedRows.length}ëª…ì˜ ë°ì´í„°ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ í›„ "ëª…ë‹¨ ì¶”ê°€"ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.`, 'info');
    }

    // rowì— preset ê°’ ë°˜ì˜í•˜ëŠ” ìœ í‹¸
    function fillRowInputs(tr, preset) {
        tr.querySelector('input[name="student_name"]').value = preset.student_name || '';
        tr.querySelector('input[name="school_name"]').value  = preset.school_name || '';
        tr.querySelector('input[name="phone_number"]').value = preset.phone_number || '';

        const ownerSel = tr.querySelector('select[name="phone_owner"]');
        const gradeSel = tr.querySelector('select[name="grade"]');
        const genderSel= tr.querySelector('select[name="gender"]');

        if (ownerSel) ownerSel.value   = preset.phone_owner || 'í•™ìƒ';
        if (gradeSel) gradeSel.value   = preset.grade || '3';
        if (genderSel) genderSel.value = preset.gender || 'ë‚¨';
    }

    /* 6. í•™ìƒ ëª©ë¡ ë¡œë“œ */
    const loadStudentList = async () => {
        const selectedYear = yearSelect.value;
        studentTbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align:center; padding:30px;">
                    ${selectedYear}í•™ë…„ë„ ëª©ë¡ ë¡œë”©ì¤‘... <i class="fas fa-spinner fa-spin"></i>
                </td>
            </tr>
        `;
        studentCountEl.textContent = '0';
        totalStudentsEl.textContent = '0';
        grade3StudentsEl.textContent = '0';
        gradeNStudentsEl.textContent = '0';
        grade2StudentsEl.textContent = '0';
        existingStudents = [];
        try {
            const data = await apiCall(`${SVR_JUNGSI}/jungsi/students/list-by-branch?year=${selectedYear}`);
            if (data.success && data.students) {
                existingStudents = data.students;
                renderStudentList(data.students);
                updateStudentStats(data.students);
            } else {
                studentTbody.innerHTML = `
                    <tr><td colspan="7" style="text-align:center; padding:30px;">
                        ëª©ë¡ ë¡œë”© ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}
                    </td></tr>`;
            }
        } catch (err) {
            console.error('ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', err);
            studentTbody.innerHTML = `
                <tr><td colspan="7" style="text-align:center; padding:30px;">
                    ì˜¤ë¥˜ ë°œìƒ: ${err.message}
                </td></tr>`;
        }
    };

    /* í•™ìƒ í†µê³„ ì—…ë°ì´íŠ¸ */
    const updateStudentStats = (students) => {
        totalStudentsEl.textContent = students.length;
        
        const grade3Count = students.filter(s => s.grade === '3').length;
        const gradeNCount = students.filter(s => s.grade === 'N').length;
        const grade2Count = students.filter(s => s.grade === '2').length;
        
        grade3StudentsEl.textContent = grade3Count;
        gradeNStudentsEl.textContent = gradeNCount;
        grade2StudentsEl.textContent = grade2Count;
    };

    /* 7. í•™ìƒ ëª©ë¡ ë Œë”ë§ / ìˆ˜ì • / ì‚­ì œ */
    const renderStudentList = (students) => {
        studentTbody.innerHTML = '';
        studentCountEl.textContent = students.length;
        if (students.length === 0) {
            studentTbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px;">ë“±ë¡ëœ í•™ìƒ ì—†ìŒ.</td></tr>';
            return;
        }

        students.forEach(student => {
            const tr = document.createElement('tr');
            tr.dataset.studentId = student.student_id;

            const deleteHandler = async () => {
                const studentName = tr.querySelector('[data-field="student_name"]').textContent;
                if (!confirm(`ì •ë§ë¡œ '${studentName}' í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°(ì„±ì , ìƒë‹´ë‚´ì—­ ë“±)ê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤!`)) {
                    return;
                }
                const studentId = tr.dataset.studentId;
                const deleteButton = tr.querySelector('.delete-btn');
                if (deleteButton) deleteButton.disabled = true;

                try {
                    const result = await apiCall(`${SVR_JUNGSI}/jungsi/students/delete/${studentId}`, {
                        method: 'DELETE'
                    });

                    if (result.success) {
                        tr.remove();
                        const currentCount = parseInt(studentCountEl.textContent || '1') - 1;
                        studentCountEl.textContent = currentCount;
                        updateStudentStats(existingStudents.filter(s => s.student_id != studentId));
                    } else {
                        alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                        if (deleteButton) deleteButton.disabled = false;
                    }
                } catch (err) {
                    console.error('í•™ìƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err);
                    if (deleteButton) deleteButton.disabled = false;
                }
            };

            const editHandler = () => {
                const currentlyEditing = studentTbody.querySelector('tr.editing');
                if (currentlyEditing && currentlyEditing !== tr) {
                    alert('ë¨¼ì € ë‹¤ë¥¸ í•™ìƒì˜ ìˆ˜ì •ì„ ì™„ë£Œí•˜ê±°ë‚˜ ì·¨ì†Œí•´ì£¼ì„¸ìš”.');
                    return;
                }
                tr.classList.add('editing');
                const nameTd   = tr.querySelector('[data-field="student_name"]');
                const schoolTd = tr.querySelector('[data-field="school_name"]');
                const phoneTd  = tr.querySelector('[data-field="phone_number"]');
                const ownerTd  = tr.querySelector('[data-field="phone_owner"]');
                const gradeTd  = tr.querySelector('[data-field="grade"]');
                const genderTd = tr.querySelector('[data-field="gender"]');
                const actionsTd= tr.querySelector('.actions');

                const originalData = {
                    name:   nameTd.textContent,
                    school: schoolTd.textContent,
                    phone:  phoneTd.textContent,
                    owner:  ownerTd.textContent,
                    grade:  gradeTd.textContent,
                    gender: genderTd.textContent
                };

                nameTd.innerHTML   = `<input type="text" value="${originalData.name}" required>`;
                schoolTd.innerHTML = `<input type="text" value="${originalData.school}">`;
                phoneTd.innerHTML  = `<input type="text" name="phone_number" value="${originalData.phone}" placeholder="010-1234-5678">`;
                ownerTd.innerHTML  = `<select>
                        <option value="í•™ìƒ" ${originalData.owner==='í•™ìƒ'?'selected':''}>í•™ìƒ</option>
                        <option value="í•™ë¶€ëª¨" ${originalData.owner==='í•™ë¶€ëª¨'?'selected':''}>í•™ë¶€ëª¨</option>
                    </select>`;
                gradeTd.innerHTML  = `<select>
                        <option value="3" ${originalData.grade==='3'?'selected':''}>3</option>
                        <option value="N" ${originalData.grade==='N'?'selected':''}>N</option>
                        <option value="2" ${originalData.grade==='2'?'selected':''}>2</option>
                    </select>`;
                genderTd.innerHTML = `<select>
                        <option value="ë‚¨" ${originalData.gender==='ë‚¨'?'selected':''}>ë‚¨</option>
                        <option value="ì—¬" ${originalData.gender==='ì—¬'?'selected':''}>ì—¬</option>
                    </select>`;
                actionsTd.innerHTML= `
                    <button type="button" class="btn btn-success btn-sm save-edit-btn"><i class="fas fa-check"></i></button>
                    <button type="button" class="btn btn-outline btn-sm cancel-edit-btn"><i class="fas fa-times"></i></button>
                `;

                const cancelHandler = () => {
                    tr.classList.remove('editing');
                    nameTd.textContent   = originalData.name;
                    schoolTd.textContent = originalData.school;
                    phoneTd.textContent  = originalData.phone;
                    ownerTd.textContent  = originalData.owner;
                    gradeTd.textContent  = originalData.grade;
                    genderTd.textContent = originalData.gender;
                    actionsTd.innerHTML  = `
                        <button type="button" class="btn btn-primary btn-sm edit-btn"><i class="fas fa-edit"></i></button>
                        <button type="button" class="btn btn-danger btn-sm delete-btn"><i class="fas fa-trash"></i></button>
                    `;
                    tr.querySelector('.edit-btn').addEventListener('click', editHandler);
                    tr.querySelector('.delete-btn').addEventListener('click', deleteHandler);
                };

                const saveHandler = async () => {
                    const studentId = tr.dataset.studentId;
                    const updatedData = {
                        student_name: nameTd.querySelector('input').value.trim(),
                        school_name:  schoolTd.querySelector('input').value.trim() || null,
                        phone_number: phoneTd.querySelector('input').value.trim() || null,
                        phone_owner:  ownerTd.querySelector('select').value,
                        grade:        gradeTd.querySelector('select').value,
                        gender:       genderTd.querySelector('select').value
                    };
                    if (!updatedData.student_name) {
                        alert('í•™ìƒ ì´ë¦„ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.');
                        return;
                    }
                    actionsTd.innerHTML = 'ì €ì¥ì¤‘...';
                    try {
                        const result = await apiCall(`${SVR_JUNGSI}/jungsi/students/update/${studentId}`, {
                            method:'PUT',
                            headers:{'Content-Type':'application/json'},
                            body: JSON.stringify(updatedData)
                        });

                        if (result.success) {
                            tr.classList.remove('editing');
                            nameTd.textContent   = updatedData.student_name;
                            schoolTd.textContent = updatedData.school_name || '';
                            phoneTd.textContent  = updatedData.phone_number || '';
                            ownerTd.textContent  = updatedData.phone_owner;
                            gradeTd.textContent  = updatedData.grade;
                            genderTd.textContent = updatedData.gender;
                            actionsTd.innerHTML  = `
                                <button type="button" class="btn btn-primary btn-sm edit-btn"><i class="fas fa-edit"></i></button>
                                <button type="button" class="btn btn-danger btn-sm delete-btn"><i class="fas fa-trash"></i></button>
                            `;
                            tr.querySelector('.edit-btn').addEventListener('click', editHandler);
                            tr.querySelector('.delete-btn').addEventListener('click', deleteHandler);

                            const idx = existingStudents.findIndex(s => s.student_id == studentId);
                            if (idx > -1) {
                                existingStudents[idx] = {
                                    ...existingStudents[idx],
                                    student_name: updatedData.student_name,
                                    school_name:  updatedData.school_name,
                                    phone_number: updatedData.phone_number,
                                    phone_owner:  updatedData.phone_owner,
                                    grade:        updatedData.grade,
                                    gender:       updatedData.gender
                                };
                            }
                            updateStudentStats(existingStudents);
                        } else {
                            alert(`ìˆ˜ì • ì‹¤íŒ¨: ${result.message||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                            actionsTd.innerHTML= `
                                <button type="button" class="btn btn-success btn-sm save-edit-btn"><i class="fas fa-check"></i></button>
                                <button type="button" class="btn btn-outline btn-sm cancel-edit-btn"><i class="fas fa-times"></i></button>
                            `;
                            actionsTd.querySelector('.save-edit-btn').addEventListener('click', saveHandler);
                            actionsTd.querySelector('.cancel-edit-btn').addEventListener('click', cancelHandler);
                        }
                    } catch(err) {
                        alert(`ì˜¤ë¥˜ ë°œìƒ: ${err.message}`);
                        actionsTd.innerHTML= `
                            <button type="button" class="btn btn-success btn-sm save-edit-btn"><i class="fas fa-check"></i></button>
                            <button type="button" class="btn btn-outline btn-sm cancel-edit-btn"><i class="fas fa-times"></i></button>
                        `;
                        actionsTd.querySelector('.save-edit-btn').addEventListener('click', saveHandler);
                        actionsTd.querySelector('.cancel-edit-btn').addEventListener('click', cancelHandler);
                    }
                };

                actionsTd.querySelector('.save-edit-btn').addEventListener('click', saveHandler);
                actionsTd.querySelector('.cancel-edit-btn').addEventListener('click', cancelHandler);
            };

            tr.innerHTML = `
                <td data-field="student_name">${student.student_name || ''}</td>
                <td data-field="school_name">${student.school_name || ''}</td>
                <td data-field="phone_number">${student.phone_number || ''}</td>
                <td data-field="phone_owner" style="text-align:center;">${student.phone_owner || 'í•™ìƒ'}</td>
                <td data-field="grade" style="text-align:center;">${student.grade || ''}</td>
                <td data-field="gender" style="text-align:center;">${student.gender || ''}</td>
                <td class="actions">
                    <button type="button" class="btn btn-primary btn-sm edit-btn"><i class="fas fa-edit"></i></button>
                    <button type="button" class="btn btn-danger btn-sm delete-btn"><i class="fas fa-trash"></i></button>
                </td>
            `;

            tr.querySelector('.edit-btn').addEventListener('click', editHandler);
            tr.querySelector('.delete-btn').addEventListener('click', deleteHandler);

            studentTbody.appendChild(tr);
        });
    };

    /* 8. ì—°ë„ ë°”ë€Œë©´ ë¡œë”© ë‹¤ì‹œ */
    yearSelect.addEventListener('change', loadStudentList);

    /* 9. ì²« ë¡œë”© */
    loadStudentList();

    /* 10. ëª…ë‹¨ ì¶”ê°€ (POST bulk-add) */
    addStudentsBtn.addEventListener('click', async () => {
        const rows = addStudentTbody.querySelectorAll('tr');
        if (rows.length === 0) {
            alert('ì¶”ê°€í•  í•™ìƒ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        showMessage(addMessageEl, 'ëª…ë‹¨ ì¶”ê°€ ì²˜ë¦¬ ì¤‘...', 'info');
        addStudentsBtn.disabled = true;

        const studentsToAdd = [];
        let isValid = true;
        const potentialDuplicates = [];
        const selectedYear = yearSelect.value;

        rows.forEach(tr => {
            const nameInput   = tr.querySelector('input[name="student_name"]');
            const schoolInput = tr.querySelector('input[name="school_name"]');
            const phoneInput  = tr.querySelector('input[name="phone_number"]');
            const ownerSelect = tr.querySelector('select[name="phone_owner"]');
            const gradeSelect = tr.querySelector('select[name="grade"]');
            const genderSelect= tr.querySelector('select[name="gender"]');

            const name   = nameInput?.value.trim() || '';
            const school = schoolInput?.value.trim() || null;
            const phone  = phoneInput?.value.trim() || null;
            const owner  = ownerSelect?.value || 'í•™ìƒ';
            const grade  = gradeSelect?.value || '';
            const gender = genderSelect?.value || '';

            if (!name) {
                isValid = false;
                if (nameInput) nameInput.style.borderColor = 'red';
            } else {
                if (nameInput) nameInput.style.borderColor = '';
            }

            if (name) {
                const studentData = {
                    student_name: name,
                    school_name:  school,
                    phone_number: phone,
                    phone_owner:  owner,
                    grade:        grade,
                    gender:       gender
                };
                studentsToAdd.push(studentData);

                const isDuplicate = existingStudents.some(existing => existing.student_name === name);
                if (isDuplicate) {
                    potentialDuplicates.push(name);
                }
            }
        });

        if (!isValid) {
            showMessage(addMessageEl, 'í•™ìƒ ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.', 'error');
            addStudentsBtn.disabled = false;
            return;
        }

        if (studentsToAdd.length === 0) {
            showMessage(addMessageEl, 'ì¶”ê°€í•  ìœ íš¨í•œ í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            addStudentsBtn.disabled = false;
            return;
        }

        if (potentialDuplicates.length > 0) {
            const uniqueDuplicateNames = [...new Set(potentialDuplicates)];
            const confirmationMessage =
                `ë‹¤ìŒ í•™ìƒ(ë“¤)ì€ ì´ë¯¸ ëª©ë¡ì— ìˆëŠ” ì´ë¦„ê³¼ ê°™ìŠµë‹ˆë‹¤:\n\n[ ${uniqueDuplicateNames.join(', ')} ]\n\nê·¸ë˜ë„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë™ëª…ì´ì¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`;
            if (!confirm(confirmationMessage)) {
                showMessage(addMessageEl, 'ëª…ë‹¨ ì¶”ê°€ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                addStudentsBtn.disabled = false;
                return;
            }
        }

        try {
            const data = await apiCall(`${SVR_JUNGSI}/jungsi/students/bulk-add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ í•™ë…„ë„: selectedYear, students: studentsToAdd })
            });

            if (data.success) {
                let successMsg = `ì´ ${data.insertedCount || 0}ëª…ì˜ í•™ìƒì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`;
                if (data.errors && data.errors.length > 0) {
                    successMsg += ` (${data.errors.length}ëª… ì˜¤ë¥˜ ë°œìƒ)`;
                    console.warn('ì¶”ê°€ ì˜¤ë¥˜ ë°œìƒ í•™ìƒ:', data.errors);
                }
                showMessage(addMessageEl, successMsg, 'success');

                // ì…ë ¥ í–‰ ë¹„ìš°ê³  ìƒˆ ë¹ˆ í–‰ í•˜ë‚˜ë§Œ ë‚¨ê¸°ê¸°
                addStudentTbody.innerHTML = '';
                addStudentInputRow();

                // ê¸°ì¡´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadStudentList();
            } else {
                showMessage(addMessageEl, `ëª…ë‹¨ ì¶”ê°€ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜'}`, 'error');
            }
        } catch (err) {
            console.error('ëª…ë‹¨ ì¶”ê°€ API í˜¸ì¶œ ì˜¤ë¥˜:', err);
            showMessage(addMessageEl, `ì˜¤ë¥˜ ë°œìƒ: ${err.message}`, 'error');
        } finally {
            addStudentsBtn.disabled = false;
        }
    });
});
</script>

</body>
</html>
