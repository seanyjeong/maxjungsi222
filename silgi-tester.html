<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ê¸° ì ìˆ˜ ê³„ì‚° í…ŒìŠ¤í„° (U_ID: 3)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .control-group { margin-bottom: 20px; padding: 15px; background: #fafafa; border-radius: 6px; border: 1px solid #eee; }
        .control-group label { font-weight: bold; margin-right: 10px; font-size: 14px; display: inline-block; min-width: 100px; }
        .control-group input[type="text"], .control-group select, .control-group input[type="number"], .control-group input[type="password"] { /* Added password type */
            padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-right: 10px; width: 150px;
        }
        button {
            padding: 10px 20px; font-size: 16px; font-weight: bold; color: #fff; border: none; border-radius: 4px; cursor: pointer; background-color: #007bff;
        }
        button:hover { background-color: #0056b3; }

        #resultArea { margin-top: 30px; background: #e9ecef; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6; }
        #resultArea h2 { margin-top: 0; }
        #calculationLog { white-space: pre-wrap; font-family: monospace; font-size: 13px; max-height: 400px; overflow-y: auto; background: #fff; padding: 10px; border: 1px solid #ccc; }
        .note { font-size: 12px; color: #666; margin-top: 10px; }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
        .hidden { display: none !important; }

        /* Login Modal Styles */
        #loginModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        #loginBox {
            background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 300px;
        }
        #loginBox h2 { margin-top: 0; }
        #loginBox input { width: 93%; margin-bottom: 15px; }
        #loginBox button { width: 100%; }
        #loginMessage { color: #dc3545; font-size: 14px; margin-top: 10px; height: 20px; }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div id="loginModal" class="hidden">
        <div id="loginBox">
            <h2>í…ŒìŠ¤í„° ë¡œê·¸ì¸</h2>
            <form id="loginForm">
                <label for="loginId">ì•„ì´ë””:</label>
                <input type="text" id="loginId" required>
                <label for="loginPw">ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="loginPw" required>
                <button type="submit" style="background-color: #007bff;">ë¡œê·¸ì¸</button>
                <div id="loginMessage"></div>
            </form>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <h1>ì‹¤ê¸° ì ìˆ˜ ê³„ì‚° í…ŒìŠ¤í„° (U_ID: 3)</h1>

        <div class="control-group">
            <label for="uid">U_ID:</label>
            <input type="text" id="uid" value="3" disabled>
        </div>
        <div class="control-group">
            <label for="year">í•™ë…„ë„:</label>
            <input type="text" id="year" value="2026" disabled> </div>
        <div class="control-group">
            <label for="gender">ì„±ë³„:</label>
            <select id="gender">
                <option value="ë‚¨">ë‚¨</option>
                <option value="ì—¬">ì—¬</option>
            </select>
        </div>

        <h2>ì‹¤ê¸° ê¸°ë¡ ì…ë ¥</h2>
        <div id="practicalInputs">
            <p class="note">ë¡œê·¸ì¸ í›„ ì‹¤ê¸° ì¢…ëª©ì´ ë¡œë“œë©ë‹ˆë‹¤.</p>
            </div>

        <button id="calculateButton">ì ìˆ˜ ê³„ì‚°í•˜ê¸°</button>

        <div id="resultArea" style="display: none;">
            <h2>ê³„ì‚° ê²°ê³¼</h2>
            <p><strong>ìµœì¢… í•©ì‚° ì ìˆ˜ (ìˆ˜ëŠ¥+ì‹¤ê¸°): <span id="totalScore" class="success"></span></strong></p>
            <p>ìˆ˜ëŠ¥ ë°˜ì˜ ì ìˆ˜: <span id="suneungPart"></span></p>
            <p>ì‹¤ê¸° ë°˜ì˜ ì ìˆ˜: <span id="practicalPart"></span></p>
            <h3>ê³„ì‚° ë¡œê·¸</h3>
            <div id="calculationLog"></div>
        </div>
        <p id="errorMessage" class="error"></p>

    </div>

    <script>
        const JUNGSI_API_URL = 'https://supermax.kr/jungsi';
        // ğŸš¨ ë„¤ 26susi ë¡œê·¸ì¸ API ì£¼ì†Œë¡œ ìˆ˜ì •!
        const LOGIN_API_URL = 'https://supermax.kr/26susi/login'; 
        const TOKEN_STORAGE_KEY = 'jungsi_tester_jwt_token'; // ì—ë””í„°ì™€ ë‹¤ë¥¸ í‚¤ ì‚¬ìš©

        // í† í° ê´€ë¦¬ í•¨ìˆ˜
        const getToken = () => localStorage.getItem(TOKEN_STORAGE_KEY);
        const setToken = (token) => localStorage.setItem(TOKEN_STORAGE_KEY, token);
        const removeToken = () => localStorage.removeItem(TOKEN_STORAGE_KEY);

        // UI ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜
        function showLoginModal() {
            $('#loginModal').removeClass('hidden');
            $('#mainContainer').hide();
        }
        function showApp() {
            $('#loginModal').addClass('hidden');
            $('#mainContainer').show();
        }

        // ì¸ì¦ëœ fetch í•¨ìˆ˜
        async function fetchWithAuth(url, options = {}) {
            const token = getToken();
            if (!token) {
                showLoginModal(); // í† í° ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ì°½ìœ¼ë¡œ
                throw new Error('ì¸ì¦ í† í° ì—†ìŒ');
            }
            const headers = { ...(options.headers || {}), 'Authorization': `Bearer ${token}` };
            try {
                const response = await fetch(url, { ...options, headers });
                if (response.status === 401 || response.status === 403) {
                    removeToken(); // ì˜ëª»ëœ í† í° ì‚­ì œ
                    showLoginModal(); // ë¡œê·¸ì¸ ì°½ìœ¼ë¡œ
                    throw new Error('ì¸ì¦ ì‹¤íŒ¨ ë˜ëŠ” í† í° ë§Œë£Œ');
                }
                return response;
            } catch (error) {
                $('#errorMessage').text(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
                throw error;
            }
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
        async function handleLogin(event) {
            event.preventDefault();
            const id = $('#loginId').val();
            const pw = $('#loginPw').val();
            const loginMessage = $('#loginMessage');
            loginMessage.text('ë¡œê·¸ì¸ ì¤‘...');

            try {
                const res = await fetch(LOGIN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userid: id, password: pw }) // â­ï¸ body í‚¤ í™•ì¸!
                });
                const data = await res.json();
                if (data.success && data.token) {
                    loginMessage.text('âœ… ë¡œê·¸ì¸ ì„±ê³µ!');
                    setToken(data.token); // Bearer ì—†ì´ ì €ì¥
                    setTimeout(() => {
                        showApp();
                        loadPracticalEvents(); // ë¡œê·¸ì¸ ì„±ê³µ í›„ ì¢…ëª© ë¡œë“œ
                    }, 500);
                } else {
                    loginMessage.text(data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
                }
            } catch (err) {
                loginMessage.text('ë¡œê·¸ì¸ ì„œë²„ ì ‘ì† ì‹¤íŒ¨.');
            }
        }

        // ì‹¤ê¸° ì¢…ëª© ë¡œë“œ ë° Input ìƒì„±
        async function loadPracticalEvents() {
            const U_ID = $('#uid').val();
            const year = $('#year').val();
            const practicalInputsDiv = $('#practicalInputs');
            practicalInputsDiv.html('<p>ì‹¤ê¸° ì¢…ëª© ë¡œë”© ì¤‘...</p>');

            try {
                const response = await fetchWithAuth(`${JUNGSI_API_URL}/practical-scores/${U_ID}/${year}`);
                const data = await response.json();

                if (data.success && data.scores && data.scores.length > 0) {
                    const eventNames = [...new Set(data.scores.map(s => s.ì¢…ëª©ëª…))];
                    practicalInputsDiv.empty();
                    eventNames.forEach(eventName => {
                        const group = $('<div class="control-group"></div>');
                        const label = $(`<label for="event_${eventName}">${eventName}:</label>`);
                        const input = $(`<input type="text" id="event_${eventName}" data-event-name="${eventName}" placeholder="ê¸°ë¡ ì…ë ¥">`);
                        group.append(label).append(input);
                        practicalInputsDiv.append(group);
                    });
                } else if (data.success) {
                    practicalInputsDiv.html('<p class="note">ì‹¤ê¸° ë°°ì í‘œ ë°ì´í„° ì—†ìŒ.</p>');
                } else {
                    practicalInputsDiv.html(`<p class="error">ì‹¤ê¸° ì¢…ëª© ë¡œë“œ ì‹¤íŒ¨: ${data.message}</p>`);
                }
            } catch (error) {
                // fetchWithAuthì—ì„œ ì—ëŸ¬ ì²˜ë¦¬
                 practicalInputsDiv.html(`<p class="error">ì‹¤ê¸° ì¢…ëª© ë¡œë“œ ì¤‘ ì˜¤ë¥˜.</p>`);
            }
        }
        
        // ê³„ì‚° ì‹¤í–‰ í•¨ìˆ˜
        async function calculateScore() {
            const U_ID = $('#uid').val();
            const year = $('#year').val();
            const gender = $('#gender').val();
            
            const practicals = [];
            $('#practicalInputs input').each(function() {
                const eventName = $(this).data('event-name');
                const value = $(this).val().trim();
                if (value !== '') {
                    practicals.push({ event: eventName, value: value });
                }
            });

            const studentScoresPayload = {
                gender: gender,
                practicals: practicals,
                subjects: [] // ìˆ˜ëŠ¥ ì ìˆ˜ ì—†ìŒ
            };

             $('#errorMessage').text('');
             $('#resultArea').hide();
             $('#calculateButton').text('ê³„ì‚° ì¤‘...').prop('disabled', true);

            try {
                const response = await fetchWithAuth(`${JUNGSI_API_URL}/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ U_ID, year, studentScores: studentScoresPayload })
                });
                const data = await response.json();

                if (data.success) {
                    $('#totalScore').text(data.result.totalScore);
                    $('#suneungPart').text(data.result.suneungPart);
                    $('#practicalPart').text(data.result.practicalPart);
                    $('#calculationLog').text(data.result.calculationLog.join('\n'));
                    $('#resultArea').show();
                } else {
                     $('#errorMessage').text(`ê³„ì‚° ì‹¤íŒ¨: ${data.message}`);
                }
            } catch (error) {
                // fetchWithAuthì—ì„œ ì—ëŸ¬ ì²˜ë¦¬
            } finally {
                 $('#calculateButton').text('ì ìˆ˜ ê³„ì‚°í•˜ê¸°').prop('disabled', false);
            }
        }

        $(document).ready(function() {
            // ë¡œê·¸ì¸ í¼ ë¦¬ìŠ¤ë„ˆ
            $('#loginForm').on('submit', handleLogin);
            // ê³„ì‚° ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
            $('#calculateButton').on('click', calculateScore);

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
            if (getToken()) {
                showApp();
                loadPracticalEvents(); // í† í° ìˆìœ¼ë©´ ë°”ë¡œ ì¢…ëª© ë¡œë“œ
            } else {
                showLoginModal();
            }
        });

    </script>
</body>
</html>