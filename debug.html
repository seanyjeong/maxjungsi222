<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì •ì‹œ ê³„ì‚° ì—”ì§„ ë””ë²„ê±°</title>
  <style>
    body { font-family: sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h1 { color: #333; }
    .controls { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    button { background-color: #dc3545; color: white; padding: 12px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 700; }
    button:hover { background-color: #c82333; }
    #results-container { margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; }

    /* í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .filter-group { display: flex; gap: 5px; border: 1px solid #ccc; border-radius: 8px; padding: 4px; }
    .filter-group button {
      background-color: #f8f9fa;
      color: #333;
      padding: 8px 14px;
      font-size: 0.9em;
      font-weight: 500;
      border: 1px solid transparent;
    }
    .filter-group button:hover { background-color: #e2e6ea; }
    .filter-group button.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,.25);
    }
    /* â–¼â–¼â–¼ [ì¶”ê°€] í•„í„° ê°œìˆ˜ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .filter-count {
      margin-left: 6px;
      background-color: #e9ecef;
      color: #495057;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.9em;
    }
    button.active .filter-count {
      background-color: #fff;
      color: #007bff;
    }

    .result-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: #fff;
      transition: background-color 0.3s;
    }
    .result-card.correct { background: #e7f1ff; }   /* íŒŒë‘ê³„ì—´ */
    .result-card.incorrect { background: #fdecea; } /* ë¶‰ì€ê³„ì—´ */

    .result-card h3 { background-color: #f8f9fa; padding: 10px 15px; margin: 0; font-size: 1.05em; border-bottom: 1px solid #ddd; display:flex; justify-content:space-between; gap:10px; }
    .total-score { font-size: 2em; font-weight: bold; color: #007bff; text-align: center; padding: 14px; }
    .breakdown-table { width: 100%; border-collapse: collapse; }
    .breakdown-table td { padding: 6px 12px; border-top: 1px solid #eee; }
    .breakdown-table td:first-child { font-weight: bold; }
    .breakdown-table td:last-child { text-align: right; }
    .message { margin-top: 15px; font-weight: bold; min-height: 20px; padding: 10px; border-radius: 4px; }
    .message.info { color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; }

    /* ê³„ì‚° ë¡œê·¸ */
    .calculation-log { background-color: #272822; color: #f8f8f2; padding: 12px; font-family: ui-monospace, Menlo, monospace; font-size: 12px; white-space: pre-wrap; word-break: break-word; border-radius: 0 0 10px 10px; }
    .calculation-log h4 { margin: 0 0 10px 0; color: #a6e22e; border-bottom: 1px solid #555; padding-bottom: 5px; }

    /* íŒì • & ë©”ëª¨ UI */
    .judge { display: flex; align-items: center; gap: 12px; padding: 10px 15px; border-top: 1px solid #eee; }
    .judge .status { display: flex; gap: 8px; }
    .judge textarea { width: 100%; min-height: 70px; resize: vertical; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em; }
    .judge .row { display: flex; flex-direction: column; gap: 8px; width: 100%; }
    .small { font-size: 0.85em; color: #666; }
    .save-row { display:flex; justify-content: flex-end; gap:10px; align-items:center; padding: 8px 15px; border-top: 1px dashed #eee; }
    .badge { padding:2px 8px; border-radius:999px; background:#eee; font-size: 12px; }
    .badge.ok { background:#e7f7ee; color:#0f5132; }
    .badge.ng { background:#fdecea; color:#842029; }
    .badge.unknown { background:#eef1ff; color:#1d3c78; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ì •ì‹œ ê³„ì‚° ì—”ì§„ ë””ë²„ê±°</h1>
    <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ë¯¸ë¦¬ ì…ë ¥ëœ í•™ìƒ ì ìˆ˜ë¡œ 'ê·œì¹™ì´ ì €ì¥ëœ ëª¨ë“  í•™êµ'ì˜ ê³„ì‚° ê²°ê³¼ë¥¼ í•œ ë²ˆì— í™•ì¸í•˜ê³ , <b>ë§ëŠ”ì§€/í‹€ë¦°ì§€ íŒì • + ë©”ëª¨</b>ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <div class="controls">
      <button id="run-debug-btn">ğŸ”´ ë””ë²„ê¹… ì‹œì‘</button>
      <div id="filter-controls" class="filter-group">
        <button data-filter="all" class="active">ì „ì²´ <span class="filter-count" id="count-all">0</span></button>
        <button data-filter="Y">ë§ìŒ <span class="filter-count" id="count-Y">0</span></button>
        <button data-filter="N">í‹€ë¦¼ <span class="filter-count" id="count-N">0</span></button>
        <button data-filter="?">ë¯¸í™•ì¸ <span class="filter-count" id="count-?">0</span></button>
      </div>
      <label class="small">í•™ë…„ë„:
        <input id="year-input" type="number" min="2024" max="2030" value="2026" style="padding:6px 8px; border:1px solid #ccc; border-radius:6px;">
      </label>
    </div>
    <div id="message-area" class="message info hidden"></div>
    <div id="results-container"></div>
  </div>

  <script>
    const SVR_JUNGSI = 'https://supermax.kr';
    const resultsContainer = document.getElementById('results-container');
    const runBtn = document.getElementById('run-debug-btn');
    const messageArea = document.getElementById('message-area');
    const yearInput = document.getElementById('year-input');
    const filterControls = document.getElementById('filter-controls');

    let currentFilter = 'all'; // í˜„ì¬ í•„í„° ìƒíƒœ ì €ì¥

    const getToken = () => localStorage.getItem('jwt_token');

    const studentScoresForDebug = {
      "subjects": [
        { "name": "êµ­ì–´", "subject": "í™”ë²•ê³¼ì‘ë¬¸", "std": 124, "percentile": 88, "grade": 3 },
        { "name": "ìˆ˜í•™", "subject": "í™•ë¥ ê³¼í†µê³„", "std": 125, "percentile": 90, "grade": 2 },
        { "name": "ì˜ì–´", "grade": 2 },
        { "name": "í•œêµ­ì‚¬", "grade": 1 },
        { "name": "íƒêµ¬", "subject": "ì„¸ê³„ì‚¬", "std": 63, "percentile": 85, "grade": 3 },
        { "name": "íƒêµ¬", "subject": "ì •ì¹˜ì™€ë²•", "std": 64, "percentile": 91, "grade": 2 }
      ]
    };

    let notesMap = {}; // { U_ID: {is_correct, memo, updated_at} }

    // â–¼â–¼â–¼ [ì¶”ê°€] í•„í„°ë³„ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateFilterCounts() {
      const cards = document.querySelectorAll('.result-card');
      let countY = 0;
      let countN = 0;
      let countUnknown = 0;

      cards.forEach(card => {
        if (card.classList.contains('correct')) {
          countY++;
        } else if (card.classList.contains('incorrect')) {
          countN++;
        } else {
          countUnknown++;
        }
      });

      document.getElementById('count-all').textContent = cards.length;
      document.getElementById('count-Y').textContent = countY;
      document.getElementById('count-N').textContent = countN;
      document.getElementById('count-?').textContent = countUnknown;
    }

    // í•„í„°ë§ ì ìš© í•¨ìˆ˜
    function applyFilter() {
      const cards = document.querySelectorAll('.result-card');
      cards.forEach(card => {
        let cardStatus = '?';
        if (card.classList.contains('correct')) cardStatus = 'Y';
        else if (card.classList.contains('incorrect')) cardStatus = 'N';

        if (currentFilter === 'all' || currentFilter === cardStatus) {
          card.style.display = 'flex';
        } else {
          card.style.display = 'none';
        }
      });
    }

    async function fetchDebugNotes(year) {
      const res = await fetch(`${SVR_JUNGSI}/jungsi/debug-notes?year=${year}`, {
        headers: { 'Authorization': `Bearer ${getToken()}` }
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'debug-notes ë¡œë”© ì‹¤íŒ¨');
      notesMap = data.notes || {};
    }

    async function saveDebugNote(U_ID, year, is_correct, memo) {
      const res = await fetch(`${SVR_JUNGSI}/jungsi/debug-notes/set`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` },
        body: JSON.stringify({ U_ID, year, is_correct, memo })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'debug-notes ì €ì¥ ì‹¤íŒ¨');
      return true;
    }

    function badgeForStatus(s) {
      if (s === 'Y') return '<span class="badge ok">ë§ìŒ</span>';
      if (s === 'N') return '<span class="badge ng">í‹€ë¦¼</span>';
      return '<span class="badge unknown">ë¯¸í™•ì¸</span>';
    }

    async function runDebugger() {
      const YEAR = parseInt(yearInput.value, 10) || 2026;
      messageArea.textContent = `[${YEAR}] ê·œì¹™ ë¡œë“œ ì¤‘...`;
      messageArea.className = 'message info';
      messageArea.classList.remove('hidden');
      resultsContainer.innerHTML = '';

      try {
        await fetchDebugNotes(YEAR);

        const res = await fetch(`${SVR_JUNGSI}/jungsi/schools/${YEAR}`, {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'í•™êµ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');

        const saved = data.schools.filter(s => s.ê³„ì‚°ìœ í˜• === 'íŠ¹ìˆ˜ê³µì‹' || s.selection_rules || s.bonus_rules || s.score_config);
        if (!saved.length) { messageArea.textContent = 'ê·œì¹™ ì €ì¥ëœ í•™êµ ì—†ìŒ.'; return; }

        messageArea.textContent = `${saved.length}ê°œ ê³„ì‚° ì¤‘...`;

        const results = await Promise.all(saved.map(school =>
          fetch(`${SVR_JUNGSI}/jungsi/calculate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` },
            body: JSON.stringify({ U_ID: school.U_ID, year: YEAR, studentScores: studentScoresForDebug })
          }).then(r => r.json())
        ));

        resultsContainer.innerHTML = '';
        saved.forEach((school, idx) => {
          const r = results[idx];
          const note = notesMap[school.U_ID] || { is_correct: '?', memo: '' };
          const cardClass = note.is_correct === 'Y' ? 'correct' : (note.is_correct === 'N' ? 'incorrect' : '');
          let html = `<div class="result-card ${cardClass}" data-uid="${school.U_ID}">
            <h3><span>[${school.U_ID}] ${school.ëŒ€í•™ëª…} - ${school.í•™ê³¼ëª…}</span>
            <span class="small">${badgeForStatus(note.is_correct)}</span></h3>`;

          if (r.success) {
            const calc = r.result;
            html += `<div class="total-score">${calc.totalScore}</div><table class="breakdown-table">`;
            for (const [k,v] of Object.entries(calc.breakdown)) {
              const val = (typeof v === 'number') ? v.toFixed(3) : (Number(v)||0).toFixed(3);
              html += `<tr><td>${k}</td><td>${val}</td></tr>`;
            }
            html += '</table>';
            html += `
              <div class="judge">
                <div class="row">
                  <div class="status">
                    <label><input type="radio" name="status-${school.U_ID}" value="Y" ${note.is_correct==='Y'?'checked':''}> ë§ìŒ</label>
                    <label><input type="radio" name="status-${school.U_ID}" value="N" ${note.is_correct==='N'?'checked':''}> í‹€ë¦¼</label>
                    <label><input type="radio" name="status-${school.U_ID}" value="?" ${note.is_correct==='?'?'checked':''}> ë¯¸í™•ì¸</label>
                  </div>
                  <textarea id="memo-${school.U_ID}" placeholder="ë©”ëª¨">${note.memo||''}</textarea>
                </div>
              </div>
              <div class="save-row">
                <span class="small">ìµœê·¼: ${note.updated_at ? new Date(note.updated_at).toLocaleString() : '-'}</span>
                <button data-action="save" data-uid="${school.U_ID}">ğŸ’¾ ì €ì¥</button>
              </div>`;
            if (calc.calculationLog)
              html += `<div class="calculation-log"><h4>ê³„ì‚° ê³¼ì •</h4>${calc.calculationLog.map(l=>l.replace(/</g,'&lt;')).join('\n')}</div>`;
          } else {
            html += `<p style="padding:20px;color:red;">ê³„ì‚° ì‹¤íŒ¨: ${r.message}</p>`;
          }
          html += '</div>';
          resultsContainer.insertAdjacentHTML('beforeend', html);
        });
        messageArea.textContent = 'ëª¨ë“  ê³„ì‚° ì™„ë£Œ âœ…';
        updateFilterCounts(); // <-- [ìˆ˜ì •] ê°œìˆ˜ ì—…ë°ì´íŠ¸
        applyFilter(); // ê³„ì‚° ì™„ë£Œ í›„ í•„í„° ì ìš©
      } catch (err) {
        alert(err.message);
      }
    }

    // ì €ì¥ ì´ë²¤íŠ¸
    resultsContainer.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action="save"]');
      if (!btn) return;
      const uid = btn.getAttribute('data-uid');
      const YEAR = parseInt(yearInput.value,10)||2026;
      const status = document.querySelector(`input[name="status-${uid}"]:checked`)?.value || '?';
      const memo = document.getElementById(`memo-${uid}`)?.value || '';
      btn.disabled = true; const prev = btn.textContent; btn.textContent = 'ì €ì¥ì¤‘...';
      try {
        await saveDebugNote(uid, YEAR, status, memo);
        
        const card = document.querySelector(`.result-card[data-uid="${uid}"]`);
        const header = card.querySelector('h3 .small');
        header.innerHTML = badgeForStatus(status);
        card.classList.remove('correct','incorrect');
        if (status==='Y') card.classList.add('correct');
        else if (status==='N') card.classList.add('incorrect');
        
        updateFilterCounts(); // <-- [ìˆ˜ì •] ê°œìˆ˜ ì—…ë°ì´íŠ¸
        applyFilter(); // ì €ì¥ í›„ í•„í„° ë‹¤ì‹œ ì ìš©

        btn.textContent='ì €ì¥ë¨ âœ”';
        setTimeout(()=>{btn.textContent=prev;btn.disabled=false;},800);
      } catch(err){alert('ì €ì¥ ì‹¤íŒ¨:'+err.message);btn.textContent=prev;btn.disabled=false;}
    });

    // í•„í„° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    filterControls.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-filter]');
      if (!btn) return;

      currentFilter = btn.getAttribute('data-filter');
      filterControls.querySelector('button.active').classList.remove('active');
      btn.classList.add('active');
      applyFilter();
    });

    runBtn.addEventListener('click', runDebugger);

    if (!getToken()) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ê·œì¹™ ì„¤ì • í˜ì´ì§€(/setting)ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
      messageArea.textContent='ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'; messageArea.classList.remove('hidden');
    }
  </script>
</body>
</html>