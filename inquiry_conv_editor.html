<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>탐구 변환표준점수 대량 편집기</title>
  <style>
    body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
    .wrap { max-width: 1100px; margin: 20px auto; background:#fff; padding:24px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 12px; }
    .row { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    select, input, textarea, button { font-size:14px; }
    select, input { padding:8px 10px; border:1px solid #ccc; border-radius:6px; }
    textarea { width:100%; min-height:280px; padding:12px; border:1px solid #ccc; border-radius:8px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    button { background:#007bff; color:#fff; border:none; border-radius:6px; padding:10px 14px; font-weight:700; cursor:pointer; }
    button.green { background:#28a745; }
    .msg { margin-top:12px; padding:10px; border-radius:6px; }
    .msg.ok { background:#e6ffed; color:#0f5132; border:1px solid #badbcc; }
    .msg.err{ background:#fdecea; color:#842029; border:1px solid #f5c2c7; }
    .hint { font-size:12px; color:#555; margin-bottom:8px; }
    .split { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .card { background:#fafafa; padding:12px; border-radius:8px; border:1px solid #eee; }
    .card h3 { margin:0 0 6px; font-size:15px; }
    .small { font-size:12px; color:#666; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>탐구 변환표준점수 대량 편집기</h1>

  <div class="row">
    <label>학년도
      <select id="year">
        <option value="2026">2026</option>
        <option value="2027">2027</option>
      </select>
    </label>

    <label>학교
      <select id="school-select" style="min-width:260px">
        <option value="">학년도를 먼저 선택하거나 잠시만…</option>
      </select>
    </label>

    <label>학과
      <select id="dept-select" style="min-width:320px">
        <option value="">학교를 먼저 선택하세요</option>
      </select>
    </label>

    <button id="btn-load-list">학교 목록 새로고침</button>
    <button id="btn-load" title="현재 저장된 변환표준점수 미리보기">불러오기</button>
    <button id="btn-save" class="green">저장</button>
  </div>

  <div class="hint">
    엑셀에서 <b>“백분위 / 사탐 / 과탐”</b> 3열을 그대로 복사해서 붙여넣으세요.<br>
    예시:<br>
    <code>백분위	사탐	과탐<br>100	69.89	70.13<br>99	68.81	69.38</code>
  </div>

  <div class="split">
    <div class="card">
      <h3>붙여넣기 (입력)</h3>
      <textarea id="bulk-text" placeholder="엑셀에서 백분위 / 사탐 / 과탐 열을 그대로 붙여넣기 하세요."></textarea>
      <div class="small">저장 성공 시 이 입력칸은 자동으로 비워집니다.</div>
    </div>

    <div class="card">
      <h3>현재 저장 내용 (미리보기)</h3>
      <textarea id="preview" readonly placeholder="불러오기를 누르면 이곳에 현재 저장된 변표가 표시됩니다."></textarea>
    </div>
  </div>

  <div id="msg" class="msg" style="display:none;"></div>
</div>

<script>
const SVR = 'https://supermax.kr';
const getToken = () => localStorage.getItem('jwt_token');

const yearEl   = document.getElementById('year');
const schoolEl = document.getElementById('school-select');
const deptEl   = document.getElementById('dept-select');
const bulkEl   = document.getElementById('bulk-text');
const prevEl   = document.getElementById('preview');
const msgEl    = document.getElementById('msg');

let schoolData = []; // [{U_ID, 대학명, 학과명}, ...]
let schoolsByUniversity = new Map(); // 대학명 -> [rows]

function showMsg(ok, text){
  msgEl.style.display='block';
  msgEl.className = 'msg ' + (ok ? 'ok':'err');
  msgEl.textContent = text;
}

async function fetchSchools(){
  const year = yearEl.value;
  try{
    schoolEl.innerHTML = `<option value="">로딩중…</option>`;
    deptEl.innerHTML = `<option value="">학교를 먼저 선택하세요</option>`;

    const res = await fetch(`${SVR}/jungsi/schools/${year}`, {
      headers: {'Authorization': `Bearer ${getToken()}`}
    });
    const data = await res.json();
    if (!data.success) {
      showMsg(false, data.message || '학교 목록을 불러오지 못했습니다.');
      return;
    }
    // 필요한 필드만 추림
    schoolData = data.schools.map(r => ({
      U_ID: r.U_ID,
      대학명: r.대학명,
      학과명: r.학과명
    }));

    // 대학명 기준 그룹
    schoolsByUniversity = new Map();
    for (const row of schoolData) {
      if (!schoolsByUniversity.has(row.대학명)) schoolsByUniversity.set(row.대학명, []);
      schoolsByUniversity.get(row.대학명).push(row);
    }

    // 대학명 셀렉트 채우기
    const unis = Array.from(schoolsByUniversity.keys()).sort((a,b)=>a.localeCompare(b,'ko'));
    schoolEl.innerHTML = `<option value="">학교 선택</option>` + unis.map(u=>`<option value="${u}">${u}</option>`).join('');

    showMsg(true, `[${year}] 학교 목록 ${schoolData.length}건 불러옴`);
  }catch(e){
    console.error(e);
    showMsg(false, '서버 통신 오류(학교 목록)');
  }
}

function onUniversityChange(){
  const uni = schoolEl.value;
  prevEl.value = ''; // 학교/학과 바꾸면 미리보기 초기화
  if (!uni){
    deptEl.innerHTML = `<option value="">학교를 먼저 선택하세요</option>`;
    return;
  }
  const rows = (schoolsByUniversity.get(uni) || []).slice().sort((a,b)=>a.학과명.localeCompare(b.학과명,'ko'));
  deptEl.innerHTML = `<option value="">학과 선택</option>` + rows.map(r=>`<option value="${r.U_ID}">${r.학과명}</option>`).join('');
}

async function loadConvPreview(){
  const year = yearEl.value;
  const U_ID = deptEl.value;
  if (!U_ID){ showMsg(false, '학과를 선택하세요.'); return; }
  prevEl.value = '로딩중…';
  try{
    const res = await fetch(`${SVR}/jungsi/inquiry-conv/${U_ID}/${year}`, {
      headers: {'Authorization': `Bearer ${getToken()}`}
    });
    const data = await res.json();
    if (!data.success){ showMsg(false, data.message || '미리보기 로드 실패'); return; }

    let out = '';
    for (const kind of ['사탐','과탐']){
      const m = data.mappings?.[kind] || {};
      const keys = Object.keys(m).map(k=>parseInt(k,10)).filter(n=>!isNaN(n)).sort((a,b)=>b-a);
      if (!keys.length) continue;
      out += `# ${kind}\n`;
      for (const p of keys){ out += `${kind}\t${p}\t${m[String(p)]}\n`; }
      out += '\n';
    }
    prevEl.value = out || '(저장된 변표가 없습니다)';
    showMsg(true, '불러오기 완료');
  }catch(e){
    console.error(e);
    showMsg(false, '서버 통신 오류(미리보기)');
  }
}

async function saveData(){
  const year = yearEl.value;
  const U_ID = deptEl.value;
  if (!U_ID){ showMsg(false, '학과를 선택하세요.'); return; }

  // 입력 3열(백분위/사탐/과탐) → 서버 포맷(사탐 pct score / 과탐 pct score)으로 변환
  const raw = bulkEl.value.trim();
  if (!raw){ showMsg(false, '붙여넣을 데이터가 비었습니다.'); return; }

  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const outLines = [];
  for (const line of lines) {
    const parts = line.split(/\t|,|\s+/).filter(Boolean);
    if (!parts.length) continue;
    if (parts[0] === '백분위') continue; // 헤더 스킵
    if (parts.length < 3) continue;

    const pct   = parts[0];
    const satam = parts[1];
    const gatam = parts[2];

    if (!isNaN(Number(satam))) outLines.push(`사탐\t${pct}\t${satam}`);
    if (!isNaN(Number(gatam))) outLines.push(`과탐\t${pct}\t${gatam}`);
  }
  const convertedText = outLines.join('\n');
  if (!convertedText){ showMsg(false, '유효한 데이터가 없습니다. (열 수/숫자 확인)'); return; }

  try{
    const res = await fetch(`${SVR}/jungsi/inquiry-conv/bulk-save`,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`},
      body: JSON.stringify({ year, U_ID, rows_text: convertedText })
    });
    const data = await res.json();
    const ok = !!data.success;
    showMsg(ok, data.message || (ok?'저장 성공':'저장 실패'));

    if (ok){
      // ✅ 저장 성공 시 입력 textarea 비우기
      bulkEl.value = '';
      // 미리보기 갱신
      await loadConvPreview();
    }
  }catch(e){
    console.error(e);
    showMsg(false, '서버 통신 오류(저장)');
  }
}

/* 이벤트 바인딩 */
document.getElementById('btn-load-list').addEventListener('click', fetchSchools);
schoolEl.addEventListener('change', onUniversityChange);
yearEl.addEventListener('change', fetchSchools);
document.getElementById('btn-load').addEventListener('click', loadConvPreview);
document.getElementById('btn-save').addEventListener('click', saveData);

/* 초기 로드 */
if (!getToken()) {
  alert('로그인이 필요합니다. /setting 에서 로그인해주세요.');
}
fetchSchools();
</script>
</body>
</html>
