<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ì •ì‹œ ëŒ€í•™ë³„ ì ìˆ˜ í˜„í™©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --info-color: #3b82f6;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light-bg); padding: 20px; margin: 0; line-height: 1.5; font-size: 13px; }
        .container { max-width: 98%; margin: 0 auto; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 16px; }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .chip { display: inline-flex; align-items: center; gap: 6px; background: var(--light-bg); padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .chip label { font-size: .9rem; color: var(--text-secondary); white-space: nowrap; }
        select { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; font-size: .9rem; min-width: 140px; }
        .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; border: none; border-radius: 6px; font-weight: 500; font-size: .85rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
         .btn-success { background: var(--success-color); color: #fff; }
         .btn-success:disabled { background: #a7f3d0; color: #065f46; cursor: not-allowed;}
         /* â­ï¸ ì œì™¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
         .btn-danger { background: var(--danger-color); color: #fff; }
         .btn-danger:hover { background: #dc2626; }


        /* Student info */
        .student-info-card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 12px 16px; margin-bottom: 16px; }
        .student-basic-info { display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 8px; font-size: 1.05rem; }
        .student-basic-info .info-item i { color: var(--text-secondary); margin-right: 5px; }
        .student-basic-info strong { font-weight: 600; }
        .student-scores-info { display: flex; flex-wrap: wrap; gap: 8px 12px; font-size: .9rem; color: var(--text-secondary); padding-top: 8px; border-top: 1px dashed var(--border-color); }
        .score-item { background: #f8fafc; padding: 3px 8px; border-radius: 4px; border: 1px solid var(--border-color); }
        .grade-emphasis { font-weight: 700; color: var(--primary-color); font-size: 1.05em; margin: 0 2px; }

        /* Filter/Search */
        .filter-search-bar { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; background: var(--card-bg); padding: 12px 16px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 16px; }
        .filter-buttons { display: flex; gap: 8px; }
        .filter-buttons .btn { background: #fff; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 10px; font-size: 0.85rem; }
        .filter-buttons .btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: 600; }
        .search-input { display: flex; align-items: center; gap: 6px; border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 10px; background: #fff; }
        .search-input i { color: var(--text-secondary); font-size: 0.9rem; }
        .search-input input { border: none; outline: none; font-size: 0.9rem; padding: 2px 0; width: 200px; }


        /* Table */
        .table-container { overflow-x: auto; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 10px; border-bottom: 1px solid var(--border-color); text-align: center; white-space: nowrap; font-size: 0.85rem; }
        th { background: #f8fafc; font-weight: 600; color: var(--text-secondary); position: sticky; top: 0; z-index: 1;}
        tbody tr:hover { background-color: #f0f9ff; }
        td.uni-dept { text-align: left; white-space: normal; min-width: 150px;}
        td.uni-dept strong { font-weight: 600; color: var(--text-primary); display: block;}
        td.uni-dept span { font-size: 0.9em; color: var(--text-secondary);}
        td.top-score strong { color: var(--info-color); }
        td.my-score strong { color: var(--primary-color); font-size: 1.1em;}
        .loading-row td { text-align: center; padding: 40px; color: var(--text-secondary); font-style: italic; }
        .status-o { color: var(--success-color); font-weight: 600;}
        .status-x { color: var(--danger-color); font-weight: 600;}
        .status-semo { color: var(--warning-color); font-weight: 600;}
         /* â­ï¸ ì¶”ê°€/ì œì™¸ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .action-buttons { display: flex; gap: 4px; justify-content: center; }

        /* Toast Popup */
        .toast-popup { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px; font-size: .9rem; z-index: 1000; opacity: 0; transition: opacity .5s ease; white-space: nowrap; }
        .toast-popup.show { opacity: 1; }
        .toast-popup.error { background-color: rgba(220, 38, 38, 0.9); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-university"></i> ì •ì‹œ ëŒ€í•™ë³„ ì ìˆ˜ í˜„í™©</h1>
        <div class="header-controls">
            <div class="chip"> <label for="student-select"><i class="fas fa-user-graduate"></i> í•™ìƒ</label> <select id="student-select"><option value="">- í•™ìƒ ì„ íƒ -</option></select> </div>
            <div class="chip"> <label for="year-select"><i class="fas fa-calendar-alt"></i> í•™ë…„ë„</label> <select id="year-select"> <option value="2026">2026</option> <option value="2027">2027</option> </select> </div>
        </div>
    </div>

    <div id="student-info-container" class="student-info-card" style="display:none;">
         <div class="student-basic-info"> <span class="info-item"><i class="fas fa-user-circle"></i> <strong id="selected-student-name">-</strong></span> <span class="info-item"><i class="fas fa-school"></i> <span id="selected-school-name">-</span></span> <span class="info-item"><i class="fas fa-venus-mars"></i> <span id="selected-gender">-</span></span> </div>
         <div class="student-scores-info"> <span class="score-item" id="score-hist">í•œêµ­ì‚¬: -</span> <span class="score-item" id="score-kor">êµ­ì–´: -</span> <span class="score-item" id="score-math">ìˆ˜í•™: -</span> <span class="score-item" id="score-eng">ì˜ì–´: -</span> <span class="score-item" id="score-inq1">íƒêµ¬1: -</span> <span class="score-item" id="score-inq2">íƒêµ¬2: -</span> </div>
    </div>

    <div class="filter-search-bar">
        <div class="filter-buttons">
            <button class="btn active" data-gun-filter="all">ì „ì²´</button>
            <button class="btn" data-gun-filter="ê°€">ê°€êµ°</button>
            <button class="btn" data-gun-filter="ë‚˜">ë‚˜êµ°</button>
            <button class="btn" data-gun-filter="ë‹¤">ë‹¤êµ°</button>
        </div>
        <div class="search-input">
            <i class="fas fa-search"></i>
            <input type="search" id="search-input" placeholder="ëŒ€í•™, í•™ê³¼, ì§€ì—­ ë“± ê²€ìƒ‰...">
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ì§€ì—­</th>
                    <th>ëŒ€í•™/í•™ê³¼</th>
                    <th>êµì§</th>
                    <th>ëª¨ì§‘ì¸ì›</th>
                    <th>ìˆ˜ëŠ¥%</th>
                    <th>ë‚´ì‹ %</th>
                    <th>ì‹¤ê¸°%</th>
                    <th>1ë‹¨ê³„?</th>
                    <th>ë‚´ ì ìˆ˜(ìˆ˜ëŠ¥)</th>
                    <th>ìƒìœ„ 10%(ìˆ˜ëŠ¥)</th>
                    <th>ìˆ˜ëŠ¥ì»·(ì§€ì )</th>
                    <th>ìˆ˜ëŠ¥ì»·(ë§¥ìŠ¤)</th>
                    <th>ìƒë‹´ ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="university-tbody">
                <tr class="loading-row"><td colspan="13">í•™ìƒê³¼ í•™ë…„ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SVR_JUNGSI = 'https://supermax.kr';
    const LOGIN_PAGE = 'jungsilogin.html';
    const yearSelect = document.getElementById('year-select');
    const studentSelect = document.getElementById('student-select');
    const tbody = document.getElementById('university-tbody');
    const studentInfoContainer = document.getElementById('student-info-container');
    const filterButtons = document.querySelectorAll('.filter-buttons .btn');
    const searchInput = document.getElementById('search-input');

    let allStudents = [];
    let selectedStudentData = null;
    let universityDataCache = {};
    let universityFormulas = {};
    let currentCounselingList = [];
    let currentGunFilter = 'all';
    let currentSearchTerm = '';

    const handleAuthError = () => { console.error("Authentication error!"); alert('ì¸ì¦ ë§Œë£Œ. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); window.top.location.href = LOGIN_PAGE; };
    const getToken = () => localStorage.getItem('jwt_token');
    const token = getToken();
    if (!token) { handleAuthError(); return; }

    const safeParse = (s, f = null) => { try { return JSON.parse(s) || f; } catch { return f; } };
    function showToast(message, isError = false) { const t = document.createElement('div'); t.textContent = message; t.className = `toast-popup ${isError ? 'error' : ''}`; document.body.appendChild(t); setTimeout(() => { t.classList.add('show'); }, 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => { if (document.body.contains(t)) document.body.removeChild(t); }, 500); }, 3000); }
    const formatStage = (v) => { const n = parseInt(v, 10); return !isNaN(n) && n > 1 ? `${n}ë°°ìˆ˜` : (v || '-'); };
    const formatTeaching = (v) => { if (v === 'O') return '<span class="status-o">ê°€ëŠ¥</span>'; if (v === 'X') return '<span class="status-x">ë¶ˆê°€ëŠ¥</span>'; if (v === 'â–³' || v === 'ì„¸ëª¨') return '<span class="status-semo">ì¼ë¶€</span>'; return v || '-'; };
    const formatRegion = (a, c) => [a, c].filter(Boolean).join(' ') || '-';

    const loadStudents = async () => { const y = yearSelect.value; studentSelect.innerHTML = '<option value="">- ë¡œë”© ì¤‘... -</option>'; try { const tk = getToken(); if (!tk) throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ'); const r = await fetch(`${SVR_JUNGSI}/jungsi/students/list-by-branch?year=${y}`, { headers: { 'Authorization': `Bearer ${tk}` } }); if (r.status === 401 || r.status === 403) { handleAuthError(); return; } const d = await r.json(); if (d.success && d.students) { allStudents = d.students; allStudents.sort((a,b)=>a.student_name.localeCompare(b.student_name,'ko')); studentSelect.innerHTML = '<option value="">- í•™ìƒ ì„ íƒ -</option>'; allStudents.forEach(s => { studentSelect.innerHTML += `<option value="${s.student_id}">${s.student_name} (${s.school_name || 'ì •ë³´ì—†ìŒ'})</option>`; }); } else { allStudents = []; studentSelect.innerHTML = '<option value="">- í•™ìƒ ì—†ìŒ -</option>'; } } catch (e) { console.error('í•™ìƒ ë¡œë”© ì‹¤íŒ¨', e); studentSelect.innerHTML = '<option value="">- ë¡œë”© ì˜¤ë¥˜ -</option>'; if (e.message === 'ë¡œê·¸ì¸ ë§Œë£Œ') handleAuthError(); } };
const loadUniversities = async (year) => {
    const k = year;
    if (universityDataCache[k]) return universityDataCache[k];
    console.log(`[${year}] ëŒ€í•™ ë¡œë”©...`);
    try {
        const tk = getToken();
        if (!tk) throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ');

        // ğŸ”¥ ì—¬ê¸° ìˆ˜ì •!!
        const r = await fetch(`${SVR_JUNGSI}/jungsi/schools/${year}`, {
            headers: { 'Authorization': `Bearer ${tk}` }
        });

        if (r.status === 401 || r.status === 403) { handleAuthError(); return []; }
        const d = await r.json();
        if (d.success && d.list) {
            universityDataCache[k] = d.list;
            console.log(`[${year}] ëŒ€í•™ ${d.list.length}ê°œ ë¡œë“œ ì™„ë£Œ.`);
            return d.list;
        } else {
            console.warn("ëŒ€í•™ ë¡œë”© ì‹¤íŒ¨:", d.message);
            return [];
        }
    } catch (e) {
        console.error('ëŒ€í•™ ë¡œë”© ì˜¤ë¥˜:', e);
        if (e.message === 'ë¡œê·¸ì¸ ë§Œë£Œ') handleAuthError();
        return [];
    }
};

    const fetchFormulaDetails = async (uid, year) => { const k = `${uid}-${year}`; if (universityFormulas[k]) return universityFormulas[k]; if (!uid) return null; try { const tk = getToken(); if (!tk) throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ'); const r = await fetch(`${SVR_JUNGSI}/jungsi/formula-details?U_ID=${uid}&year=${year}`, { headers: { 'Authorization': `Bearer ${tk}` } }); if (r.status === 401 || r.status === 403) throw new Error('ì¸ì¦ ì˜¤ë¥˜'); const d = await r.json(); if (!d.success) throw new Error(d.message || 'ìš”ê°• ë¡œë”© ì‹¤íŒ¨'); universityFormulas[k] = d.formula; return d.formula; } catch (e) { console.error('ìš”ê°• ë¡œë”© ì‹¤íŒ¨', e); if (e.message.includes('ì¸ì¦')) handleAuthError(); return null; } };
    const calculateSuneung = async (stu, uid, year) => { if (!stu || !stu.scores) return null; try { const si = convertScoresToSuneungFormat(stu.scores); const tk = getToken(); if (!tk) throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ'); const r = await fetch(`${SVR_JUNGSI}/jungsi/calculate`, { method: 'POST', headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${tk}` }, body: JSON.stringify({ U_ID:uid, year, studentScores: si }) }); if (r.status === 401 || r.status === 403) throw new Error('ì¸ì¦ ì˜¤ë¥˜'); const d = await r.json(); if (!d.success) throw new Error(d.message||'ìˆ˜ëŠ¥ ê³„ì‚° ì‹¤íŒ¨'); return Number(d.result?.totalScore || 0); } catch (e) { console.error('ìˆ˜ëŠ¥ ê³„ì‚° ì—ëŸ¬:', e); if (e.message.includes('ì¸ì¦')) handleAuthError(); return null; } };
    const convertScoresToSuneungFormat = (s) => { if (!s) return { subjects: [] }; const sub = []; if (s.êµ­ì–´_í‘œì¤€ì ìˆ˜!=null || s.êµ­ì–´_ë°±ë¶„ìœ„!=null) sub.push({ name:'êµ­ì–´', subject:s.êµ­ì–´_ì„ íƒê³¼ëª©, std:s.êµ­ì–´_í‘œì¤€ì ìˆ˜, percentile:s.êµ­ì–´_ë°±ë¶„ìœ„, grade:s.êµ­ì–´_ë“±ê¸‰ }); if (s.ìˆ˜í•™_í‘œì¤€ì ìˆ˜!=null || s.ìˆ˜í•™_ë°±ë¶„ìœ„!=null) sub.push({ name:'ìˆ˜í•™', subject:s.ìˆ˜í•™_ì„ íƒê³¼ëª©, std:s.ìˆ˜í•™_í‘œì¤€ì ìˆ˜, percentile:s.ìˆ˜í•™_ë°±ë¶„ìœ„, grade:s.ìˆ˜í•™_ë“±ê¸‰ }); if (s.ì˜ì–´_ë“±ê¸‰!=null) sub.push({ name:'ì˜ì–´', grade:s.ì˜ì–´_ë“±ê¸‰ }); if (s.í•œêµ­ì‚¬_ë“±ê¸‰!=null) sub.push({ name:'í•œêµ­ì‚¬', grade:s.í•œêµ­ì‚¬_ë“±ê¸‰ }); if (s.íƒêµ¬1_ì„ íƒê³¼ëª©!=null) sub.push({ name:'íƒêµ¬', subject:s.íƒêµ¬1_ì„ íƒê³¼ëª©, std:s.íƒêµ¬1_í‘œì¤€ì ìˆ˜, percentile:s.íƒêµ¬1_ë°±ë¶„ìœ„, grade:s.íƒêµ¬1_ë“±ê¸‰ }); if (s.íƒêµ¬2_ì„ íƒê³¼ëª©!=null) sub.push({ name:'íƒêµ¬', subject:s.íƒêµ¬2_ì„ íƒê³¼ëª©, std:s.íƒêµ¬2_í‘œì¤€ì ìˆ˜, percentile:s.íƒêµ¬2_ë°±ë¶„ìœ„, grade:s.íƒêµ¬2_ë“±ê¸‰ }); return { subjects:sub }; };
    const fetchTop10Score = async (uid, year) => { try { const tk = getToken(); if (!tk) throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ'); const r = await fetch(`${SVR_JUNGSI}/jungsi/counseling/stats/${uid}/${year}`, { headers: { 'Authorization': `Bearer ${tk}` } }); if (r.status === 401 || r.status === 403) throw new Error('ì¸ì¦ ì˜¤ë¥˜'); const d = await r.json(); return (d.success && d.top10Score != null) ? Number(d.top10Score) : null; } catch (e) { console.error(`Top10 ì¡°íšŒ ì˜¤ë¥˜ (U_ID:${uid})`, e); if (e.message.includes('ì¸ì¦')) handleAuthError(); return null; } };
    const loadCurrentCounselingList = async (sid, year) => { try { const tk = getToken(); if (!tk) throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ'); const r = await fetch(`${SVR_JUNGSI}/jungsi/counseling/wishlist/${sid}/${year}`, { headers: { 'Authorization': `Bearer ${tk}` } }); if (r.status === 401 || r.status === 403) throw new Error('ì¸ì¦ ì˜¤ë¥˜'); const d = await r.json(); currentCounselingList = (d.success && d.wishlist) ? d.wishlist : []; console.log("Current counseling list loaded:", currentCounselingList.length); } catch (e) { console.error('ìƒë‹´ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', e); currentCounselingList = []; if (e.message.includes('ì¸ì¦')) handleAuthError(); } };

    function updateStudentInfoCard(stu) { const c = studentInfoContainer; if (!stu || !c) { if (c) c.style.display='none'; return; } c.querySelector('#selected-student-name').textContent = stu.student_name || '-'; c.querySelector('#selected-school-name').textContent = stu.school_name || 'ì •ë³´ì—†ìŒ'; c.querySelector('#selected-gender').textContent = stu.gender || '-'; const s = stu.scores || {}; const fmtS = (sub,std,pct,g)=>{ const p=[]; if(std!=null) p.push(`í‘œ ${std}`); if(pct!=null) p.push(`ë°± ${pct}`); if(g!=null) p.push(`<strong class="grade-emphasis">${g}</strong>ë“±ê¸‰`); return p.length?p.join(' / '):'-'; }; const fmtG = (g)=> (g!=null)?`<strong class="grade-emphasis">${g}</strong>ë“±ê¸‰`:'-'; const el = (id)=>c.querySelector('#'+id); el('score-kor').innerHTML = `êµ­ì–´(${s.êµ­ì–´_ì„ íƒê³¼ëª© || '?' }): ${fmtS(s.êµ­ì–´_ì„ íƒê³¼ëª©,s.êµ­ì–´_í‘œì¤€ì ìˆ˜,s.êµ­ì–´_ë°±ë¶„ìœ„,s.êµ­ì–´_ë“±ê¸‰)}`; el('score-math').innerHTML= `ìˆ˜í•™(${s.ìˆ˜í•™_ì„ íƒê³¼ëª© || '?' }): ${fmtS(s.ìˆ˜í•™_ì„ íƒê³¼ëª©,s.ìˆ˜í•™_í‘œì¤€ì ìˆ˜,s.ìˆ˜í•™_ë°±ë¶„ìœ„,s.ìˆ˜í•™_ë“±ê¸‰)}`; el('score-eng').innerHTML = `ì˜ì–´: ${fmtG(s.ì˜ì–´_ë“±ê¸‰)}`; el('score-hist').innerHTML= `í•œêµ­ì‚¬: ${fmtG(s.í•œêµ­ì‚¬_ë“±ê¸‰)}`; el('score-inq1').innerHTML= `íƒêµ¬1(${s.íƒêµ¬1_ì„ íƒê³¼ëª© || '?' }): ${fmtS(s.íƒêµ¬1_ì„ íƒê³¼ëª©,s.íƒêµ¬1_í‘œì¤€ì ìˆ˜,s.íƒêµ¬1_ë°±ë¶„ìœ„,s.íƒêµ¬1_ë“±ê¸‰)}`; el('score-inq2').innerHTML= `íƒêµ¬2(${s.íƒêµ¬2_ì„ íƒê³¼ëª© || '?' }): ${fmtS(s.íƒêµ¬2_ì„ íƒê³¼ëª©,s.íƒêµ¬2_í‘œì¤€ì ìˆ˜,s.íƒêµ¬2_ë°±ë¶„ìœ„,s.íƒêµ¬2_ë“±ê¸‰)}`; c.style.display='block'; }

const populateUniversityTable = async () => {
        if (!selectedStudentData) { tbody.innerHTML = '<tr class="loading-row"><td colspan="13">í•™ìƒì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>'; return; }
        const year = yearSelect.value;
        tbody.innerHTML = '<tr class="loading-row"><td colspan="13"><i class="fas fa-spinner fa-spin"></i> ëŒ€í•™ë³„ ì ìˆ˜ ì •ë³´ ë¡œë”© ì¤‘...</td></tr>';

        const universities = await loadUniversities(year);
        if (!universities || universities.length === 0) { tbody.innerHTML = '<tr class="loading-row"><td colspan="13">í•´ë‹¹ í•™ë…„ë„ ëŒ€í•™ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }

        await loadCurrentCounselingList(selectedStudentData.student_id, year);

const searchTerm = currentSearchTerm.trim().toLowerCase();

const filteredUniversities = universities.filter(uni => {
    const gunMatch =
        currentGunFilter === 'all' ||
        (uni.gun && uni.gun.startsWith(currentGunFilter));

    // ëŒ€í•™ëª…
    const hayUni  = (uni.university || '').toLowerCase();
    // í•™ê³¼ëª…
    const hayDept = (uni.department || '').toLowerCase();
    // êµ° (ê°€êµ°/ë‚˜êµ°/ë‹¤êµ°)ë„ ê²€ìƒ‰ì— í¬í•¨ì‹œí‚¤ì. "ê°€êµ°"ìœ¼ë¡œ ê²€ìƒ‰í•˜ë©´ ë°”ë¡œ í•„í„° ê°€ëŠ¥í•˜ê²Œ.
    const hayGun  = (uni.gun || '').toLowerCase();

    // ì§€ì—­ í›„ë³´ë¥¼ ë‹¤ í•©ì³ì„œ ë³¸ë‹¤.
    // 1) ê¸°ì¡´ì— ì“°ë˜ uni.ê´‘ì—­ / uni.ì‹œêµ¬
    // 2) í˜¹ì‹œ ë°±ì—”ë“œì—ì„œ region, city ì´ëŸ° ì´ë¦„ìœ¼ë¡œ ë³´ë‚´ê³  ìˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆê¹Œ ê·¸ê²ƒë„ ê°™ì´ ë³¸ë‹¤.
    const hayRegionAll = [
        uni.ê´‘ì—­,
        uni.ì‹œêµ¬,
        uni.region,
        uni.city,
        uni.ì§€ì—­,
        uni.ì£¼ì†Œ
    ].filter(Boolean).join(' ').toLowerCase();

    const searchMatch =
        !searchTerm ||
        hayUni.includes(searchTerm) ||
        hayDept.includes(searchTerm) ||
        hayGun.includes(searchTerm) ||
        hayRegionAll.includes(searchTerm);

    return gunMatch && searchMatch;
});


        if (filteredUniversities.length === 0) { tbody.innerHTML = '<tr class="loading-row"><td colspan="13">ì¡°ê±´ì— ë§ëŠ” ëŒ€í•™ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }

        const rowPromises = filteredUniversities.map(async (uni) => {
            try {
                const [formula, myScore, top10Score] = await Promise.all([
                    fetchFormulaDetails(uni.U_ID, year),
                    calculateSuneung(selectedStudentData, uni.U_ID, year),
                    fetchTop10Score(uni.U_ID, year)
                ]);

                // *** ë¡œê·¸ ì¶”ê°€ ***: ë°±ì—”ë“œì—ì„œ ë°›ì€ formula ê°ì²´ ì „ì²´ë¥¼ ì½˜ì†”ì— ì¶œë ¥
                console.log(`[U_ID: ${uni.U_ID}] Received Formula Data:`, formula);

                if (!formula) {
                    // *** ë¡œê·¸ ì¶”ê°€ ***: Formula ë¡œë”© ì‹¤íŒ¨ ì‹œ ë¡œê·¸
                    console.warn(`[U_ID: ${uni.U_ID}] Formula data is null or undefined. Skipping row.`);
                    return null; // formula ì—†ìœ¼ë©´ í–‰ ìƒì„± X
                }


                const isInList = currentCounselingList.some(item => item.ëŒ€í•™í•™ê³¼_ID == uni.U_ID);
                const region = formatRegion(formula.ê´‘ì—­, formula.ì‹œêµ¬);

                // *** ë¡œê·¸ ì¶”ê°€ ***: ëª¨ì§‘ ì •ì› ê°’ í™•ì¸
                const ëª¨ì§‘ì •ì›_ê°’ = formula['ëª¨ì§‘ì •ì›'];
                console.log(`[U_ID: ${uni.U_ID}] ëª¨ì§‘ ì •ì› ê°’:`, ëª¨ì§‘ì •ì›_ê°’, `(íƒ€ì…: ${typeof ëª¨ì§‘ì •ì›_ê°’})`);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${region}</td>
                    <td class="uni-dept"><strong>${formula.ëŒ€í•™ëª… || uni.university}</strong><span>${formula.í•™ê³¼ëª… || uni.department}</span></td>
                    <td>${formatTeaching(formula.êµì§)}</td>
                    <td>${ëª¨ì§‘ì •ì›_ê°’ || '-'}</td>  
                    <td>${formula.ìˆ˜ëŠ¥ || '-'}%</td>
                    <td>${formula.ë‚´ì‹  || '-'}%</td>
                    <td>${formula.ì‹¤ê¸° || '-'}%</td>
                    <td>${formatStage(formula.ë‹¨ê³„ë³„)}</td>
                    <td class="my-score">${myScore !== null ? `<strong>${myScore.toFixed(2)}</strong>` : '<span style="color:red;">ì˜¤ë¥˜</span>'}</td>
                    <td class="top-score">${top10Score !== null ? `<strong>${top10Score.toFixed(2)}</strong>` : '-'}</td>
                    <td>500</td> 
                    <td>500</td> 
                    <td class="action-buttons">
                        <button class="btn btn-sm ${isInList ? 'btn-success' : 'btn-primary'} add-to-list-btn"
                                data-uid="${uni.U_ID}" data-gun="${formula.êµ° || uni.gun}"
                                ${isInList ? 'disabled' : ''}>
                            <i class="fas ${isInList ? 'fa-check' : 'fa-plus'}"></i> ${isInList ? 'ì¶”ê°€ë¨' : 'ì¶”ê°€'}
                        </button>
                        ${isInList ? `<button class="btn btn-sm btn-danger remove-from-list-btn" data-uid="${uni.U_ID}" data-gun="${formula.êµ° || uni.gun}"><i class="fas fa-times"></i> ì œì™¸</button>` : ''}
                    </td>
                `;
                const addButton = tr.querySelector('.add-to-list-btn');
                const removeButton = tr.querySelector('.remove-from-list-btn');
                if (addButton) addButton.addEventListener('click', handleAddToListClick);
                if (removeButton) removeButton.addEventListener('click', handleRemoveFromListClick);

                return tr;

            } catch (error) {
                 console.error(`Error processing row for U_ID ${uni.U_ID}:`, error);
                 const tr = document.createElement('tr');
                 tr.innerHTML = `<td>${formatRegion(uni.ê´‘ì—­, uni.ì‹œêµ¬)}</td><td class="uni-dept"><strong>${uni.university}</strong><span>${uni.department}</span></td><td colspan="10" style="color:red; text-align:left;">ì˜¤ë¥˜</td><td>-</td>`;
                 return tr;
            }
        });

        try {
            const rowElements = await Promise.all(rowPromises);
            tbody.innerHTML = '';
            let addedRowCount = 0;
            rowElements.forEach(tr => { if (tr) { tbody.appendChild(tr); addedRowCount++; } });
            if (addedRowCount === 0 && filteredUniversities.length > 0) { tbody.innerHTML = '<tr class="loading-row"><td colspan="13">ë°ì´í„° í‘œì‹œ ì˜¤ë¥˜</td></tr>'; }
             else if (addedRowCount === 0 && filteredUniversities.length === 0) { tbody.innerHTML = '<tr class="loading-row"><td colspan="13">ì¡°ê±´ì— ë§ëŠ” ëŒ€í•™ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; }
        } catch (error) {
             console.error("populateUniversityTable Promise.all ì—ëŸ¬:", error);
             tbody.innerHTML = '<tr class="loading-row"><td colspan="13">ë°ì´í„° ë¡œë”© ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ</td></tr>';
        }
    };

    const handleAddToListClick = async (event) => {
        const button = event.target.closest('button');
        if (!selectedStudentData) { showToast('í•™ìƒ ë¨¼ì € ì„ íƒ.', true); return; }
        const U_ID = button.dataset.uid; const gun = button.dataset.gun;
        if (!gun) { showToast('êµ° ì •ë³´ ì—†ìŒ.', true); return; }
        button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        try {
            await loadCurrentCounselingList(selectedStudentData.student_id, yearSelect.value);
            const currentGunCount = currentCounselingList.filter(item => item.ëª¨ì§‘êµ° === gun).length;
            if (currentGunCount >= 3) { showToast(`${gun}êµ° 3ê°œ ì´ˆê³¼.`, true); throw new Error('Limit exceeded'); }
            if (currentCounselingList.some(item => item.ëŒ€í•™í•™ê³¼_ID == U_ID)) { showToast('ì´ë¯¸ ìˆìŒ.', false); throw new Error('Already added'); }

            const tk = getToken(); if (!tk) throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ');

            // [í•´ê²°ì±…] counsel.html ê³¼ ë™ì¼í•˜ê²Œ /bulk-save ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •
            // 1. í˜„ì¬ ëª©ë¡ì— ìƒˆ í•­ëª© ì¶”ê°€
            currentCounselingList.push({
                ëª¨ì§‘êµ°: gun,
                ëŒ€í•™í•™ê³¼_ID: U_ID,
                í•™ìƒ_ID: selectedStudentData.student_id, // â­ï¸ í•™ìƒ IDë„ ì¶”ê°€ (í•„ìˆ˜)
                í•™ë…„ë„: yearSelect.value,             // â­ï¸ í•™ë…„ë„ë„ ì¶”ê°€ (í•„ìˆ˜)
                ìƒë‹´_ìˆ˜ëŠ¥ì ìˆ˜: null, ìƒë‹´_ë‚´ì‹ ì ìˆ˜: null, ìƒë‹´_ì‹¤ê¸°ê¸°ë¡: null,
                ìƒë‹´_ì‹¤ê¸°ë°˜ì˜ì ìˆ˜: null, ìƒë‹´_ê³„ì‚°ì´ì : null
            });

            // 2. /bulk-save API í˜¸ì¶œ
            const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/wishlist/bulk-save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${tk}` },
                body: JSON.stringify({
                    í•™ìƒ_ID: selectedStudentData.student_id,
                    í•™ë…„ë„: yearSelect.value,
                    wishlistItems: currentCounselingList // ì „ì²´ ëª©ë¡ ì „ì†¡
                })
            });

            const data = await res.json();
            if (res.status === 401 || res.status === 403) throw new Error('ì¸ì¦ ì˜¤ë¥˜');

            if (res.ok && data.success) {
                showToast(`[${gun}êµ°] ì¶”ê°€ ì™„ë£Œ!`, false);
                button.innerHTML = '<i class="fas fa-check"></i> ì¶”ê°€ë¨';
                button.classList.replace('btn-primary', 'btn-success');
                button.disabled = true;
                // ì œì™¸ ë²„íŠ¼ ìƒì„± ë° ì¶”ê°€
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-danger remove-from-list-btn';
                removeBtn.dataset.uid = U_ID; removeBtn.dataset.gun = gun;
                removeBtn.innerHTML = '<i class="fas fa-times"></i> ì œì™¸';
                removeBtn.addEventListener('click', handleRemoveFromListClick);
                button.parentNode.appendChild(removeBtn);
            } else {
                // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
                currentCounselingList = currentCounselingList.filter(item => item.ëŒ€í•™í•™ê³¼_ID != U_ID);
                throw new Error(data.message || `ì¶”ê°€ ì‹¤íŒ¨ (${res.status})`);
            }
        } catch (error) {
            console.error('ìƒë‹´ ì¶”ê°€ ì˜¤ë¥˜:', error);
            if (error.message !== 'Already added' && error.message !== 'Limit exceeded') {
                showToast(`ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`, true);
            }
            button.innerHTML = '<i class="fas fa-plus"></i> ì¶”ê°€';
            button.classList.replace('btn-success', 'btn-primary');
            button.disabled = false;
             if (error.message.includes('ì¸ì¦')) handleAuthError();
        }
    };

    // â­ï¸ ìƒë‹´ ëª©ë¡ ì œì™¸ ë²„íŠ¼ í•¸ë“¤ëŸ¬ (bulk-save ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •)
    const handleRemoveFromListClick = async (event) => {
        const button = event.target.closest('button');
        if (!selectedStudentData) { showToast('í•™ìƒ ë¨¼ì € ì„ íƒ.', true); return; }

        const U_ID = button.dataset.uid;
        const gun = button.dataset.gun;
        const year = yearSelect.value;
        const studentId = selectedStudentData.student_id;

        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            // 1. í˜„ì¬ ëª©ë¡ì—ì„œ ì´ í•­ëª©ì„ *ì œì™¸í•œ* ìƒˆ ëª©ë¡ ìƒì„±
            const newList = currentCounselingList.filter(item =>
                !(item.ëŒ€í•™í•™ê³¼_ID == U_ID && item.í•™ìƒ_ID == studentId && item.í•™ë…„ë„ == year)
            );

            const tk = getToken(); if (!tk) throw new Error('ë¡œê·¸ì¸ ë§Œë£Œ');
            // 2. /bulk-save API í˜¸ì¶œ
            const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/wishlist/bulk-save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${tk}` },
                body: JSON.stringify({
                    í•™ìƒ_ID: studentId,
                    í•™ë…„ë„: year,
                    wishlistItems: newList // ì œì™¸ëœ ëª©ë¡ ì „ì†¡
                })
            });
            const data = await res.json();

            if (res.status === 401 || res.status === 403) throw new Error('ì¸ì¦ ì˜¤ë¥˜');

            if (res.ok && data.success) {
                showToast(`[${gun}êµ°] ëª©ë¡ì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, false);
                // ì¶”ê°€ ë²„íŠ¼ ì°¾ì•„ì„œ í™œì„±í™” ë° ìƒíƒœ ë³€ê²½
                const addButton = button.parentNode.querySelector('.add-to-list-btn');
                if (addButton) {
                    addButton.innerHTML = '<i class="fas fa-plus"></i> ì¶”ê°€';
                    addButton.classList.replace('btn-success', 'btn-primary');
                    addButton.disabled = false;
                }
                button.remove(); // ì œì™¸ ë²„íŠ¼ ìì‹  ì œê±°
                currentCounselingList = newList; // ë‚´ë¶€ ìºì‹œ ì—…ë°ì´íŠ¸
            } else {
                throw new Error(data.message || `ì œì™¸ ì‹¤íŒ¨ (${res.status})`);
            }
        } catch (error) {
            console.error('ìƒë‹´ ì œì™¸ ì˜¤ë¥˜:', error);
            showToast(`ì œì™¸ ì‹¤íŒ¨: ${error.message}`, true);
            // ë²„íŠ¼ ì›ë˜ ìƒíƒœë¡œ ë³µì›
            button.innerHTML = '<i class="fas fa-times"></i> ì œì™¸';
            button.disabled = false;
            if (error.message.includes('ì¸ì¦')) handleAuthError();
        }
    };


    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    studentSelect.addEventListener('change', async (e)=>{ const id = e.target.value; if (id) { selectedStudentData = allStudents.find(s=>s.student_id==id); updateStudentInfoCard(selectedStudentData); await populateUniversityTable(); } else { selectedStudentData = null; updateStudentInfoCard(null); tbody.innerHTML = '<tr class="loading-row"><td colspan="13">í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>'; } });
    yearSelect.addEventListener('change', async ()=>{ await loadStudents(); selectedStudentData = null; studentSelect.value = ''; updateStudentInfoCard(null); universityFormulas = {}; universityDataCache = {}; await populateUniversityTable(); });
    filterButtons.forEach(button => { button.addEventListener('click', () => { filterButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); currentGunFilter = button.dataset.gunFilter; populateUniversityTable(); }); });
    searchInput.addEventListener('input', () => {
        // â­ï¸ ê²€ìƒ‰ ì…ë ¥ ì‹œ ë”œë ˆì´(ë””ë°”ìš´ìŠ¤) ì¶”ê°€
         clearTimeout(searchInput.timer);
         searchInput.timer = setTimeout(() => {
             currentSearchTerm = searchInput.value;
             populateUniversityTable();
         }, 300); // 300ms ë”œë ˆì´
    });

    // --- í˜ì´ì§€ ì´ˆê¸° ë¡œë“œ ---
    loadStudents();
    loadUniversities(yearSelect.value);

});
</script>

</body>
</html>
