<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ì‹¤ê¸° ë°°ì í‘œ ê´€ë¦¬ì (v5 - ìµœì¢…)</title>
    <style>
        /* setting.htmlê³¼ ê±°ì˜ ë™ì¼í•œ ìŠ¤íƒ€ì¼ */
        :root { --primary-color:#007bff; --border-color:#dee2e6; --bg-color:#f8f9fa; --text-color:#212529; --font-size-base:16px; }
        body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; margin:0; background:#f4f4f4; color:var(--text-color); font-size:var(--font-size-base); }
        .container { width:95%; max-width:1200px; /* Max width slightly smaller */ margin:0 auto; padding:20px; }
        header { display:flex; justify-content:space-between; align-items:center; padding:15px 30px; background:var(--primary-color); color:#fff; margin-bottom:20px; }
        header h1 { margin:0; font-size:1.6em; }
        header .header-controls { display:flex; align-items:center; gap:20px; }
        header select { width:180px; padding:8px; margin:0; }
        input,button,select,textarea { width:100%; padding:12px; margin-bottom:10px; border-radius:5px; border:1px solid var(--border-color); box-sizing:border-box; font-size:1em; }
        button { background:var(--primary-color); color:#fff; cursor:pointer; border:none; font-weight:bold; transition:background-color .2s; }
        button:hover { opacity:.9; }
        .btn-load { background-color: #007bff; }
        .btn-load:hover { background-color: #0056b3; }
        .btn-save { background-color: #28a745; }
        .btn-save:hover { background-color: #1e7e34; }
        .btn-delete { background-color: #dc3545; font-size: 12px; padding: 4px 8px; width:auto; }
        .btn-delete:hover { background-color: #b02a37; }
        
        /* Layout specific to silgi-editor */
        .control-group { margin-bottom: 20px; padding: 15px; background: #fafafa; border-radius: 6px; border: 1px solid #eee; }
        .control-group label { font-weight: bold; margin-right: 10px; font-size: 14px; display: inline-block; min-width: 60px; }
        .control-group input[type="text"], .control-group select { width: auto; padding: 8px; display: inline-block; }
        #year { width: 100px; }
        #schoolSearch { width: 500px; } /* Select2 overrides this */
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 14px; }
        th { background-color: #f9f9f9; }
        tr:nth-child(even) { background-color: #fdfdfd; }
        
        .editor-section { display: flex; gap: 20px; margin-top: 20px; }
        .editor-section > div { flex: 1; padding: 15px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; }
        
        .bulk-paste-area { display: flex; gap: 10px; }
        .bulk-paste-area textarea { width: 50%; height: 200px; font-family: monospace; font-size: 13px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        .note { font-size: 12px; color: #666; margin-top: 10px; }
        .message { margin-top:15px; font-weight:bold; min-height:20px; font-size:1.1em; }
        .message.success { color:#28a745; }
        .message.error { color:#dc3545; }
        .hidden { display:none !important; }

        /* Login Modal from setting.html */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:1000; }
        .modal-content { background:#fff; padding:40px; border-radius:8px; width:100%; max-width:400px; box-shadow:0 5px 15px rgba(0,0,0,.3); }
        .modal-content h2 { margin-top: 0; }
        .modal-content input { width: 100%; margin-bottom: 15px; } /* Adjusted width */
        .modal-content button { width: 100%; }
        #login-message { height: 20px; } /* Ensure space for message */
    </style>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body>
    <div id="login-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>ì‹¤ê¸° ë°°ì  ê´€ë¦¬ ë¡œê·¸ì¸</h2>
            <form id="login-form">
                <input type="text" id="userid" placeholder="ì•„ì´ë””" required />
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required />
                <button type="submit">ë¡œê·¸ì¸</button>
            </form>
            <p id="login-message" class="message"></p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <h1>ì‹¤ê¸° ë°°ì í‘œ ê´€ë¦¬</h1>
            <div class="header-controls">
                <label for="year-selector" style="color:#fff;font-weight:bold;">í•™ë…„ë„:</label>
                <select id="year-selector">
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>
                <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <div class="container">
            <div class="control-group">
                <div>
                    <label for="schoolSearch">í•™êµ:</label>
                    <select id="schoolSearch">
                        <option value="">ë¨¼ì € í•™ë…„ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</option>
                    </select>
                    <button id="loadButton" class="btn-load">ë°°ì í‘œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
            </div>

            <h2 id="tableTitle">ë°°ì í‘œ (U_ID: -)</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì¢…ëª©ëª…</th>
                        <th>ì„±ë³„</th>
                        <th>ê¸°ë¡</th>
                        <th>ë°°ì </th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="scoreTableBody">
                </tbody>
            </table>

            <div class="editor-section">
                <div>
                    <h2>í•œ ì¤„ ì¶”ê°€</h2>
                    <form id="addForm">
                        <div class="control-group">
                            <label for="eventName">ì¢…ëª©ëª…:</label>
                            <input type="text" id="eventName" required>
                        </div>
                        <div class="control-group">
                            <label for="gender">ì„±ë³„:</label>
                            <select id="gender" required>
                                <option value="ë‚¨">ë‚¨</option>
                                <option value="ì—¬">ì—¬</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="record">ê¸°ë¡:</label>
                            <input type="text" id="record" placeholder="12.50 ë˜ëŠ” A" required>
                        </div>
                        <div class="control-group">
                            <label for="score">ë°°ì :</label>
                            <input type="text" id="score" placeholder="100 ë˜ëŠ” PASS" required>
                        </div>
                        <button type="submit" class="btn-save">ì‹ ê·œ ì €ì¥</button>
                    </form>
                </div>

                <div>
                    <h2>ëŒ€ëŸ‰ ì¶”ê°€ (ì—‘ì…€/CSV ë³µë¶™)</h2>
                    <div class="control-group">
                        <label for="bulkEventName">ì¢…ëª©ëª…:</label>
                        <input type="text" id="bulkEventName" placeholder="ì ìš©í•  ì¢…ëª©ëª…">
                    </div>
                    <div class="control-group">
                        <label for="bulkGender">ì„±ë³„:</label>
                        <select id="bulkGender">
                            <option value="ë‚¨">ë‚¨</option>
                            <option value="ì—¬">ì—¬</option>
                        </select>
                    </div>
                    <p class="note">ì—‘ì…€ì—ì„œ 'ê¸°ë¡' ì—´, 'ë°°ì ' ì—´ì„ ê°ê° ë³µì‚¬í•´ì„œ ì•„ë˜ ì¹¸ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                    <div class="bulk-paste-area">
                        <textarea id="bulkRecord" placeholder="[ê¸°ë¡] ì—´ ë¶™ì—¬ë„£ê¸°"></textarea>
                        <textarea id="bulkScore" placeholder="[ë°°ì ] ì—´ ë¶™ì—¬ë„£ê¸°"></textarea>
                    </div>
                    <button id="bulkSaveButton" class="btn-save" style="margin-top: 10px;">ëŒ€ëŸ‰ ì €ì¥</button>
                </div>
            </div>
            <p id="editor-message" class="message"></p> </div>
    </div>

    <script>
        // â­ï¸ 3. ì„œë²„ ì£¼ì†Œ (setting.htmlê³¼ ë™ì¼) â­ï¸
        const SVR_26SUSI = 'https://supermax.kr'; // ğŸš¨ ë¡œê·¸ì¸ ì„œë²„ ì£¼ì†Œ í™•ì¸!
        const SVR_JUNGSI = 'https://supermax.kr'; // ğŸš¨ ì •ì‹œ ì„œë²„ ì£¼ì†Œ í™•ì¸!
        
        const TOKEN_STORAGE_KEY = 'jwt_token'; // setting.htmlê³¼ ë™ì¼í•œ í‚¤ ì‚¬ìš©

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const loginModal = document.getElementById('login-modal');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const logoutBtn = document.getElementById('logout-btn');
        const yearSelector = document.getElementById('year-selector');
        const schoolSearchSelect = $('#schoolSearch'); // jQuery ê°ì²´
        const loadButton = document.getElementById('loadButton');
        const tableTitle = document.getElementById('tableTitle');
        const tableBody = document.getElementById('scoreTableBody');
        const addForm = document.getElementById('addForm');
        const bulkSaveButton = document.getElementById('bulkSaveButton');
        const editorMessageEl = document.getElementById('editor-message');

        let current_U_ID = null;
        let current_Year = null;

        // â­ï¸ 4. í† í° ê´€ë¦¬ í•¨ìˆ˜ (setting.htmlê³¼ ë™ì¼) â­ï¸
        const getToken = () => localStorage.getItem(TOKEN_STORAGE_KEY);
        const setToken = (token) => localStorage.setItem(TOKEN_STORAGE_KEY, token);
        const removeToken = () => localStorage.removeItem(TOKEN_STORAGE_KEY);

        // â­ï¸ 5. ì¸ì¦ëœ fetch í•¨ìˆ˜ (setting.htmlê³¼ ë™ì¼) â­ï¸
        async function fetchWithAuth(url, options = {}) {
            const token = getToken();
            if (!token) {
                showLoginModal();
                throw new Error('ì¸ì¦ í† í° ì—†ìŒ');
            }
            
            const headers = { ...(options.headers || {}), 'Authorization': `Bearer ${token}` };
            
            try {
                const response = await fetch(url, { ...options, headers });
                if (response.status === 401 || response.status === 403) {
                    removeToken();
                    showLoginModal();
                    throw new Error('ì¸ì¦ ì‹¤íŒ¨ ë˜ëŠ” í† í° ë§Œë£Œ');
                }
                return response; // JSON íŒŒì‹±ì€ í˜¸ì¶œí•˜ëŠ” ìª½ì—ì„œ
            } catch (error) {
                console.error("Fetch Error:", error);
                editorMessageEl.textContent = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                editorMessageEl.className = 'message error';
                throw error; // ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ í˜¸ì¶œë¶€ê°€ ì²˜ë¦¬í•˜ê²Œ í•¨
            }
        }

        // â­ï¸ 6. UI ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ (setting.htmlê³¼ ë™ì¼) â­ï¸
        function showLoginModal() {
            loginModal.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
        function showApp() {
            loginModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        // â­ï¸ 7. ë¡œê·¸ì¸ ì²˜ë¦¬ (setting.htmlê³¼ ë™ì¼) â­ï¸
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userid = document.getElementById('userid').value;
            const password = document.getElementById('password').value;
            loginMessage.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
            try {
                // ğŸš¨ ë¡œê·¸ì¸ API ê²½ë¡œ í™•ì¸! '/26susi/login'ì´ ë§ëŠ”ì§€?
                const response = await fetch(`${SVR_26SUSI}/26susi/login`,{ 
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({userid, password}) // ğŸš¨ body í‚¤ ì´ë¦„ í™•ì¸!
                });
                const data = await response.json();
                if (data.success && data.token) {
                    setToken(data.token);
                    loginMessage.textContent = 'âœ… ë¡œê·¸ì¸ ì„±ê³µ!';
                    loginMessage.className = 'message success';
                    setTimeout(() => {
                        showApp();
                        loadSchools(); // ë¡œê·¸ì¸ ì„±ê³µ í›„ í•™êµ ëª©ë¡ ìë™ ë¡œë“œ
                    }, 500);
                } else {
                    loginMessage.textContent = data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
                    loginMessage.className = 'message error';
                }
            } catch (error) {
                loginMessage.textContent = 'ë¡œê·¸ì¸ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                loginMessage.className = 'message error';
            }
        });

        // â­ï¸ 8. ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (setting.htmlê³¼ ë™ì¼) â­ï¸
        logoutBtn.addEventListener('click', () => {
            removeToken();
            showLoginModal();
            // í•„ìš”ì‹œ í™”ë©´ ì´ˆê¸°í™”
            schoolSearchSelect.empty().prop('disabled', true).append(new Option("ë¨¼ì € í•™ë…„ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”.", ""));
            tableBody.innerHTML = '';
            tableTitle.textContent = 'ë°°ì í‘œ (U_ID: -)';
        });

        // --- Select2 ë° ì´ˆê¸°í™” ---
        $(document).ready(function() {
            schoolSearchSelect.select2({
                placeholder: "í•™êµ/í•™ê³¼ëª… ê²€ìƒ‰",
                allowClear: true,
                language: "ko" // í•œêµ­ì–´ ì§€ì› (í•„ìš”ì‹œ CDN ì¶”ê°€)
            });
            init(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
        });
        
        // --- ì´ˆê¸°í™” í•¨ìˆ˜ ---
        function init() {
            if (getToken()) {
                showApp();
                loadSchools(); // ì•± ë³´ì—¬ì£¼ê³  í•™êµ ëª©ë¡ ë¡œë“œ
            } else {
                showLoginModal();
            }
        }

        // --- í•™ë…„ë„ ë³€ê²½ ì‹œ í•™êµ ëª©ë¡ ë¡œë“œ ---
        yearSelector.addEventListener('change', loadSchools);

        // --- í•™êµ ëª©ë¡ ë¡œë“œ ---
        async function loadSchools() {
            const selectedYear = yearSelector.value;
            schoolSearchSelect.empty().prop('disabled', true).append(new Option("í•™êµ ëª©ë¡ ë¡œë”© ì¤‘...", ""));
            tableBody.innerHTML = ''; // ê¸°ì¡´ í…Œì´ë¸” ë‚´ìš© ì§€ìš°ê¸°
            tableTitle.textContent = 'ë°°ì í‘œ (U_ID: -)'; // íƒ€ì´í‹€ ì´ˆê¸°í™”
            current_U_ID = null; // ì„ íƒëœ í•™êµ ì´ˆê¸°í™”
            current_Year = selectedYear; // í˜„ì¬ í•™ë…„ë„ ì„¤ì •
            
            try {
                const response = await fetchWithAuth(`${SVR_JUNGSI}/jungsi/schools/${selectedYear}`);
                const data = await response.json();
                
                if (data.success) {
                    schoolSearchSelect.empty().prop('disabled', false);
                    schoolSearchSelect.append(new Option("í•™êµ/í•™ê³¼ë¥¼ ì„ íƒí•˜ì„¸ìš”...", ""));
                    
                    data.schools.forEach(school => {
                        const text = `${school.ëŒ€í•™ëª…} - ${school.í•™ê³¼ëª…} (${school.êµ° || 'N/A'}êµ°)`;
                        const option = new Option(text, school.U_ID);
                        schoolSearchSelect.append(option);
                    });
                    // Select2 ì—…ë°ì´íŠ¸ ë°˜ì˜
                    schoolSearchSelect.trigger('change'); 
                } else {
                    schoolSearchSelect.empty().prop('disabled', true)
                      .append(new Option("í•™êµ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", ""));
                    alert('í•™êµ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
                }
            } catch (error) {
                 schoolSearchSelect.empty().prop('disabled', true)
                   .append(new Option("í•™êµ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜", ""));
                // fetchWithAuthì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
            }
        }

        // --- ë°°ì í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ---
        loadButton.addEventListener('click', loadScores);

        // --- ë°°ì í‘œ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ---
        async function loadScores() {
            const U_ID = schoolSearchSelect.val(); // jQuery val() ì‚¬ìš©
            const year = yearSelector.value;
            
            if (!U_ID || !year) {
                alert('í•™ë…„ë„ì™€ í•™êµë¥¼ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            
            current_U_ID = U_ID;
            current_Year = year;
            const schoolName = schoolSearchSelect.find('option:selected').text();
            editorMessageEl.textContent = 'ë°°ì í‘œ ë¡œë”© ì¤‘...';
            editorMessageEl.className = 'message';
            
            try {
                const response = await fetchWithAuth(`${SVR_JUNGSI}/jungsi/practical-scores/${U_ID}/${year}`);
                const data = await response.json();
                
                if (data.success) {
                    renderTable(data.scores);
                    tableTitle.textContent = `ë°°ì í‘œ | ${schoolName} (U_ID: ${U_ID})`;
                    editorMessageEl.textContent = ''; // ì„±ê³µ ì‹œ ë©”ì‹œì§€ í´ë¦¬ì–´
                } else {
                     editorMessageEl.textContent = 'ë°°ì í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + data.message;
                     editorMessageEl.className = 'message error';
                }
            } catch (error) {
                // fetchWithAuthì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬ë¨
            }
        }

        // --- í…Œì´ë¸” ë Œë”ë§ ---
        function renderTable(scores) {
            tableBody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
            if (!scores || scores.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            scores.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.ì¢…ëª©ëª…}</td>
                    <td>${row.ì„±ë³„}</td>
                    <td>${row.ê¸°ë¡}</td>
                    <td>${row.ë°°ì }</td>
                    <td>
                        <button class="btn-delete" data-id="${row.id}">ì‚­ì œ</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- í•œ ì¤„ ì¶”ê°€ ---
        addForm.addEventListener('submit', async (event) => {
             event.preventDefault();
            if (!current_U_ID || !current_Year) {
                alert('ë¨¼ì € í•™êµë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const payload = {
                U_ID: current_U_ID,
                í•™ë…„ë„: current_Year,
                ì¢…ëª©ëª…: document.getElementById('eventName').value,
                ì„±ë³„: document.getElementById('gender').value,
                ê¸°ë¡: document.getElementById('record').value,
                ë°°ì : document.getElementById('score').value
            };
            
            editorMessageEl.textContent = 'ì €ì¥ ì¤‘...';
            editorMessageEl.className = 'message';

            try {
                const response = await fetchWithAuth(`${SVR_JUNGSI}/jungsi/practical-scores/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.success) {
                    editorMessageEl.textContent = 'ì €ì¥ ì™„ë£Œ!';
                    editorMessageEl.className = 'message success';
                    addForm.reset();
                    loadScores(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                } else {
                    editorMessageEl.textContent = 'ì €ì¥ ì‹¤íŒ¨: ' + data.message;
                    editorMessageEl.className = 'message error';
                }
            } catch (error) {
                 // fetchWithAuthì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬ë¨
            }
        });

        // --- í•œ ì¤„ ì‚­ì œ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©) ---
        tableBody.addEventListener('click', async (event) => {
            if (!event.target.classList.contains('btn-delete')) return;
            
            const id = event.target.dataset.id;
            if (!confirm(`ì •ë§ë¡œ ID ${id} í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            editorMessageEl.textContent = 'ì‚­ì œ ì¤‘...';
            editorMessageEl.className = 'message';

            try {
                const response = await fetchWithAuth(`${SVR_JUNGSI}/jungsi/practical-scores/delete/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.success) {
                    editorMessageEl.textContent = 'ì‚­ì œ ì™„ë£Œ';
                    editorMessageEl.className = 'message success';
                    loadScores(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                } else {
                    editorMessageEl.textContent = 'ì‚­ì œ ì‹¤íŒ¨: ' + data.message;
                    editorMessageEl.className = 'message error';
                }
            } catch (error) {
                 // fetchWithAuthì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬ë¨
            }
        });
        
        // --- ëŒ€ëŸ‰ ì¶”ê°€ ---
        bulkSaveButton.addEventListener('click', async () => {
             if (!current_U_ID || !current_Year) {
                alert('ë¨¼ì € í•™êµë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.');
                return;
            }
            const eventName = document.getElementById('bulkEventName').value;
            const gender = document.getElementById('bulkGender').value;
            
            const records = document.getElementById('bulkRecord').value.split('\n').filter(Boolean);
            const scores = document.getElementById('bulkScore').value.split('\n').filter(Boolean);

            if (!eventName) {
                alert('ì¢…ëª©ëª…ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            if (records.length === 0 || scores.length === 0) {
                alert('ë¶™ì—¬ë„£ì„ ê¸°ë¡ê³¼ ë°°ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (records.length !== scores.length) {
                alert(`ì˜¤ë¥˜: 'ê¸°ë¡' (${records.length}ì¤„)ê³¼ 'ë°°ì ' (${scores.length}ì¤„)ì˜ ì¤„ ìˆ˜ê°€ ë‹¤ë¦…ë‹ˆë‹¤.`);
                return;
            }

            const rows_text = records.map((record, i) => {
                const score = scores[i];
                return `${record.trim()}\t${score.trim()}`;
            }).join('\n');
            
            const payload = { 
                U_ID: current_U_ID, 
                year: current_Year, 
                eventName, 
                gender, 
                rows_text 
            };
            
            if (!confirm(`[${eventName}(${gender})] ${records.length}ê±´ì˜ ë°ì´í„°ë¥¼ ëŒ€ëŸ‰ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            editorMessageEl.textContent = 'ëŒ€ëŸ‰ ì €ì¥ ì¤‘...';
            editorMessageEl.className = 'message';

            try {
                const response = await fetchWithAuth(`${SVR_JUNGSI}/jungsi/practical-scores/bulk-save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.success) {
                    editorMessageEl.textContent = data.message;
                    editorMessageEl.className = 'message success';
                    document.getElementById('bulkRecord').value = '';
                    document.getElementById('bulkScore').value = '';
                    loadScores(); // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                } else {
                    editorMessageEl.textContent = 'ëŒ€ëŸ‰ ì €ì¥ ì‹¤íŒ¨: ' + data.message;
                    editorMessageEl.className = 'message error';
                }
            } catch (error) {
                 // fetchWithAuthì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬ë¨
            }
        });

    </script>
</body>
</html>