<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>등급별 점수 대량 편집기</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .editor-container { max-width: 1600px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        button, select { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; }
        select { background-color: #fff; color: #333; border: 1px solid #ccc; font-weight: normal; width: 150px;}
        button:hover { background-color: #0056b3; }
        .save-btn { background-color: #28a745; }
        .table-wrapper { display: flex; gap: 20px; }
        .data-table { flex: 1; border-collapse: collapse; width: 50%; }
        .data-table th, .data-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .data-table th { background-color: #f2f2f2; position: sticky; top: 0; }
        .data-table textarea { width: 100%; border: none; outline: none; resize: none; background: transparent; padding: 0; margin: 0; font-family: monospace; font-size: 0.9em; box-sizing: border-box; height: 30px; }
        .message { margin-top: 15px; font-weight: bold; min-height: 20px; padding: 10px; border-radius: 4px; }
        .message.success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .message.error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="editor-container">
        <h1>등급별 점수 대량 편집기</h1>
        <p>엑셀에서 여러 줄을 복사(Ctrl+C) 후, 아래 표의 시작 셀에 붙여넣기(Ctrl+V)하면 자동으로 채워집니다.</p>
        <div class="controls">
            <label for="year-selector" style="font-weight: bold;">학년도 선택:</label>
            <select id="year-selector">
                <option value="2026">2026학년도</option>
                <option value="2027">2027학년도</option>
                <option value="2028">2028학년도</option>
            </select>
            <button id="load-btn">데이터 불러오기</button>
            <button id="save-btn" class="save-btn">모든 변경사항 저장</button>
        </div>
        <div id="message-area" class="message hidden"></div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>대학명</th>
                        <th>학과명</th>
                        <th>영어 (1~9등급)</th>
                    </tr>
                </thead>
                <tbody id="english-tbody"></tbody>
            </table>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>대학명</th>
                        <th>학과명</th>
                        <th>한국사 (1~9등급)</th>
                    </tr>
                </thead>
                <tbody id="history-tbody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const SVR_JUNGSI = 'https://supermax.kr';

        const yearSelector = document.getElementById('year-selector'); // ⭐️ 학년도 선택 요소
        const loadBtn = document.getElementById('load-btn');
        const saveBtn = document.getElementById('save-btn');
        const englishTbody = document.getElementById('english-tbody');
        const historyTbody = document.getElementById('history-tbody');
        const messageArea = document.getElementById('message-area');
        
        const getToken = () => localStorage.getItem('jwt_token');

        const jsonToText = (jsonString) => {
            if (!jsonString) return '';
            try {
                const jsonObj = JSON.parse(jsonString);
                return Array.from({ length: 9 }, (_, i) => jsonObj[String(i + 1)] || '').join('\t');
            } catch (e) { return ''; }
        };

        // ⭐️ [핵심 수정 2] 데이터 불러오기 함수 수정
        async function loadAllData() {
            const selectedYear = yearSelector.value; // 선택된 학년도 가져오기
            messageArea.classList.remove('hidden');
            messageArea.textContent = `[${selectedYear}학년도] 데이터를 불러오는 중...`;
            messageArea.className = 'message';
            
            try {
                // API 주소에 학년도를 포함해서 요청
                const response = await fetch(`${SVR_JUNGSI}/jungsi/schools/${selectedYear}`, { headers: { 'Authorization': `Bearer ${getToken()}` } });
                const data = await response.json();
                
                if (data.success) {
                    englishTbody.innerHTML = '';
                    historyTbody.innerHTML = '';
                    data.schools.forEach(school => {
                        const enRow = `<tr><td>${school.U_ID}</td><td>${school.대학명}</td><td>${school.학과명}</td><td><textarea data-uid="${school.U_ID}">${jsonToText(school.english_scores)}</textarea></td></tr>`;
                        englishTbody.insertAdjacentHTML('beforeend', enRow);
                        const hiRow = `<tr><td>${school.U_ID}</td><td>${school.대학명}</td><td>${school.학과명}</td><td><textarea data-uid="${school.U_ID}">${jsonToText(school.history_scores)}</textarea></td></tr>`;
                        historyTbody.insertAdjacentHTML('beforeend', hiRow);
                    });
                    messageArea.textContent = `[${selectedYear}학년도] ${data.schools.length}개의 데이터를 성공적으로 불러왔습니다.`;
                    messageArea.className = 'message success';
                } else {
                    messageArea.textContent = data.message || `[${selectedYear}학년도] 데이터를 불러오지 못했습니다.`;
                    messageArea.className = 'message error';
                    if (response.status === 401 || response.status === 403) {
                        alert('로그인이 필요합니다. 설정 페이지에서 먼저 로그인해주세요.');
                    }
                }
            } catch (error) {
                messageArea.textContent = '서버 통신 중 오류가 발생했습니다.';
                messageArea.className = 'message error';
            }
        }

        // ⭐️ [핵심 수정 3] 데이터 저장 함수 수정
        async function saveAllData() {
            const selectedYear = yearSelector.value; // 선택된 학년도 가져오기
            messageArea.textContent = `[${selectedYear}학년도] 모든 데이터를 저장하는 중...`;
            messageArea.className = 'message';
            messageArea.classList.remove('hidden');

            const scoresData = [];
            const allEnglishTextareas = englishTbody.querySelectorAll('textarea');
            const allHistoryTextareas = historyTbody.querySelectorAll('textarea');

            for (let i = 0; i < allEnglishTextareas.length; i++) {
                scoresData.push({
                    U_ID: allEnglishTextareas[i].dataset.uid,
                    english_text: allEnglishTextareas[i].value,
                    history_text: allHistoryTextareas[i].value
                });
            }

            try {
                // API 요청 body에 학년도 정보를 포함해서 전송
                const response = await fetch(`${SVR_JUNGSI}/jungsi/scores/bulk-save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` },
                    body: JSON.stringify({ year: selectedYear, scores_data: scoresData })
                });
                const data = await response.json();
                messageArea.textContent = data.message;
                messageArea.className = `message ${data.success ? 'success' : 'error'}`;
            } catch (error) {
                messageArea.textContent = '서버 통신 중 오류가 발생했습니다.';
                messageArea.className = 'message error';
            }
        }
        
        // (붙여넣기 기능은 수정 없이 그대로)
        function handlePaste(event) { event.preventDefault(); const pasteData = (event.clipboardData || window.clipboardData).getData('text'); const rows = pasteData.split(/\r\n|\n|\r/); const startTextarea = event.target; let currentTr = startTextarea.closest('tr'); rows.forEach((rowText) => { if (!currentTr) return; const targetTextarea = currentTr.querySelector('textarea'); if (targetTextarea) { targetTextarea.value = rowText.trim(); } currentTr = currentTr.nextElementSibling; }); }
        englishTbody.addEventListener('paste', handlePaste);
        historyTbody.addEventListener('paste', handlePaste);
        
        loadBtn.addEventListener('click', loadAllData);
        saveBtn.addEventListener('click', saveAllData);

        // ⭐️ 학년도 선택 시 자동으로 데이터 다시 불러오기
        yearSelector.addEventListener('change', loadAllData);

        if (getToken()) {
            loadAllData();
        } else {
            alert('로그인이 필요합니다. 규칙 설정 페이지에서 먼저 로그인해주세요.');
        }
    </script>
</body>
</html>