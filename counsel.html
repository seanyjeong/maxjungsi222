<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>정시 개인별 상담 (자동 저장)</title> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb; --primary-dark:#1d4ed8;
            --light-bg: #f8fafc; --card-bg: #ffffff;
            --border-color: #e2e8f0; --text-primary:#1e293b; --text-secondary:#475569;
            --danger-color: #ef4444; --success-color: #10b981; --warning-color: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --info-color: #3b82f6;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--light-bg); padding: 20px; margin: 0; line-height: 1.5; }
        .container { max-width: 95%; margin: 0 auto; }

        /* ---------- Header ---------- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            gap: 12px; flex-wrap: wrap;
            background: var(--card-bg); padding: 16px 18px; border-radius: 12px; box-shadow: var(--shadow);
            margin-bottom: 16px;
        }
        .header h1 { font-size: 1.6rem; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 10px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .chip {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--light-bg); padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border-color);
        }
        .chip label { font-size: .9rem; color: var(--text-secondary); white-space: nowrap; }
        select { padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; font-size: .95rem; min-width: 150px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 8px; font-weight: 600; font-size: .9rem; cursor: pointer; transition: .2s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; } /* 비활성화 스타일 추가 */
        .btn-outline { background: #fff; color: var(--text-secondary); border:1px solid var(--border-color); }
        .btn-outline:hover { background: #f8fafc; }
        .btn-sm { padding: 4px 8px; font-size: .8rem; }
        .btn-danger { background: var(--danger-color); color: #fff; padding: 6px 8px; border-radius: 6px; } /* 카드 헤더 X 버튼 */
        .btn-danger:hover { background: #dc2626; }


        /* ---------- Cards ---------- */
        .card { background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 18px; margin-bottom: 18px; }

        /* ---------- Student info ---------- */
        #student-info-container { padding: 12px 16px; }
        .student-basic-info { display: flex; flex-wrap: wrap; gap: 14px; margin-bottom: 8px; font-size: 1.05rem; color: var(--text-primary); }
        .student-basic-info .info-item i { color: var(--text-secondary); margin-right: 5px; }
        .student-basic-info strong { font-weight: 600; }
        .student-scores-info { display: flex; flex-wrap: wrap; gap: 8px 12px; font-size: .9rem; color: var(--text-secondary); padding-top: 8px; border-top: 1px dashed var(--border-color); }
        .score-item { background: #f8fafc; padding: 3px 8px; border-radius: 4px; border: 1px solid var(--border-color); }
        .grade-emphasis { font-weight: 700; color: var(--primary-color); font-size: 1.05em; margin: 0 2px; }

        /* ---------- Compact controls (군/대학/학과) ---------- */
        .card.controls { padding: 12px; }
        .compact-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .compact-controls .row { display: flex; align-items: center; gap: 6px; }
        .compact-controls .row .label { color: var(--text-secondary); font-size: .9rem; white-space: nowrap; }
        .compact-controls select { min-width: 140px; }
        #add-wishlist-btn { flex-shrink: 0; /* 버튼 크기 유지 */}


        /* ---------- Results area ---------- */
        .results-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .gun-section { background: rgba(0,0,0,0.02); border: 1px dashed var(--border-color); border-radius: 8px; padding: 12px; }
        .gun-section h2 { margin: 0 0 12px; font-size: 1.15rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .gun-section h2 .gun-count { font-size: .9rem; color: var(--text-secondary); background: #e2e8f0; padding: 3px 8px; border-radius: 10px; }

        .result-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; box-shadow: var(--shadow); overflow: hidden; }
        .result-card-header {
            background: #f8fafc; padding: 8px 12px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        .result-card-header .left { display: inline-flex; align-items: center; gap: 8px; min-width: 0; }
        .result-card-header .right { display: inline-flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .result-card-header h3 { margin: 0; font-size: 1rem; font-weight: 700; color: var(--primary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .result-card-header h3 span { display: block; font-size: .85rem; color: var(--text-secondary); font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        /* .remove-card-btn 은 .btn-danger 스타일 사용 */

        .result-card-body { padding: 12px; }
        .score-breakdown { margin-bottom: 12px; }
        .score-breakdown table { width: 100%; font-size: .9rem; border-collapse: collapse; }
        .score-breakdown th { text-align: left; padding: 4px 0; color: var(--text-secondary); width: 95px; white-space: nowrap; }
        .score-breakdown td { text-align: right; padding: 4px 0; }
        .score-breakdown .total-score td { font-weight: 700; font-size: 1.05rem; color: var(--primary-color); }
        .score-breakdown .naeshin-score-row { display: none; } /* 내신 있을때만 보이게 JS 제어 */

        .input-section { margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color); }
        .input-section table { width: 100%; font-size: .9rem; border-collapse: collapse; }
        .input-section th { text-align: left; padding: 5px 0; color: var(--text-secondary); width: 95px; white-space: nowrap; }
        .input-section td { text-align: right; padding: 5px 0; display: flex; justify-content: flex-end; gap: 8px; align-items: center; }
        .input-section input[type="text"], .input-section input[type="number"] { width: 100px; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: .9em; text-align: right; box-sizing: border-box; }
        .practical-score-display { font-size: .85em; color: var(--text-secondary); min-width: 60px; text-align: right; }
        .practical-score-display span { color: var(--danger-color); font-weight: 500; } /* 감수 */
        .score-silgi { color: var(--success-color); font-weight: 500; } /* 실기 점수 */
        .score-silgi span { color: var(--danger-color); font-weight: 500; margin-left: 4px; } /* 총 감수 */

        .top-10-score-display { font-size: .85rem; color: var(--info-color); font-weight: 600; white-space: nowrap; }
        .top-10-score-display .loading { font-style: italic; color: var(--text-secondary); font-weight: 400; }

        .card-actions { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }

        /* 배점표 모달 내부 스타일 */
        .score-table-container {
            margin-top: 15px; border: 1px solid var(--border-color); border-radius: 8px;
            overflow: auto; max-height: 50vh;
        }
        .score-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap; table-layout: fixed; }
        .score-table th, .score-table td { border: 1px solid var(--border-color); padding: 6px 8px; text-align: center; vertical-align: middle; }
        .score-table thead th { background-color: #f1f5f9; font-weight: 600; position: sticky; top: 0; z-index: 1; }
        .score-table thead tr:first-child th { border-top: none; }
        .score-table td:first-child { font-weight: 600; background-color: #f8fafc; }

        /* ---------- Modal ---------- */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content.large { max-width: 800px; } /* 배점표용 넓은 모달 */
        .modal-close { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: black; text-decoration: none; }
        .modal h2 { margin-top: 0; font-size: 1.3rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px;}
        .modal ul { list-style: none; padding: 0; margin: 10px 0 0; }
        .modal li { padding: 5px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .modal li:last-child { border-bottom: none; }
        .modal li strong { font-weight: 600; }
        .modal li .count { font-size: 0.8em; color: var(--text-secondary); margin-left: 5px; }
        #cross-gun-modal-body h4 { margin: 15px 0 5px; color: var(--primary-dark); font-size: 1rem; }
        #cross-gun-modal-body p { font-size: 0.9em; color: #555; margin-bottom: 10px;}
        #cross-gun-modal-body ul { margin-bottom: 15px; }

        /* --- ⭐️ Toast Popup (자동 저장 피드백) --- */
        .toast-popup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); color: white; padding: 10px 18px; border-radius: 20px;
            font-size: 0.9rem; z-index: 1002; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            pointer-events: none; /* 클릭 방지 */
        }
        .toast-popup.show { opacity: 1; bottom: 40px; }
        .toast-popup.success { background-color: var(--success-color); }
        .toast-popup.error { background-color: var(--danger-color); }
        /* --- ⭐️ Toast Popup 끝 --- */

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-user-check"></i> 정시 개인별 상담</h1>
        <div class="header-controls">
            <div class="chip"> <label for="student-select"><i class="fas fa-user-graduate"></i> 상담 학생</label> <select id="student-select"><option value="">- 학생 선택 -</option></select> </div>
            <div class="chip"> <label for="year-select"><i class="fas fa-calendar-alt"></i> 대상 학년도</label> <select id="year-select"> <option value="2026">2026</option> <option value="2027">2027</option> </select> </div>
            </div>
    </div>

    <div id="student-info-container" class="card" style="display:none; margin-bottom: 14px;">
         <div class="student-basic-info"> <span class="info-item"><i class="fas fa-user-circle"></i> <strong id="selected-student-name">학생 이름</strong></span> <span class="info-item"><i class="fas fa-school"></i> <span id="selected-school-name">학교 정보</span></span> <span class="info-item"><i class="fas fa-venus-mars"></i> <span id="selected-gender">성별</span></span> </div>
         <div class="student-scores-info"> <span class="score-item" id="score-hist">한국사: -</span> <span class="score-item" id="score-kor">국어(?): -</span> <span class="score-item" id="score-math">수학(?): -</span> <span class="score-item" id="score-eng">영어: -</span> <span class="score-item" id="score-inq1">탐구1(?): -</span> <span class="score-item" id="score-inq2">탐구2(?): -</span> </div>
    </div>

    <div class="card controls">
        <div class="compact-controls">
            <div class="row"> <span class="label">군</span> <select id="gun-select" disabled> <option value="">- 학생 먼저 선택 -</option> </select> </div>
            <div class="row"> <span class="label">대학교</span> <select id="university-select" disabled> <option value="">- 군 선택 -</option> </select> </div>
            <div class="row"> <span class="label">학과</span> <select id="department-select" disabled> <option value="">- 대학 선택 -</option> </select> </div>
            <button type="button" id="add-wishlist-btn" class="btn btn-primary" disabled> <i class="fas fa-plus"></i> 상담 목록에 추가 </button>
        </div>
        </div>

    <div class="results-area">
        <div class="gun-section" id="ga-gun"> <h2><span class="gun-name">가군</span><span class="gun-count">0 / 3</span></h2> <div class="result-cards-container"></div> </div>
        <div class="gun-section" id="na-gun"> <h2><span class="gun-name">나군</span><span class="gun-count">0 / 3</span></h2> <div class="result-cards-container"></div> </div>
        <div class="gun-section" id="da-gun"> <h2><span class="gun-name">다군</span><span class="gun-count">0 / 3</span></h2> <div class="result-cards-container"></div> </div>
    </div>
</div>

<div id="cross-gun-modal" class="modal">
  <div class="modal-content"> <span class="modal-close" onclick="closeModal('cross-gun-modal')">&times;</span> <h2 id="cross-gun-modal-title">타군 인기 지원 현황</h2> <div id="cross-gun-modal-body"></div> </div>
</div>
<div id="score-table-modal" class="modal">
  <div class="modal-content large"> <span class="modal-close" onclick="closeModal('score-table-modal')">&times;</span> <h2 id="score-table-modal-title">배점표</h2> <div id="score-table-modal-body"></div> </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 서버 및 인증 ---
    const SVR_JUNGSI = 'https://supermax.kr';
    const LOGIN_PAGE = 'jungsilogin.html';
    const yearSelect = document.getElementById('year-select');
    const studentSelect = document.getElementById('student-select');

    // --- 컨트롤 요소 ---
    const gunSelect = document.getElementById('gun-select');
    const universitySelect = document.getElementById('university-select');
    const departmentSelect = document.getElementById('department-select');
    const addWishlistBtn = document.getElementById('add-wishlist-btn');
    // const messageArea = document.getElementById('message-area'); // 삭제됨
    // const saveCounselingBtn = document.getElementById('save-counseling-btn'); // 삭제됨

    // --- 결과/학생정보 ---
    const resultsArea = document.querySelector('.results-area');
    const studentInfoContainer = document.getElementById('student-info-container');

    // --- 모달 요소 ---
    const crossGunModal = document.getElementById('cross-gun-modal');
    const crossGunModalTitle = document.getElementById('cross-gun-modal-title');
    const crossGunModalBody = document.getElementById('cross-gun-modal-body');
    const scoreTableModal = document.getElementById('score-table-modal');
    const scoreTableModalTitle = document.getElementById('score-table-modal-title');
    const scoreTableModalBody = document.getElementById('score-table-modal-body');

    let allUniversities = [];
    let allStudents = [];
    let selectedStudentData = null;
    let universityFormulas = {}; // 요강 캐시
    let studentWishlist = []; // 현재 학생 상담 목록 (DB 로드 결과)

    const WOMENS_UNIVERSITIES = ['이화여자대학교', '숙명여자대학교', '성신여자대학교', '덕성여자대학교', '동덕여자대학교','서울여자대학교'];

    // --- 인증 ---
    const handleAuthError = () => { console.error("Authentication error!"); alert('인증 만료. 다시 로그인하세요.'); window.top.location.href = LOGIN_PAGE; };
    const getToken = () => localStorage.getItem('jwt_token');
    const token = getToken();
    if (!token) { handleAuthError(); return; }

    // --- Helper ---
    const safeParse = (jsonStringOrObject, fallback = null) => { if (typeof jsonStringOrObject === 'object' && jsonStringOrObject !== null) return jsonStringOrObject; if (typeof jsonStringOrObject !== 'string' || !jsonStringOrObject) return fallback; try { return JSON.parse(jsonStringOrObject); } catch { return fallback; } };
    // ⭐️ Toast Popup 함수 추가
    const showToast = (message, isSuccess = true) => { const el = document.createElement('div'); el.textContent = message; el.className = `toast-popup ${isSuccess ? 'success' : 'error'}`; document.body.appendChild(el); setTimeout(() => el.classList.add('show'), 10); setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 2500); };
    // ⭐️ Debounce 함수 추가 (자동 저장 호출 제어용)
    const debounce = (func, delay) => { let timeoutId; return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => { func.apply(this, args); }, delay); }; };

    // --- 초기 데이터 로드 함수 (변경 없음) ---
    const loadStudents = async () => { /* 이전과 동일 */ console.log("loadStudents 시작"); const year = yearSelect.value; studentSelect.innerHTML = '<option value="">- 로딩 중... -</option>'; try { const currentToken = getToken(); if (!currentToken) throw new Error('로그인 만료'); const res = await fetch(`${SVR_JUNGSI}/jungsi/students/list-by-branch?year=${year}`, { headers: { 'Authorization': `Bearer ${currentToken}` } }); console.log("loadStudents fetch status:", res.status); if (res.status === 401 || res.status === 403) { handleAuthError(); return; } const data = await res.json(); console.log("loadStudents data:", data); if (data.success && data.students) { allStudents = data.students; allStudents.sort((a,b)=>a.student_name.localeCompare(b.student_name,'ko')); studentSelect.innerHTML = '<option value="">- 학생 선택 -</option>'; allStudents.forEach(s => { studentSelect.innerHTML += `<option value="${s.student_id}">${s.student_name} (${s.school_name || '학교정보없음'})</option>`; }); } else { allStudents = []; studentSelect.innerHTML = '<option value="">- 학생 없음 -</option>'; console.warn("학생 목록 로딩 실패:", data.message); } } catch (e) { console.error('학생 목록 로딩 실패', e); studentSelect.innerHTML = '<option value="">- 로딩 오류 -</option>'; if (e.message === '로그인 만료') handleAuthError(); } finally { console.log("loadStudents 종료"); } };
    const loadUniversities = async () => { /* 이전과 동일 */ console.log("loadUniversities 시작"); const year = yearSelect.value; universityFormulas = {}; gunSelect.innerHTML = '<option value="">- 군 로딩중 -</option>'; gunSelect.disabled = true; universitySelect.innerHTML = '<option value="">-</option>'; universitySelect.disabled = true; departmentSelect.innerHTML = '<option value="">-</option>'; departmentSelect.disabled = true; try { const currentToken = getToken(); if (!currentToken) throw new Error('로그인 만료'); const res = await fetch(`${SVR_JUNGSI}/jungsi/university-list?year=${year}`, { headers: { 'Authorization': `Bearer ${currentToken}` } }); console.log("loadUniversities fetch status:", res.status); if (res.status === 401 || res.status === 403) { handleAuthError(); return; } const data = await res.json(); console.log("loadUniversities data:", data); if (data.success && data.list) { allUniversities = data.list; const guns = [...new Set(data.list.map(i=>i.gun).filter(Boolean))]; guns.sort((a,b)=>['가','나','다'].indexOf(a)-['가','나','다'].indexOf(b)); gunSelect.innerHTML = '<option value="">- 군 선택 -</option>'; guns.forEach(g => gunSelect.innerHTML += `<option value="${g}">${g}</option>`); gunSelect.disabled = !selectedStudentData; } else { allUniversities = []; gunSelect.innerHTML = '<option value="">- 목록 없음 -</option>'; console.warn("대학 목록 로딩 실패:", data.message); } } catch (e) { console.error('대학 목록 로딩 오류', e); allUniversities = []; gunSelect.innerHTML = '<option value="">- 로딩 오류 -</option>'; if (e.message === '로그인 만료') handleAuthError(); } finally { console.log("loadUniversities 종료"); } };
    const fetchFormulaDetails = async (U_ID, year) => { /* 이전과 동일 */ console.log(`fetchFormulaDetails 시작: U_ID=${U_ID}, year=${year}`); const k = `${U_ID}-${year}`; if (universityFormulas[k]) { console.log("fetchFormulaDetails 캐시 반환"); return universityFormulas[k]; } if (!U_ID) return null; try { const currentToken = getToken(); if (!currentToken) throw new Error('로그인 만료'); const res = await fetch(`${SVR_JUNGSI}/jungsi/formula-details?U_ID=${U_ID}&year=${year}`, { headers: { 'Authorization': `Bearer ${currentToken}` } }); console.log(`fetchFormulaDetails fetch status (${U_ID}):`, res.status); if (res.status === 401 || res.status === 403) throw new Error('인증 오류'); const data = await res.json(); console.log(`fetchFormulaDetails data (${U_ID}):`, data); if (!data.success) throw new Error(data.message || '요강 로딩 실패'); universityFormulas[k] = data.formula; return data.formula; } catch (e) { console.error(`fetchFormulaDetails 실패 (U_ID: ${U_ID}):`, e); if (e.message.includes('인증')) handleAuthError(); return null; } finally { console.log(`fetchFormulaDetails 종료: U_ID=${U_ID}`); } };
    const calculateSuneung = async (student, U_ID, year) => { /* 이전과 동일 */ console.log(`calculateSuneung 시작: student=${student?.student_id}, U_ID=${U_ID}, year=${year}`); if (!student || !student.scores) { console.warn("calculateSuneung: 학생 또는 성적 정보 없음"); return 0; } try { const studentScoresInput = convertScoresToSuneungFormat(student.scores); const currentToken = getToken(); if (!currentToken) throw new Error('로그인 만료'); const res = await fetch(`${SVR_JUNGSI}/jungsi/calculate`, { method: 'POST', headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${currentToken}` }, body: JSON.stringify({ U_ID, year, studentScores: studentScoresInput }) }); console.log(`calculateSuneung fetch status (${U_ID}):`, res.status); if (res.status === 401 || res.status === 403) throw new Error('인증 오류'); if (!res.ok) throw new Error(`HTTP ${res.status}`); const data = await res.json(); console.log(`calculateSuneung data (${U_ID}):`, data); if (!data.success) throw new Error(data.message||'수능 계산 실패'); const score = Number(data.result?.totalScore || 0); console.log(`calculateSuneung 결과 (${U_ID}):`, score); return score; } catch (e) { console.error(`calculateSuneung 에러 (${U_ID}):`, e); if (e.message.includes('인증')) handleAuthError(); return 0; } finally { console.log(`calculateSuneung 종료: U_ID=${U_ID}`); } };
    const convertScoresToSuneungFormat = (scores) => { /* 이전과 동일 */ if (!scores) return { subjects: [] }; const subjects = []; if (scores.국어_표준점수!=null || scores.국어_백분위!=null) subjects.push({ name:'국어', subject:scores.국어_선택과목, std:scores.국어_표준점수, percentile:scores.국어_백분위, grade:scores.국어_등급 }); if (scores.수학_표준점수!=null || scores.수학_백분위!=null) subjects.push({ name:'수학', subject:scores.수학_선택과목, std:scores.수학_표준점수, percentile:scores.수학_백분위, grade:scores.수학_등급 }); if (scores.영어_등급!=null) subjects.push({ name:'영어', grade:scores.영어_등급 }); if (scores.한국사_등급!=null) subjects.push({ name:'한국사', grade:scores.한국사_등급 }); if (scores.탐구1_선택과목!=null) subjects.push({ name:'탐구', subject:scores.탐구1_선택과목, std:scores.탐구1_표준점수, percentile:scores.탐구1_백분위, grade:scores.탐구1_등급 }); if (scores.탐구2_선택과목!=null) subjects.push({ name:'탐구', subject:scores.탐구2_선택과목, std:scores.탐구2_표준점수, percentile:scores.탐구2_백분위, grade:scores.탐구2_등급 }); return { subjects }; };
    function updateStudentInfoCard(studentData) { /* 이전과 동일 */ const container = studentInfoContainer; if (!studentData || !container) { if (container) container.style.display='none'; return; } container.querySelector('#selected-student-name').textContent = studentData.student_name || '-'; container.querySelector('#selected-school-name').textContent = studentData.school_name || '정보없음'; container.querySelector('#selected-gender').textContent = studentData.gender || '-'; const sc = studentData.scores || {}; const formatScore = (subject,std,pct,grade)=>{ const parts=[]; if(std!=null) parts.push(`표 ${std}`); if(pct!=null) parts.push(`백 ${pct}`); if(grade!=null) parts.push(`<strong class="grade-emphasis">${grade}</strong>등급`); return parts.length?parts.join(' / '):'-'; }; const formatGradeOnly = (g)=> (g!=null)?`<strong class="grade-emphasis">${g}</strong>등급`:'-'; const el = (id)=>container.querySelector('#'+id); el('score-kor').innerHTML = `국어(${sc.국어_선택과목 || '?' }): ${formatScore(sc.국어_선택과목,sc.국어_표준점수,sc.국어_백분위,sc.국어_등급)}`; el('score-math').innerHTML= `수학(${sc.수학_선택과목 || '?' }): ${formatScore(sc.수학_선택과목,sc.수학_표준점수,sc.수학_백분위,sc.수학_등급)}`; el('score-eng').innerHTML = `영어: ${formatGradeOnly(sc.영어_등급)}`; el('score-hist').innerHTML= `한국사: ${formatGradeOnly(sc.한국사_등급)}`; el('score-inq1').innerHTML= `탐구1(${sc.탐구1_선택과목 || '?' }): ${formatScore(sc.탐구1_선택과목,sc.탐구1_표준점수,sc.탐구1_백분위,sc.탐구1_등급)}`; el('score-inq2').innerHTML= `탐구2(${sc.탐구2_선택과목 || '?' }): ${formatScore(sc.탐구2_선택과목,sc.탐구2_표준점수,sc.탐구2_백분위,sc.탐구2_등급)}`; container.style.display='block'; }

    // --- ⭐️ 자동 저장 함수 ---
    let isSaving = false; // 저장 중복 방지 플래그
    const saveCurrentWishlist = debounce(async () => {
        if (!selectedStudentData || isSaving) return; // 학생 없거나 저장 중이면 중단
        isSaving = true;
        console.log("Auto-saving triggered...");

        const studentId = selectedStudentData.student_id;
        const year = yearSelect.value;
        const wishlistItems = [];

        // DOM에서 현재 모든 카드 데이터 수집
        document.querySelectorAll('.results-area .result-card').forEach(card=>{
            const formula = JSON.parse(card.dataset.formula);
            const gunSection = card.closest('.gun-section'); if (!formula||!gunSection) return;
            const 모집군 = gunSection.id==='ga-gun'?'가':(gunSection.id==='na-gun'?'나':'다');
            const 대학학과_ID = formula.U_ID;
            let 상담_내신점수 = null;
            const na = card.querySelector('.naeshin-input');
            if (na && na.value.trim()!=='') 상담_내신점수 = Number(na.value);
            const 상담_실기기록 = {};
            card.querySelectorAll('.practical-input').forEach(input=>{
                if (input.value.trim()!=='') 상담_실기기록[input.dataset.event] = input.value.trim();
            });
            const hasSilgiJSON = Object.keys(상담_실기기록).length ? 상담_실기기록 : null;
            const numFromText = (t)=>{ const m=String(t||'').match(/-?\d+(\.\d+)?/); return m?Number(m[0]):0; };
            const 상담_수능점수 = numFromText(card.querySelector('.score-suneung')?.textContent);
            const 상담_실기반영점수 = numFromText(card.querySelector('.score-silgi')?.textContent);
            const 상담_계산총점 = numFromText(card.querySelector('.score-total')?.textContent);

            wishlistItems.push({ 모집군, 대학학과_ID, 상담_수능점수, 상담_내신점수, 상담_실기기록: hasSilgiJSON, 상담_실기반영점수, 상담_계산총점 });
        });

        console.log("Saving data:", wishlistItems);
        try {
            const currentToken = getToken(); if (!currentToken) throw new Error('로그인 만료');
            const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/wishlist/bulk-save`, { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${currentToken}` }, body: JSON.stringify({ 학생_ID: studentId, 학년도: year, wishlistItems }) });
            console.log("Auto-save API response status:", res.status);
            if (res.status===401||res.status===403) { handleAuthError(); return; }
            const data = await res.json();
            console.log("Auto-save API response data:", data);
            if (data.success) {
                 showToast('✅ 자동 저장됨', true);
             } else {
                 showToast(`❌ 자동 저장 실패: ${data.message || '알 수 없는 오류'}`, false);
             }
        } catch (e) {
            console.error('자동 저장 오류', e);
            showToast(`❌ 자동 저장 중 오류 발생: ${e.message}`, false);
            if (e.message==='로그인 만료') handleAuthError();
        } finally {
            isSaving = false; // 플래그 해제
            console.log("Auto-save process finished");
        }
    }, 1500); // 1.5초 디바운스

    // --- 이벤트 핸들러 ---
    studentSelect.addEventListener('change', async (e)=>{ const id = e.target.value; console.log(`Student selection changed: ${id}`); if (id) { selectedStudentData = allStudents.find(s=>s.student_id==id); updateStudentInfoCard(selectedStudentData); await loadUniversities(); await loadWishlist(); /* saveCounselingBtn.disabled = false; */ gunSelect.disabled = false; } else { selectedStudentData = null; gunSelect.value=''; gunSelect.disabled = true; universitySelect.innerHTML = '<option value="">- 군 선택 -</option>'; universitySelect.disabled = true; departmentSelect.innerHTML = '<option value="">- 대학 선택 -</option>'; departmentSelect.disabled = true; addWishlistBtn.disabled = true; resetResultArea(); updateStudentInfoCard(null); /* saveCounselingBtn.disabled = true; */ } });
    yearSelect.addEventListener('change', ()=>{ console.log("Year changed"); loadStudents(); loadUniversities(); selectedStudentData=null; studentSelect.value=''; resetResultArea(); updateStudentInfoCard(null); /* saveCounselingBtn.disabled = true; */ });
    gunSelect.addEventListener('change', ()=>{ const g = gunSelect.value; console.log(`Gun changed: ${g}`); universitySelect.innerHTML = '<option value="">- 대학 선택 -</option>'; departmentSelect.innerHTML = '<option value="">- 학과 선택 -</option>'; departmentSelect.disabled = true; addWishlistBtn.disabled = true; if (g) { const universities = [...new Set(allUniversities.filter(i=>i.gun===g).map(i=>i.university))]; universities.sort((a,b)=>a.localeCompare(b,'ko')); universities.forEach(u=>universitySelect.innerHTML += `<option value="${u}">${u}</option>`); universitySelect.disabled = false; } else universitySelect.disabled = true; });
    universitySelect.addEventListener('change', ()=>{ const g = gunSelect.value, uni = universitySelect.value; console.log(`University changed: ${uni}`); departmentSelect.innerHTML = '<option value="">- 학과 선택 -</option>'; addWishlistBtn.disabled = true; if (g && uni) { allUniversities.filter(i=>i.gun===g && i.university===uni).sort((a,b)=>a.department.localeCompare(b.department,'ko')).forEach(i=>departmentSelect.innerHTML += `<option value="${i.U_ID}">${i.department}</option>`); departmentSelect.disabled = false; } else departmentSelect.disabled = true; });
    departmentSelect.addEventListener('change', ()=>{ console.log(`Department changed: ${departmentSelect.value}`); addWishlistBtn.disabled = !departmentSelect.value; });
    const getGunSectionId = (gunName)=>{ if (gunName==='가군' || gunName==='가') return 'ga-gun'; if (gunName==='나군' || gunName==='나') return 'na-gun'; if (gunName==='다군' || gunName==='다') return 'da-gun'; return ''; };
    // 결과 카드 생성 (⭐️ 실기 종목 필터링 로직 수정됨)
    const createResultCard = (container, formula, suneungScore, savedData=null) => {
        console.log(`createResultCard 호출: U_ID=${formula.U_ID}, suneungScore=${suneungScore}`);
        const card = document.createElement('div');
        card.className = 'result-card';
        card.dataset.uid = formula.U_ID;
        card.dataset.formula = JSON.stringify(formula); // 포뮬러 데이터 저장

        const reflectsNaeshin = Number(formula.내신||0) > 0;
        const reflectsSilgi = Number(formula.실기||0) > 0;

        // --- ⭐️ 실기 입력칸 HTML 생성 로직 수정 ---
        let silgiInputsHtml = '';
        let practicalEventsForStudent = []; // 학생 성별에 맞는 종목만 담을 배열

        // 학생 정보와 실기 배점표가 모두 있을 때만 필터링 시도
        if (reflectsSilgi && selectedStudentData && selectedStudentData.gender && formula.실기배점 && formula.실기배점.length > 0) {
            const studentGender = selectedStudentData.gender; // '남' 또는 '여'

            // 1. formula.실기배점 배열에서 현재 학생 성별 데이터만 필터링
            const genderFilteredScores = formula.실기배점.filter(scoreRow => scoreRow.성별 === studentGender);

            // 2. 필터링된 데이터에서 고유한 종목명 추출 및 정렬
            practicalEventsForStudent = [...new Set(genderFilteredScores.map(r => r.종목명))].sort();

            console.log(` -> U_ID=${formula.U_ID}, 학생 성별(${studentGender}) 기준 실기 종목 (${practicalEventsForStudent.length}개):`, practicalEventsForStudent);

            // 3. 학생 성별에 맞는 종목이 있을 경우에만 입력칸 HTML 생성
            if (practicalEventsForStudent.length > 0) {
                practicalEventsForStudent.forEach(event => {
                    silgiInputsHtml += `
                        <tr class="practical-row">
                            <th>${event}:</th>
                            <td>
                                <input type="text" class="practical-input" data-event="${event}" placeholder="기록 입력">
                                <span class="practical-score-display" data-event-score-display="${event}">-</span>
                            </td>
                        </tr>
                    `;
                });
            } else {
                 console.log(` -> U_ID=${formula.U_ID}: 학생 성별(${studentGender})에 맞는 실기 배점표 없음.`);
                 // 실기 반영은 하지만, 해당 성별 종목이 없을 경우 메시지 표시 (선택 사항)
                 silgiInputsHtml = `<tr><td colspan="2" style="font-size:0.85em; color:var(--text-secondary); text-align:center;">${studentGender}학생 대상 실기 종목 없음</td></tr>`;
            }
        }
        // --- ⭐️ 실기 입력칸 HTML 생성 로직 수정 끝 ---

        // --- 카드 기본 HTML 구조 (나머지는 이전과 동일) ---
        let naeshinInputHtml = '';
        if (reflectsNaeshin) {
            naeshinInputHtml = `<tr class="naeshin-row"><th>내신 점수:</th><td><input type="number" class="naeshin-input" placeholder="진학사 점수"></td></tr>`;
        }
        const naeshinScoreRowClass = reflectsNaeshin ? 'naeshin-score-row' : 'naeshin-score-row hidden-row'; // 클래스명은 유지

        card.innerHTML = `
            <div class="result-card-header">
                <div class="left">
                    <button type="button" class="btn btn-danger btn-sm remove-card-btn" title="삭제"><i class="fas fa-times"></i></button>
                    <h3>${formula.대학명}<span>${formula.학과명}</span></h3>
                </div>
                <div class="right">
                    <div class="top-10-score-display" data-uid-top10="${formula.U_ID}"><span class="loading">Top10% 로딩...</span></div>
                </div>
            </div>
            <div class="result-card-body">
                <div class="score-breakdown">
                    <table>
                        <tr><th>수능 점수:</th><td class="score-suneung">${suneungScore.toFixed(2)}</td></tr>
                        <tr class="${naeshinScoreRowClass}"><th>내신 점수:</th><td class="score-naeshin">0.00</td></tr>
                        <tr><th>실기 점수:</th><td class="score-silgi">0.00 <span>(0감)</span></td></tr>
                        <tr class="total-score"><th>총점:</th><td class="score-total">${suneungScore.toFixed(2)}</td></tr>
                    </table>
                </div>
                <div class="input-section">
                    <table>
                        ${naeshinInputHtml}
                        ${silgiInputsHtml}
                    </table>
                </div>
                <div class="card-actions"></div>
            </div>`;

        // --- 카드 액션 버튼 추가 (이전과 동일) ---
        const actions = card.querySelector('.card-actions');
        // ⭐️ 실기 배점표 버튼 조건 수정: 학생 성별에 맞는 종목이 '있을 때만' 버튼 표시
        if (reflectsSilgi && practicalEventsForStudent.length > 0) {
            const b = document.createElement('button');
            b.className='btn btn-sm btn-outline';
            b.innerHTML='<i class="fas fa-table"></i> 실기 배점표';
            b.onclick=()=>showScoreTableModal('silgi',formula.U_ID,formula.학년도);
            actions.appendChild(b);
        }
        // 내신 배점표 버튼 (기존과 동일)
        if (reflectsNaeshin && formula.내신배점?.length) {
            const b = document.createElement('button');
            b.className='btn btn-sm btn-outline';
            b.innerHTML='<i class="fas fa-table"></i> 내신 배점표';
            b.onclick=()=>showScoreTableModal('naeshin',formula.U_ID,formula.학년도);
            actions.appendChild(b);
        }
        // 타군 인기 지원 버튼 (기존과 동일)
        const bOther = document.createElement('button');
        bOther.className='btn btn-sm btn-outline';
        bOther.innerHTML='<i class="fas fa-users"></i> 타군 인기 지원';
        bOther.onclick=()=>showCrossGunModal(formula.U_ID, formula.학년도, formula.대학명, formula.학과명, formula.군);
        actions.appendChild(bOther);

        // --- 내신 행 표시 및 저장된 값 로드 (이전과 동일) ---
        if (reflectsNaeshin) {
            const row = card.querySelector('.naeshin-score-row');
            if (row) row.style.display='table-row';
        }
        if (savedData) { // 저장된 데이터(DB 로드 결과)가 있으면 값 채우기
            const naeshinInput = card.querySelector('.naeshin-input');
            if (naeshinInput && savedData.상담_내신점수!=null) {
                naeshinInput.value = savedData.상담_내신점수;
            }
            const savedRecords = safeParse(savedData.상담_실기기록,{});
            if (savedRecords && typeof savedRecords ==='object') {
                card.querySelectorAll('.practical-input').forEach(input => {
                    const eventName = input.dataset.event;
                    // 저장된 기록 객체에 해당 종목 키가 있고 값이 null이 아니면 채움
                    if (Object.prototype.hasOwnProperty.call(savedRecords, eventName) && savedRecords[eventName] != null) {
                        input.value = savedRecords[eventName];
                    }
                });
            }
            recalculateScoresInCard(card); // 저장된 값 로드 후 점수 재계산
        }

        // --- 이벤트 리스너 추가 (⭐️ 자동 저장 호출 포함) ---
        card.querySelectorAll('.naeshin-input, .practical-input').forEach(input => {
            // 'change' 이벤트 (값이 변경되고 포커스를 잃었을 때) 발생 시 재계산 및 자동 저장
            input.addEventListener('change', () => recalculateScoresInCard(card));
        });
        card.querySelector('.remove-card-btn').addEventListener('click', () => {
            const gunSection = card.closest('.gun-section');
            card.remove(); // 카드 DOM에서 제거
            if (gunSection) {
                updateGunCount(gunSection.id); // 군별 카운트 업데이트
                saveCurrentWishlist(); // 삭제 후 자동 저장
            }
        });

        container.appendChild(card); // 최종적으로 컨테이너에 카드 추가
        console.log(`createResultCard 종료: 카드 추가됨 (U_ID=${formula.U_ID})`);
        return card; // 생성된 카드 요소 반환
    };
    const recalculateScoresInCard = async (card) => { /* ... 이전 내신 점수 계산 로직 수정된 버전 ... */ if (!card) return; const formula = JSON.parse(card.dataset.formula); const student = selectedStudentData; if (!formula || !student) return; let naeshinScore = 0; const naeshinInput = card.querySelector('.naeshin-input'); if (naeshinInput) { const raw = Number(naeshinInput.value || 0); const ratio = (Number(formula.내신) || 0) / 100; const TOTAL = Number(formula.총점) > 0 ? Number(formula.총점) : 1000; const max = Number(formula.내신만점) || 0; if (ratio > 0 && max > 0 && raw > 0) { naeshinScore = (raw / max) * ratio * TOTAL; } else if (ratio > 0 && raw > 0 && max === 0) { naeshinScore = raw; } } card.querySelector('.score-naeshin').textContent = naeshinScore.toFixed(2); let silgiScore = 0; let totalDeductionText = '<span>(0감)</span>'; const inputs = card.querySelectorAll('.practical-input'); if (inputs.length > 0) { const practicals = []; inputs.forEach(input => { if (input.value.trim() !== '') practicals.push({ event: input.dataset.event, value: input.value }); }); if (practicals.length > 0) { const S_data = { gender: student.gender, practicals }; const F_data = formula; try { const currentToken = getToken(); if (!currentToken) throw new Error('로그인 만료'); const res = await fetch(`${SVR_JUNGSI}/silgi/calculate`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` }, body: JSON.stringify({ F_data, S_data }) }); if (res.status === 401 || res.status === 403) throw new Error('인증 오류'); const data = await res.json(); if (data.success && data.result) { silgiScore = Number(data.result.totalScore || 0); const breakdown = data.result.breakdown; if (breakdown?.events) { breakdown.events.forEach(ev => { const span = card.querySelector(`.practical-score-display[data-event-score-display="${ev.event}"]`); if (span) span.innerHTML = ev.score == null ? '-' : `${ev.score.toFixed(2)}점 <span>(${ev.deduction_level}감)</span>`; }); } const d = breakdown?.total_deduction_level || 0; totalDeductionText = d > 0 ? `<span>(${d}감)</span>` : '<span>(0감)</span>'; card.querySelector('.score-silgi').innerHTML = `${silgiScore.toFixed(2)} ${totalDeductionText}`; } else { card.querySelector('.score-silgi').textContent = '계산오류'; card.querySelectorAll('.practical-score-display').forEach(s => s.innerHTML = '-'); totalDeductionText = '<span>(오류)</span>'; card.querySelector('.score-silgi').innerHTML = `오류 ${totalDeductionText}`; } } catch (e) { console.error('실기 재계산 오류', e); card.querySelector('.score-silgi').textContent = '통신오류'; card.querySelectorAll('.practical-score-display').forEach(s => s.innerHTML = '-'); totalDeductionText = '<span>(오류)</span>'; card.querySelector('.score-silgi').innerHTML = `오류 ${totalDeductionText}`; if (e.message.includes('인증')) handleAuthError(); } } else { card.querySelector('.score-silgi').innerHTML = `0.00 ${totalDeductionText}`; card.querySelectorAll('.practical-score-display').forEach(s => s.innerHTML = '-'); } } else { card.querySelector('.score-silgi').innerHTML = `0.00 ${totalDeductionText}`; card.querySelectorAll('.practical-score-display').forEach(s => s.innerHTML = '-'); } const suneungScore = Number(card.querySelector('.score-suneung').textContent || 0); const totalScore = suneungScore + naeshinScore + silgiScore; card.querySelector('.score-total').textContent = totalScore.toFixed(2); saveCurrentWishlist(); /* ⭐️ 점수 재계산 후 자동 저장 호출 */ };
    const updateGunCount = (id)=>{ const c = document.getElementById(id)?.querySelector('.result-cards-container'); const s = document.getElementById(id)?.querySelector('.gun-count'); if (c && s) s.textContent = `${c.querySelectorAll('.result-card').length} / 3`; };
    const resetResultArea = ()=>{ ['ga-gun','na-gun','da-gun'].forEach(id=>{ const c = document.getElementById(id)?.querySelector('.result-cards-container'); if (c) c.innerHTML=''; updateGunCount(id); }); };
    const fetchAndDisplayTop10Score = async (cardElement, U_ID, year) => { /* ... 이전과 동일 ... */ const el = cardElement.querySelector(`.top-10-score-display[data-uid-top10="${U_ID}"]`); if (!el) return; try { const currentToken = getToken(); if (!currentToken) throw new Error('로그인 만료'); const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/stats/${U_ID}/${year}`, { headers: { 'Authorization': `Bearer ${currentToken}` } }); if (res.status===401||res.status===403) throw new Error('인증 오류'); const data = await res.json(); if (data.success && data.top10Score!=null) { el.innerHTML = `<i class="fas fa-medal"></i> 수능 상위 10%: <strong>${Number(data.top10Score).toFixed(2)}점</strong>`; } else if (data.success) { el.textContent = '수능 상위 10%: 데이터 부족'; } else { el.textContent = '수능 상위 10%: 조회 실패'; } } catch (e) { console.error('상위10% 조회 오류', e); el.textContent = '수능 상위 10%: 조회 오류'; if (e.message.includes('인증')) handleAuthError(); } };
    function createScoreTableHtml(scores, type) { /* ... 이전 실기 배점표 형식 수정된 버전 ... */ if (!scores || scores.length === 0) { return '<p style="font-size:.8rem;color:#888;padding:5px;">배점표 데이터가 없습니다.</p>'; } if (type === 'silgi') { const events = [...new Set(scores.map(r => r.종목명))].sort(); const uniqueScores = [...new Set(scores.map(r => Number(r.점수)))].sort((a, b) => b - a); const scoreMap = new Map(); scores.forEach(row => { const score = Number(row.점수); const event = row.종목명; const gender = row.성별; const record = row.기록; if (!scoreMap.has(score)) { scoreMap.set(score, new Map()); } const eventMap = scoreMap.get(score); if (!eventMap.has(event)) { eventMap.set(event, { '남': '-', '여': '-' }); } const genderRecord = eventMap.get(event); if (gender === '남' || gender === '남자') genderRecord['남'] = record; if (gender === '여' || gender === '여자') genderRecord['여'] = record; }); let html = '<div class="score-table-container"><table class="score-table"><thead>'; html += '<tr><th rowspan="2">점수</th>'; events.forEach(event => { html += `<th colspan="2">${event}</th>`; }); html += '</tr>'; html += '<tr>'; events.forEach(() => { html += `<th>남</th><th>여</th>`; }); html += '</tr></thead><tbody>'; uniqueScores.forEach(score => { html += `<tr><td>${score}</td>`; const eventMap = scoreMap.get(score) || new Map(); events.forEach(event => { const records = eventMap.get(event) || { '남': '-', '여': '-' }; html += `<td>${records['남']}</td><td>${records['여']}</td>`; }); html += '</tr>'; }); html += '</tbody></table></div>'; return html; } else if (type === 'naeshin') { let tableHtml = `<div class="score-table-container"><table class="score-table"><thead><tr>`; const headers = Object.keys(scores[0]); const desiredOrderNaeshin = ['등급', '점수', '비고']; const headersToShow = headers.filter(h => h !== 'U_ID' && h !== '학년도'); const orderedHeaders = desiredOrderNaeshin.filter(h => headersToShow.includes(h)); headersToShow.forEach(h => { if (!orderedHeaders.includes(h)) orderedHeaders.push(h); }); orderedHeaders.forEach(header => tableHtml += `<th>${header}</th>`); tableHtml += `</tr></thead><tbody>`; scores.sort((a, b) => (Number(a.등급) || 99) - (Number(b.등급) || 99)); scores.forEach(row => { tableHtml += `<tr>`; orderedHeaders.forEach(header => tableHtml += `<td>${row[header] ?? '-'}</td>`); tableHtml += `</tr>`; }); tableHtml += `</tbody></table></div>`; return tableHtml; } else { return '<p style="color:red;">알 수 없는 배점표 타입입니다.</p>'; } }
    window.showScoreTableModal = async (type, U_ID, year) => { /* 이전과 동일 */ scoreTableModalBody.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> 배점표 로딩 중...</p>'; scoreTableModal.style.display = 'block'; const detail = await fetchFormulaDetails(U_ID, year); if (!detail) { scoreTableModalBody.innerHTML = '<p style="color:red;">요강 정보를 불러오지 못했습니다.</p>'; return; } const scoreData = type === 'silgi' ? detail.실기배점 : detail.내신배점; const uniName = detail.대학명 || ''; const deptName = detail.학과명 || ''; const tableType = type === 'silgi' ? '실기' : '내신'; scoreTableModalTitle.textContent = `${uniName} ${deptName} ${tableType} 배점표 (${year})`; scoreTableModalBody.innerHTML = createScoreTableHtml(scoreData, type); };
    window.showCrossGunModal = async (U_ID, year, uniName, deptName, baseGun) => { /* 이전과 동일 */ crossGunModalBody.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> 타군 지원 정보 로딩 중...</p>'; crossGunModalTitle.textContent = `${uniName} ${deptName} (${baseGun}) 지원자 타군 인기 Top 3`; crossGunModal.style.display = 'block'; try { const currentToken = getToken(); if (!currentToken) throw new Error('로그인 만료'); const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/cross-gun-stats/${U_ID}/${year}`, { headers: { 'Authorization': `Bearer ${currentToken}` } }); if (res.status === 401 || res.status === 403) throw new Error('인증 오류'); const data = await res.json(); if (data.success) { let html = `<p>(${data.studentCount || 0}명의 지원자 기준)</p>`; const otherGuns = ['가', '나', '다'].filter(g => g !== baseGun); otherGuns.forEach(gun => { const top3 = data[`${gun}_gun_top3`] || []; html += `<h4>${gun}군 Top ${top3.length}</h4>`; if (top3.length > 0) { html += '<ul>'; top3.forEach((item, index) => { html += `<li><strong>${index + 1}. ${item.university}</strong> - ${item.department} <span class="count">(${item.count}명)</span></li>`; }); html += '</ul>'; } else { html += '<p style="font-size: 0.9em; color: #777;">해당 군 지원 내역이 없습니다.</p>'; } }); crossGunModalBody.innerHTML = html; } else { crossGunModalBody.innerHTML = `<p style="color:red;">정보 조회 실패: ${data.message || '알 수 없는 오류'}</p>`; } } catch (e) { console.error('타군 통계 조회 오류:', e); crossGunModalBody.innerHTML = `<p style="color:red;">정보 조회 중 오류 발생: ${e.message}</p>`; if (e.message.includes('인증')) handleAuthError(); } };
    window.closeModal = (modalId) => { const modalToClose = document.getElementById(modalId); if (modalToClose) modalToClose.style.display = 'none'; };
    window.onclick = function(event) { if (event.target == crossGunModal) { closeModal('cross-gun-modal'); } else if (event.target == scoreTableModal) { closeModal('score-table-modal'); } }
    const loadWishlist = async ()=>{ /* ... 이전과 동일 (showMessage 대신 showToast 사용 고려) ... */ console.log("loadWishlist 시작"); resetResultArea(); if (!selectedStudentData) { console.log("loadWishlist: 학생 미선택, 종료"); return; } const studentId = selectedStudentData.student_id; const year = yearSelect.value; showToast('상담 목록 로딩 중...', true); studentWishlist=[]; universityFormulas={}; try { const currentToken = getToken(); if (!currentToken) throw new Error('로그인 만료'); const res = await fetch(`${SVR_JUNGSI}/jungsi/counseling/wishlist/${studentId}/${year}`, { headers: { 'Authorization': `Bearer ${currentToken}` } }); console.log("loadWishlist fetch status:", res.status); if (res.status===401||res.status===403) { handleAuthError(); return; } const data = await res.json(); console.log("loadWishlist data:", data); if (data.success && data.wishlist) { studentWishlist = data.wishlist; if (studentWishlist.length===0) { showToast('저장된 상담 내역이 없습니다.', true); console.log("loadWishlist: 저장된 내역 없음"); return; } await Promise.all(studentWishlist.map(async item=>{ const gunId = getGunSectionId(item.모집군); const container = document.getElementById(gunId)?.querySelector('.result-cards-container'); if (!container) { console.warn(`Container not found for gunId: ${gunId}`); return; } try { const formula = await fetchFormulaDetails(item.대학학과_ID, year); if (!formula) { console.warn(`Formula not found for U_ID: ${item.대학학과_ID}`); return; } const suneungScore = await calculateSuneung(selectedStudentData, item.대학학과_ID, year); const cardElement = createResultCard(container, formula, suneungScore, item); updateGunCount(gunId); fetchAndDisplayTop10Score(cardElement, item.대학학과_ID, year); } catch (e) { console.error(`카드 생성/처리 중 오류 (U_ID: ${item.대학학과_ID})`, e); } })); showToast(`상담 ${studentWishlist.length}건 로드 완료.`, true); console.log("loadWishlist: 모든 카드 로드 완료"); } else { showToast('상담 목록 로드 실패.', false); console.warn("loadWishlist 실패:", data.message); } } catch (e) { console.error('상담 목록 로딩 오류', e); showToast('상담 목록 로딩 오류 발생', false); if (e.message==='로그인 만료') handleAuthError(); } finally { console.log("loadWishlist 종료"); } };

    // 상담목록에 추가 버튼 리스너 (⭐️ 성공 시 자동 저장 호출)
    addWishlistBtn.addEventListener('click', async () => {
        console.log("Add Wishlist button clicked");
        if (!selectedStudentData) { console.log("학생 미선택"); showToast('학생을 먼저 선택해주세요.', false); return; }
        const U_ID = departmentSelect.value; const year = yearSelect.value;
        console.log(`선택된 정보: U_ID=${U_ID}, year=${year}`);
        if (!U_ID) { console.log("학과 미선택"); showToast('학과를 선택해주세요.', false); return; }
        const selectedDept = allUniversities.find(u => String(u.U_ID) === String(U_ID));
        if (!selectedDept) { console.log("학과 정보 못찾음"); showToast('선택된 학과 정보를 찾을 수 없습니다.', false); return; }
        const gun = selectedDept.gun; const gunSectionId = getGunSectionId(gun);
        console.log(`학과 정보: ${selectedDept.university} ${selectedDept.department}, 군=${gun}, 섹션ID=${gunSectionId}`);
        const gunSectionElement = document.getElementById(gunSectionId);
        if (!gunSectionElement) { console.error("군 섹션 요소 없음!"); showToast('HTML 구조 오류(군 섹션 없음)', false); return; }
        const container = gunSectionElement.querySelector('.result-cards-container');
        const countSpan = gunSectionElement.querySelector('.gun-count');
        if (!container || !countSpan) { console.error("카드 컨테이너 또는 카운트 스팬 없음!"); showToast('HTML 구조 오류(내부 요소 없음)', false); return; }
        const currentCount = container.querySelectorAll('.result-card').length;
        console.log(`현재 ${gun} 카드 수: ${currentCount}`);
        if (currentCount >= 3) { console.log("카드 수 초과"); showToast(`${gun}에는 최대 3개까지 추가 가능합니다.`, false); return; }
        if (container.querySelector(`.result-card[data-uid="${U_ID}"]`)) { console.log("이미 추가됨"); showToast('이미 추가된 학과입니다.', false); return; }

        addWishlistBtn.disabled = true; addWishlistBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 추가 중...';
        // showMessage(''); // 삭제됨

        try {
            console.log("요강 로딩 시도...");
            const formula = await fetchFormulaDetails(U_ID, year);
            if(!formula){ console.error("요강 로딩 실패"); showToast('요강 정보 로딩 실패', false); throw new Error('Formula load failed'); }
            const isWomensUni = WOMENS_UNIVERSITIES.includes(formula.대학명);
            if (isWomensUni && selectedStudentData.gender === '남') { console.warn("여대 지원 불가"); showToast(`여대(${formula.대학명}) 추가 불가`, false); throw new Error('Gender mismatch'); }
            console.log("수능 점수 계산 시도...");
            const suneungScore = await calculateSuneung(selectedStudentData, U_ID, year);
            console.log(`수능 점수 계산 결과: ${suneungScore}`);
            console.log("카드 생성 시도...");
            const cardElement = createResultCard(container, formula, suneungScore);
            console.log("카드 생성 완료, 군 카운트 업데이트 시도...");
            updateGunCount(gunSectionId);
            console.log("상위 10% 점수 로딩 시도...");
            fetchAndDisplayTop10Score(cardElement, U_ID, year);
            console.log("상담 목록 추가 성공!");
            saveCurrentWishlist(); // ⭐️ 카드 추가 성공 후 자동 저장 호출
        } catch (e) {
            console.error('상담 목록 추가 중 오류:', e);
            showToast(`추가 중 오류 발생: ${e.message || '알 수 없는 오류'}`, false);
        } finally {
            console.log("추가 버튼 활성화 및 텍스트 복원");
            addWishlistBtn.disabled = false;
            addWishlistBtn.innerHTML = '<i class="fas fa-plus"></i> 상담 목록에 추가';
        }
    });

    // --- 페이지 초기 로드 ---
    console.log("Initial load starting...");
    loadStudents();
    loadUniversities();
    console.log("Initial load functions called");

});
</script>

</body>
</html>
